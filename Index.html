<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="dark light" />
<title>Medallion Prompt Builder — Ultimate+</title>

<!-- Fonts (swap to avoid FOIT on mobile) -->
<link href="https://fonts.cdnfonts.com/css/aurebesh" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet" />

<style>
  :root{
    --bg:#0b0d13; --panel:#151923; --ink:#e8ecf1; --muted:#9aa3af;
    --accent:#6ee7ff; --accent-2:#6476ff; --accent-glow:rgba(110,231,255,.35);
    --line:#252b39; --success:#4ade80; --warning:#fbbf24; --danger:#f87171;
    --mono:"JetBrains Mono","Fira Code",ui-monospace,Menlo,Consolas,monospace;
    --sans:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    --aurebesh:'Aurebesh', var(--sans); --radius:16px; --shadow:0 12px 32px rgba(0,0,0,.28);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f5f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent-2:#22d3ee; --accent-glow:rgba(37,99,235,.25); --line:#e5e7eb; --success:#16a34a; --warning:#d97706; --danger:#dc2626;}
  }
  .light-theme{
    --bg:#f5f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b;
    --accent:#2563eb; --accent-2:#22d3ee; --accent-glow:rgba(37,99,235,.25); --line:#e5e7eb; --success:#16a34a; --warning:#d97706; --danger:#dc2626;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 var(--sans);
    -webkit-text-size-adjust:100%;
    overflow-x:hidden;
  }

  header{
    position:sticky;top:0;z-index:9;padding:14px 18px;border-bottom:1px solid var(--line);
    background:color-mix(in oklab, var(--bg) 92%, black 8%);backdrop-filter:blur(6px);
    display:flex;align-items:center;justify-content:space-between
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;
    background:linear-gradient(135deg,var(--accent) 0%,var(--accent-2) 100%);box-shadow:0 0 18px var(--accent-glow)}
  .pill{padding:3px 8px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-size:11px;font-weight:700}
  .theme-toggle{border:1px solid var(--line);color:var(--muted);background:var(--panel);border-radius:10px;padding:6px 10px;display:flex;gap:6px;align-items:center;cursor:pointer}
  .theme-toggle:hover{border-color:var(--accent);color:var(--accent)}
  .kbd{font:11px var(--mono);border:1px solid var(--line);border-radius:6px;padding:2px 6px}

  /* App layout: Profiles | Builder | Output */
  .app{
    max-width:1400px;margin:22px auto;padding:0 16px;display:grid;gap:18px;
    grid-template-columns:280px 1fr 1fr;align-items:start
  }
  @media (max-width:1200px){ .app{grid-template-columns:1fr 1fr} .aside{grid-column:1/-1;order:-1} }
  @media (max-width:800px){ .app{grid-template-columns:1fr} .aside{order:-1} }

  .card{background:color-mix(in oklab, var(--panel) 98%, black 2%);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .card h2{font-size:14px;margin:0 0 10px 0;letter-spacing:.2px;display:flex;align-items:center;gap:6px;color:color-mix(in oklab,var(--ink) 85%, var(--muted) 15%)}
  .subtle{color:var(--muted);font-size:12px}

  .profiles{display:grid;gap:10px}
  .profile{
    display:grid;grid-template-columns:56px 1fr;gap:10px;align-items:center;
    border:1px solid var(--line);border-radius:12px;padding:10px;background:var(--panel);cursor:pointer;transition:.2s;
  }
  .profile:hover{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
  .thumb{width:56px;height:56px;border-radius:10px;background:radial-gradient(100% 100% at 25% 20%, var(--accent) 0%, var(--accent-2) 100%);display:grid;place-items:center;color:#fff;font-weight:800}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:color-mix(in oklab,var(--accent) 25%, transparent);color:var(--accent);font-size:10px;font-weight:700}

  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);padding-bottom:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer}
  .tab[aria-selected="true"]{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:600px){ .grid{grid-template-columns:1fr} }

  .row{display:grid;gap:6px}
  label{font-size:12px;font-weight:700;color:color-mix(in oklab, var(--ink) 85%, var(--muted) 15%)}
  input,select,textarea{
    width:100%;padding:11px 12px;border-radius:10px;border:1px solid var(--line);
    background:color-mix(in oklab,var(--bg) 92%, black 8%);color:var(--ink);outline:none
  }
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
  textarea{min-height:200px;font:12.5px/1.55 var(--mono);resize:vertical}
  .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .btn,.chip{
    padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);
    color:var(--ink);cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:.15s;font-weight:600;min-height:40px
  }
  .btn:hover,.chip:hover{border-color:var(--accent);color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none}

  .out-wrap{display:grid;gap:12px}
  .monobox{
    font:12.5px/1.55 var(--mono);white-space:pre-wrap;background:color-mix(in oklab,var(--bg) 92%, black 8%);
    border:1px dashed color-mix(in oklab,var(--line) 90%, black 10%);border-radius:12px;padding:14px;min-height:120px
  }
  .preview{display:grid;gap:12px;justify-items:center;border:1px solid var(--line);border-radius:14px;padding:14px;background:color-mix(in oklab,var(--panel) 96%, black 4%)}
  #svgPreview{
    width:320px;height:320px;border-radius:50%;background:radial-gradient(ellipse at center, rgba(0,0,0,.0) 55%, rgba(0,0,0,.35) 100%);
    box-shadow:0 0 28px rgba(110,231,255,.18);transition:transform .3s;will-change:transform;touch-action:manipulation;
  }
  .preview-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .zoom-btn{width:40px;height:40px;border-radius:50%;display:grid;place-items:center}

  .toast{position:fixed;bottom:20px;right:20px;z-index:50;transform:translateY(80px);opacity:0;background:var(--panel);
    border:1px solid var(--line);border-left:4px solid var(--success);border-radius:10px;padding:12px 14px;box-shadow:var(--shadow);
    display:flex;gap:8px;align-items:center;transition:.35s cubic-bezier(.2,.8,.2,1)}
  .toast.show{transform:translateY(0);opacity:1}
  .toast.error{border-left-color:var(--danger)}

  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .spinning{animation:spin 18s linear infinite}
  @media (prefers-reduced-motion: reduce){
    .spinning{animation:none !important}
    #svgPreview{transition:none}
  }

  /* Phone-first spacing */
  @media (max-width: 480px) {
    header { padding: 12px 12px; }
    .card { padding: 12px; border-radius: 14px; }
    .preview { padding: 12px; }
    #svgPreview { max-width: 100%; height: auto; }
    .monobox { font-size: 12px; line-height: 1.45; }
  }

  /* Simple modal for import/export JSON */
  dialog::backdrop{ background:rgba(0,0,0,.35) }
  .modal-head{display:flex;gap:8px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding:10px}
  .modal-body{padding:10px}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:10px;border-top:1px solid var(--line)}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">⚔️</div>
    <div>
      <div style="display:flex;align-items:center;gap:8px">
        <strong>Medallion Prompt Builder</strong> <span class="pill">Ultimate+</span>
      </div>
      <div class="subtle">Profiles • Builder • Live SVG • Exports</div>
    </div>
  </div>
  <button id="themeToggle" class="theme-toggle" type="button" aria-pressed="false">
    <span class="material-icons" aria-hidden="true">dark_mode</span><span id="themeLabel">Dark</span>
  </button>
</header>

<main class="app">
  <!-- LEFT: Profiles -->
  <aside class="aside card">
    <h2><span class="material-icons" style="font-size:18px" aria-hidden="true">view_carousel</span> Profiles</h2>
    <div class="profiles" role="list">
      <button class="profile" data-profile="fl_army" role="listitem" type="button" aria-label="Load profile Florida plus Army">
        <div class="thumb">FL</div><div><strong>Florida + Army</strong><div class="subtle">Aurebesh rim • Crossed sabers</div><span class="tag">Preset</span></div>
      </button>
      <button class="profile" data-profile="det_wings" role="listitem" type="button" aria-label="Load profile Detroit Wings">
        <div class="thumb">DET</div><div><strong>Detroit + Wings</strong><div class="subtle">Sports fusion • 3 beams</div><span class="tag">Preset</span></div>
      </button>
      <button class="profile" data-profile="jedi_generic" role="listitem" type="button" aria-label="Load profile Galactic Jedi">
        <div class="thumb">JEDI</div><div><strong>Galactic Jedi</strong><div class="subtle">Navy plate • Vertical glow</div><span class="tag">Preset</span></div>
      </button>
    </div>
    <div style="margin-top:12px" class="btns">
      <button id="saveBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">bookmark_add</span>Save Current</button>
      <button id="loadBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">folder_open</span>Load Saved</button>
      <button id="randBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">casino</span>Randomize</button>
      <button id="exportJsonBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">ios_share</span>Export JSON</button>
      <button id="importJsonBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">download</span>Import JSON</button>
    </div>
  </aside>

  <!-- MIDDLE: Builder -->
  <section class="card" aria-label="Builder">
    <h2><span class="material-icons" style="font-size:18px" aria-hidden="true">tune</span> Builder</h2>
    <div class="tabs" role="tablist" aria-label="Sections">
      <button class="tab" id="tab-basic" role="tab" aria-controls="panel-basic" aria-selected="true" data-tab="basic">Basic</button>
      <button class="tab" id="tab-symbols" role="tab" aria-controls="panel-symbols" aria-selected="false" data-tab="symbols" tabindex="-1">Symbols</button>
      <button class="tab" id="tab-advanced" role="tab" aria-controls="panel-advanced" aria-selected="false" data-tab="advanced" tabindex="-1">Advanced</button>
    </div>

    <div id="panel-basic" class="tab-panel" role="tabpanel" aria-labelledby="tab-basic">
      <div class="grid">
        <div class="row"><label for="text_top">Top Text</label><input id="text_top" placeholder="SAINT CLOUD JEDI" autocomplete="off"></div>
        <div class="row"><label for="rim_finish">Rim Finish</label><input id="rim_finish" placeholder="metallic silver" autocomplete="off"></div>
        <div class="row"><label for="plate_color">Plate Color</label><input id="plate_color" placeholder="black" autocomplete="off"></div>
        <div class="row"><label for="text_colors">Text Fill / Outline</label><input id="text_colors" placeholder="white with black outline" autocomplete="off"></div>
        <div class="row"><label for="state_shape">Main Outline</label><input id="state_shape" placeholder="state of Florida" autocomplete="off"></div>
        <div class="row"><label for="outline_color">Outline Color</label><input id="outline_color" placeholder="white" autocomplete="off"></div>
      </div>
    </div>

    <div id="panel-symbols" class="tab-panel" role="tabpanel" aria-labelledby="tab-symbols" hidden>
      <div class="grid">
        <div class="row"><label for="main_symbol">Main Symbol</label><input id="main_symbol" placeholder="Death Star" autocomplete="off"></div>
        <div class="row"><label for="symbol_color">Symbol Color</label><input id="symbol_color" placeholder="red with etched lines" autocomplete="off"></div>
        <div class="row"><label for="badge_elements">Badge Elements</label><input id="badge_elements" placeholder="concentric rings" autocomplete="off"></div>
        <div class="row"><label for="secondary_symbol">Secondary Symbol</label><input id="secondary_symbol" placeholder="Army star (optional)" autocomplete="off"></div>
        <div class="row"><label for="aurebesh_style">Aurebesh Style</label><input id="aurebesh_style" placeholder="glowing Aurebesh along rim" autocomplete="off"></div>
        <div class="row"><label for="sabers_desc">Lightsabers</label><input id="sabers_desc" placeholder="two crossed sabers glow" autocomplete="off"></div>
      </div>
    </div>

    <div id="panel-advanced" class="tab-panel" role="tabpanel" aria-labelledby="tab-advanced" hidden>
      <div class="row"><label for="style_keywords">Style Keywords</label><input id="style_keywords" placeholder="cinematic, heraldic, symmetrical" autocomplete="off"></div>
      <div class="btns" role="group" aria-label="Actions">
        <button id="gen" class="btn primary" type="button"><span class="material-icons" aria-hidden="true">bolt</span>Generate</button>
        <button id="copyBtn" class="btn" type="button"><span class="material-icons" aria-hidden="true">content_copy</span>Copy Text</button>
        <button id="downloadBtn" class="btn" type="button"><span class="material-icons" aria-hidden="true">save</span>Download TXT</button>
        <button id="downloadSvgBtn" class="btn" type="button"><span class="material-icons" aria-hidden="true">image</span>Export SVG</button>
        <button id="downloadPngBtn" class="btn" type="button"><span class="material-icons" aria-hidden="true">photo</span>Export PNG</button>
      </div>
      <div class="subtle" style="margin-top:8px">Shortcuts: <span class="kbd">Ctrl/⌘ + Enter</span> generate • <span class="kbd">Ctrl/⌘ + C</span> copy</div>
    </div>
  </section>

  <!-- RIGHT: Output -->
  <section class="card" aria-label="Output">
    <h2><span class="material-icons" style="font-size:18px" aria-hidden="true">visibility</span> Output</h2>
    <div class="out-wrap">
      <div class="row"><label for="out">Generated Prompt</label><textarea id="out" spellcheck="false" aria-describedby="preview"></textarea></div>
      <div class="preview" aria-live="polite">
        <svg id="svgPreview" viewBox="0 0 300 300" role="img" aria-label="Medallion preview"></svg>
        <div class="preview-controls">
          <button id="zoomOut" class="chip zoom-btn" type="button" aria-label="Zoom out"><span class="material-icons" aria-hidden="true">remove</span></button>
          <span id="zoomLevel" class="subtle" aria-live="polite">100%</span>
          <button id="zoomIn" class="chip zoom-btn" type="button" aria-label="Zoom in"><span class="material-icons" aria-hidden="true">add</span></button>
          <button id="rotateBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">rotate_90_degrees_ccw</span>Rotate</button>
          <button id="toggleSpin" class="chip" type="button" aria-pressed="false"><span class="material-icons" aria-hidden="true">rotate_right</span>Auto-Rotate</button>
          <button id="resetView" class="chip" type="button"><span class="material-icons" aria-hidden="true">restart_alt</span>Reset</button>
        </div>
      </div>
      <div class="row"><label>Text Preview</label><div id="preview" class="monobox"></div></div>
    </div>
  </section>
</main>

<!-- Import/Export JSON Modal -->
<dialog id="jsonModal" aria-labelledby="jsonTitle" aria-modal="true">
  <div class="modal-head">
    <strong id="jsonTitle">Import / Export JSON</strong>
    <button id="closeJson" class="chip" type="button"><span class="material-icons" aria-hidden="true">close</span>Close</button>
  </div>
  <div class="modal-body">
    <textarea id="jsonArea" class="monobox" style="min-height:180px" placeholder='Paste JSON here or edit and click "Apply"'></textarea>
  </div>
  <div class="modal-actions">
    <button id="applyJson" class="btn primary" type="button"><span class="material-icons" aria-hidden="true">check</span>Apply</button>
    <button id="copyJson" class="btn" type="button"><span class="material-icons" aria-hidden="true">content_copy</span>Copy</button>
  </div>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite"><span class="material-icons" aria-hidden="true">check_circle</span><span id="toastMsg">Done</span></div>

<script>
/* ===== Utilities ===== */
const $ = id => document.getElementById(id);
const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
const on = (el, ev, fn, opt) => el && el.addEventListener(ev, fn, opt||{passive:true});
const sleep = ms => new Promise(r => setTimeout(r, ms));
const LSKEY_FORM = 'medallion:form:v2';
const LSKEY_THEME = 'medallion:theme:light';
function toast(msg, isError=false){ const el=$('toast'); el.classList.toggle('error',!!isError); $('toastMsg').textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2200); }

/* ===== Theme (persist) ===== */
(function initTheme(){
  const stored = localStorage.getItem(LSKEY_THEME);
  if (stored === '1') document.body.classList.add('light-theme');
  const light = document.body.classList.contains('light-theme');
  $('themeToggle').setAttribute('aria-pressed', String(light));
  $('themeToggle').querySelector('.material-icons').textContent = light ? 'light_mode' : 'dark_mode';
  $('themeLabel').textContent = light ? 'Light' : 'Dark';
})();
on($('themeToggle'),'click',()=>{
  const light=document.body.classList.toggle('light-theme');
  localStorage.setItem(LSKEY_THEME, light ? '1' : '0');
  $('themeToggle').setAttribute('aria-pressed', String(light));
  $('themeToggle').querySelector('.material-icons').textContent=light?'light_mode':'dark_mode';
  $('themeLabel').textContent=light?'Light':'Dark';
});

/* ===== Tabs (ARIA) ===== */
const tabs=[...document.querySelectorAll('.tab')];
const panels={basic:$('panel-basic'),symbols:$('panel-symbols'),advanced:$('panel-advanced')};
function setTab(btn){const id=btn.dataset.tab; tabs.forEach(t=>{const a=t===btn; t.setAttribute('aria-selected',String(a)); t.tabIndex=a?0:-1;}); Object.entries(panels).forEach(([k,p])=>p.hidden=(k!==id)); btn.focus();}
tabs.forEach(t=>{on(t,'click',()=>setTab(t)); on(t,'keydown',e=>{const i=tabs.indexOf(t); if(e.key==='ArrowRight')setTab(tabs[(i+1)%tabs.length]); if(e.key==='ArrowLeft')setTab(tabs[(i-1+tabs.length)%tabs.length]); if(e.key==='Home')setTab(tabs[0]); if(e.key==='End')setTab(tabs[tabs.length-1]);});});
setTab(tabs[0]);

/* ===== Presets ===== */
const presets={
  fl_army:{text_top:"SAINT CLOUD JEDI",rim_finish:"metallic silver",plate_color:"black",text_colors:"white with black outline",state_shape:"state of Florida",outline_color:"white",main_symbol:"Death Star",symbol_color:"red with etched lines",badge_elements:"concentric rings",secondary_symbol:"Army star emblem",aurebesh_style:"glowing Aurebesh along rim",sabers_desc:"two crossed sabers glow",style_keywords:"cinematic, heraldic, symmetrical"},
  det_wings:{text_top:"DETROIT JEDI",rim_finish:"polished steel",plate_color:"black",text_colors:"white",state_shape:"medallion field",outline_color:"red/black",main_symbol:"Death Star",symbol_color:"red etched",badge_elements:"concentric rings",secondary_symbol:"",aurebesh_style:"glowing inscriptions",sabers_desc:"three angled beams glow",style_keywords:"sports fusion, symmetrical"},
  jedi_generic:{text_top:"GALACTIC JEDI ORDER",rim_finish:"brushed silver",plate_color:"navy",text_colors:"silver outline",state_shape:"medallion field",outline_color:"white",main_symbol:"Jedi crest",symbol_color:"silver",badge_elements:"imperial ticks",secondary_symbol:"",aurebesh_style:"cyan glow runes",sabers_desc:"single vertical saber glow",style_keywords:"heraldic, luminous"}
};
document.querySelectorAll('.profile').forEach(card=>on(card,'click',()=>{const p=presets[card.dataset.profile]; if(p){fillForm(p,true); toast('Profile loaded');}}));

/* ===== Form IO ===== */
const FIELDS = ["text_top","rim_finish","plate_color","text_colors","state_shape","outline_color","main_symbol","symbol_color","badge_elements","secondary_symbol","aurebesh_style","sabers_desc","style_keywords"];

function readForm(){
  const g=id=>(($(id)||{}).value||'').trim();
  return {
    text_top: g('text_top')||"SAINT CLOUD JEDI",
    rim_finish: g('rim_finish')||"metallic silver",
    plate_color: g('plate_color')||"black",
    text_colors: g('text_colors')||"white with black outline",
    state_shape: g('state_shape')||"state of Florida",
    outline_color: g('outline_color')||"white",
    main_symbol: g('main_symbol')||"Death Star",
    symbol_color: g('symbol_color')||"red with etched lines",
    badge_elements: g('badge_elements')||"concentric rings",
    secondary_symbol: g('secondary_symbol')||"",
    aurebesh_style: g('aurebesh_style')||"glowing Aurebesh along rim",
    sabers_desc: g('sabers_desc')||"two crossed sabers glow",
    style_keywords: g('style_keywords')||"cinematic, heraldic, symmetrical"
  };
}
function fillForm(data, andGenerate=false){
  FIELDS.forEach(k=>{ const el=$(k); if(el && data[k]!==undefined) el.value=data[k]; });
  if (andGenerate) generate();
}

/* Autosave debounce */
let saveT;
function autosave(){
  clearTimeout(saveT);
  saveT = setTimeout(()=>{ try{ localStorage.setItem(LSKEY_FORM, JSON.stringify(readForm())); }catch{} }, 250);
}

/* Restore autosave on boot (if present) */
(function restoreAuto(){
  try{ const raw = localStorage.getItem(LSKEY_FORM); if(raw){ const obj = JSON.parse(raw); fillForm(obj,true); } }catch{}
})();

/* ===== Prompt Builder ===== */
function buildPrompt(v){
  return [
    "Cinematic-style medallion pendant design.",
    "• Shape & Base: Round pendant, "+v.rim_finish+", plate in "+v.plate_color+".",
    "• Text: Raised lettering “"+v.text_top+"” in "+v.text_colors+".",
    "• Central Motif: "+v.state_shape+" in "+v.outline_color+" with "+v.main_symbol+" ("+v.symbol_color+"). Elements: "+v.badge_elements+(v.secondary_symbol?(". Secondary: "+v.secondary_symbol):"")+".",
    "• Aurebesh: "+v.aurebesh_style+".",
    "• Lightsabers: "+v.sabers_desc+".",
    "• Style: "+v.style_keywords+"."
  ].join("\n");
}

/* ===== SVG Preview ===== */
let zoom=1, rotation=0, spinning=false;

/* Color resolver with sensible fallbacks */
function colorPick(key, table, fallback){ 
  key=(key||'').toLowerCase();
  for(const [k,v] of table) if(k && key.includes(k)) return v; 
  return fallback; 
}

function updateSvg(v){
  const svg = $('svgPreview');
  if (!svg) return;
  svg.innerHTML = '';

  // --- helpers --------------------------------------------------------------
  const NS = 'http://www.w3.org/2000/svg';
  const hp = n => Math.round(n) + 0.5;                 // half-pixel snap for crisp 1–2px strokes
  const make = (name, attrs = {}, parent = svg) => {
    const el = document.createElementNS(NS, name);
    for (const [k, val] of Object.entries(attrs)) el.setAttribute(k, String(val));
    parent.appendChild(el);
    return el;
  };
  const colorPick = (key, table, fallback) => {
    key = (key || '').toLowerCase();
    for (const [k, v2] of table) if (k && key.includes(k)) return v2;
    return fallback;
  };

  // --- palette --------------------------------------------------------------
  const plateFill = colorPick(v.plate_color, [['black','#121316'],['navy','#0b2346'],['crimson','#5c0b12'],['gray','#2a2f3a'],['white','#f3f6f9'],['forest','#0f2c1b']], '#121316');
  const rimColor  = colorPick(v.rim_finish , [['gold','#ffd54a'],['silver','#c0c7ce'],['steel','#b0b7c3'],['bronze','#c18b52'],['obsidian','#000']], '#9ad6ff');
  const textFill  = colorPick(v.text_colors,[['white','#fff'],['gold','#ffd54a'],['silver','#c0c7ce'],['cyan','#6ee7ff'],['red','#e43b44'],['black','#000']], '#fff');
  const symColor  = colorPick(v.symbol_color,[['red','#e43b44'],['silver','#c0c7ce'],['gold','#ffd54a'],['white','#fff'],['blue','#3b6ee4'],['cyan','#6ee7ff']], '#6ee7ff');

  // --- defs (NO heavy blurs; keep crisp) -----------------------------------
  const defs = make('defs');
  const lgRim = make('linearGradient', { id:'rimGrad', x1:'0%', y1:'0%', x2:'100%', y2:'100%' }, defs);
  lgRim.innerHTML = `<stop offset="0%" stop-color="${rimColor}"/><stop offset="100%" stop-color="${rimColor}" stop-opacity=".82"/>`;

  // saber gradient core
  const lgSaber = make('linearGradient', { id:'saberCore', x1:'0%', y1:'0%', x2:'100%', y2:'0%' }, defs);
  lgSaber.innerHTML = `<stop offset="0%" stop-color="#fff"/><stop offset="50%" stop-color="#c7f3ff"/><stop offset="100%" stop-color="#6ee7ff"/>`;

  // text arc path
  const arc = make('path', { id:'topArc', d:'M 36 120 A 114 114 0 0 1 264 120', pathLength:'1000' }, defs);

  // --- base plate & rims ----------------------------------------------------
  make('circle', { cx:150, cy:150, r:120, fill:plateFill, stroke:rimColor, 'stroke-width':6 });

  // snap outer decorative rims to half-pixels
  make('circle', { cx:150, cy:150, r:hp(136), fill:'none', stroke:'url(#rimGrad)', 'stroke-width':3, opacity:.92 });
  make('circle', { cx:150, cy:150, r:hp(132), fill:'none', stroke:'#fff', 'stroke-opacity':.08, 'stroke-width':2 });

  // inner tick ring (adds precision look)
  const ticks = make('g', { 'stroke': '#8fd6ff', 'stroke-width': 1, 'fill':'none' });
  for (let i = 0; i < 48; i++) {
    const a = (i * 7.5) * Math.PI / 180;
    const r1 = 106, r2 = i % 2 ? 109 : 111;
    const x1 = 150 + r1 * Math.cos(a), y1 = 150 + r1 * Math.sin(a);
    const x2 = 150 + r2 * Math.cos(a), y2 = 150 + r2 * Math.sin(a);
    make('line', { x1: hp(x1), y1: hp(y1), x2: hp(x2), y2: hp(y2) }, ticks);
  }

  // optional badge rings
  if ((v.badge_elements||'').toLowerCase().includes('ring')){
    [90,72,54].forEach((r,i)=>{
      make('circle',{ cx:150, cy:150, r:hp(r), fill:'none', stroke: i===1 ? '#7fbbe0' : rimColor, 'stroke-width':1, 'stroke-dasharray': i===1 ? '6 6' : null });
    });
  }

  // --- main symbol group ----------------------------------------------------
  const g = make('g');

  const ms = (v.main_symbol||'').toLowerCase();
  if (ms.includes('death')) {
    // Death Star (clean geometry; panel lines snapped)
    make('circle', { cx:150, cy:150, r:58, fill:symColor, stroke:'#222', 'stroke-width':1.4 }, g);
    // equatorial trench (masked cut)
    make('line',   { x1: hp(96), y1: hp(150), x2: hp(204), y2: hp(150), stroke: plateFill==='#121316' ? '#0a0a0a' : '#111', 'stroke-width':6 }, g);
    // targeting dish
    make('circle', { cx:178, cy:130, r:12, fill: plateFill==='#121316' ? '#0a0a0a' : '#111', stroke:'#3b3f48', 'stroke-width':1 }, g);
    // radial panels
    for (let i = 0; i < 10; i++) {
      const a = (i * 18) * Math.PI/180, r1=34, r2=58;
      const x1 = 150 + r1*Math.cos(a), y1 = 150 + r1*Math.sin(a);
      const x2 = 150 + r2*Math.cos(a), y2 = 150 + r2*Math.sin(a);
      make('line', { x1: hp(x1), y1: hp(y1), x2: hp(x2), y2: hp(y2), stroke:'#27303d', 'stroke-width':1 }, g);
    }
    // lower panel arc
    make('path', { d:'M 115 180 A 45 45 0 0 0 185 180', stroke:'#27303d', 'stroke-width':1, fill:'none' }, g);
  } else if (ms.includes('jedi')) {
    make('path', { d:'M150 108 L168 96 L168 140 L182 154 L168 168 L168 210 L150 194 L132 210 L132 168 L118 154 L132 140 L132 96 Z', fill:symColor }, g);
  } else if (ms.includes('imperial') || ms.includes('cog')) {
    make('circle', { cx:150, cy:150, r:46, fill:symColor, stroke:'#222', 'stroke-width':1.2 }, g);
    for (let i=0;i<8;i++){
      const a = i*45*Math.PI/180, r1=46, r2=58;
      const x1 = 150 + r1*Math.cos(a), y1 = 150 + r1*Math.sin(a);
      const x2 = 150 + r2*Math.cos(a), y2 = 150 + r2*Math.sin(a);
      make('line', { x1: hp(x1), y1: hp(y1), x2: hp(x2), y2: hp(y2), stroke: symColor, 'stroke-width': 6, 'stroke-linecap':'butt' }, g);
    }
  } else {
    make('path', { d:'M150,102 L164,136 L201,139 L172,162 L180,197 L150,179 L120,197 L128,162 L99,139 L136,136 Z', fill:symColor }, g);
  }

  // secondary emblem (small jewel)
  if ((v.secondary_symbol||'').trim()){
    make('circle', { cx:210, cy:105, r:9, fill:symColor, stroke:'#203040', 'stroke-width':0.75 });
  }

  // --- sabers: crisp glow without blur filters ------------------------------
  const saber = (x1,y1,x2,y2)=>{
    // soft aura (wide, low alpha)
    make('line', { x1, y1, x2, y2, stroke:'#9feaff', 'stroke-opacity':0.22, 'stroke-width':10, 'stroke-linecap':'round' });
    // mid aura
    make('line', { x1, y1, x2, y2, stroke:'#79e4ff', 'stroke-opacity':0.35, 'stroke-width':6,  'stroke-linecap':'round' });
    // core
    make('line', { x1, y1, x2, y2, stroke:'url(#saberCore)', 'stroke-width':3, 'stroke-linecap':'round' });
  };
  const s = (v.sabers_desc||'').toLowerCase();
  if (s.includes('cross') || /\bx\b/.test(s)) {
    saber(105,105,195,195); 
    saber(195,105,105,195);
  } else if (s.includes('three') || /\b3\b/.test(s)) {
    saber(95,210,205,210); 
    saber(115,225,185,165); 
    saber(185,225,115,165);
  } else if (s.includes('circle')) {
    for (let i=0;i<6;i++){
      const a=i*60*Math.PI/180;
      saber(150+40*Math.cos(a),150+40*Math.sin(a),150+80*Math.cos(a),150+80*Math.sin(a));
    }
  } else {
    saber(150,118,150,226);
  }

  // --- aurebesh ring & dots (subtle) ---------------------------------------
  const aure = (v.aurebesh_style||'').toLowerCase();
  if (aure.includes('glow') || aure.includes('aurebesh') || aure.includes('rune') || aure.includes('inscription')){
    make('circle', { cx:150, cy:150, r:hp(108), fill:'none', stroke:'#6ee7ff', 'stroke-width':1, 'stroke-dasharray':'6 6', 'stroke-opacity':.75 });
    const dots = make('g', { fill:'#6ee7ff' });
    for (let i=0;i<16;i++){
      const a=i*22.5*Math.PI/180, x=150+96*Math.cos(a), y=150+96*Math.sin(a);
      make('circle', { cx: x, cy: y, r: 2 }, dots);
    }
  }

  // --- arc text (uses textLength to keep tracking tidy on narrow phones) ----
  if ((v.text_top||'').trim()){
    const wantsOutline = (v.text_colors||'').toLowerCase().includes('outline') || plateFill==='#121316';
    const text = make('text', { 'font-size':15, 'font-weight':800, fill:textFill, 'letter-spacing':.6, 'text-anchor':'middle' });
    if (wantsOutline) text.setAttribute('stroke','#000'), text.setAttribute('stroke-width','1.1'), text.setAttribute('paint-order','stroke');
    const tp = make('textPath', { href:'#topArc', startOffset:'50%', method:'align', spacing:'auto', textLength:'720' }, text);
    const raw = v.text_top.length>28 ? v.text_top.slice(0,27)+'…' : v.text_top;
    tp.textContent = raw.toUpperCase();
  }
}

/* ===== Controls / Generate ===== */
function generate(){ const v=readForm(); $('out').value=buildPrompt(v); $('preview').textContent=$('out').value; updateSvg(v); autosave(); }
['input','change'].forEach(ev=>{ document.querySelectorAll('input,select,textarea').forEach(el=>el.addEventListener(ev, generate, {passive:true})); });
on($('gen'),'click',generate);

/* Save / Load / Randomize (local preset) */
on($('saveBtn'),'click',()=>{localStorage.setItem('medallionPreset', JSON.stringify(readForm())); toast('Preset saved');});
on($('loadBtn'),'click',()=>{const data=localStorage.getItem('medallionPreset'); if(!data) return toast('No saved preset',true); try{fillForm(JSON.parse(data),true); toast('Preset loaded');}catch{toast('Load failed',true)};});
on($('randBtn'),'click',()=>{const s=a=>a[Math.floor(Math.random()*a.length)]; fillForm({
  text_top:s(["STELLAR JEDI","IMPERIAL ORDER","REBEL ALLIANCE","SITH EMPIRE","CORELLIAN KNIGHTS"]),
  rim_finish:s(["metallic silver","polished gold","brushed steel","obsidian black","antique bronze"]),
  plate_color:s(["black","navy","crimson","deep gray","forest green","white"]),
  text_colors:s(["white with black outline","gold fill","glowing cyan","silver embossed","red on black"]),
  state_shape:s(["medallion field","state of Florida","planet outline","Imperial cog","Rebel crest"]),
  outline_color:s(["white","silver","gold trim","red glow","blue neon"]),
  main_symbol:s(["Death Star","Jedi crest","Imperial cog","Lightsaber","Millennium Falcon"]),
  symbol_color:s(["red with etched lines","etched silver","glowing white","gold leaf","blue crystal"]),
  badge_elements:s(["concentric rings","spokes","binary stars","orbital lines","insignia ticks"]),
  secondary_symbol:s(["Army star emblem","","Jedi logo","droid outline","TIE silhouette"]),
  aurebesh_style:s(["glowing Aurebesh along rim","cyan inscriptions","luminous white runes","golden lettering","etched symbols"]),
  sabers_desc:s(["two crossed sabers glow","three angled beams glow","four sabers in X","single vertical saber glow","circle of sabers glow"]),
  style_keywords:s(["cinematic","formal","balanced symmetry","ancient relic","futuristic tech"])
}, true); toast('Randomized');});

/* Import / Export JSON (modal) */
const jsonModal = $('jsonModal');
on($('exportJsonBtn'),'click',()=>{ $('jsonArea').value = JSON.stringify(readForm(), null, 2); jsonModal.showModal(); });
on($('importJsonBtn'),'click',()=>{ $('jsonArea').value=''; jsonModal.showModal(); });
on($('closeJson'),'click',()=>jsonModal.close());
on($('copyJson'),'click',()=>{ navigator.clipboard?.writeText($('jsonArea').value||'').then(()=>toast('JSON copied')); });
on($('applyJson'),'click',()=>{ try{ const obj=JSON.parse($('jsonArea').value||'{}'); fillForm(obj,true); jsonModal.close(); toast('JSON applied'); }catch{ toast('Invalid JSON', true); }});

/* Copy / Export (TXT, SVG, PNG) */
on($('copyBtn'),'click',()=>navigator.clipboard?.writeText($('out').value||'').then(()=>toast('Copied')));
on($('downloadBtn'),'click',()=>{const blob=new Blob([$('out').value||''],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='medallion_prompt.txt'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500); toast('TXT downloaded');});
on($('downloadSvgBtn'),'click',()=>{const svg=$('svgPreview'); if(!svg||!svg.outerHTML) return toast('Nothing to export',true); 
  // bake current rotation into exported SVG
  const rot = rotation%360;
  const cloned = svg.cloneNode(true);
  if(rot){
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    while(cloned.firstChild){ g.appendChild(cloned.firstChild); }
    g.setAttribute('transform',`rotate(${rot} 150 150)`);
    cloned.appendChild(g);
  }
  const xml=`<?xml version="1.0" encoding="UTF-8"?>\n`+cloned.outerHTML; 
  const blob=new Blob([xml],{type:'image/svg+xml'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='medallion_preview.svg'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500); toast('SVG downloaded');});
on($('downloadPngBtn'),'click',()=>{const svg=$('svgPreview'); if(!svg) return;
  const rot = rotation%360;
  const clone = svg.cloneNode(true);
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  while(clone.firstChild){ g.appendChild(clone.firstChild); }
  if(rot){ g.setAttribute('transform',`rotate(${rot} 150 150)`); }
  clone.appendChild(g);
  const xml=`<?xml version="1.0" encoding="UTF-8"?>\n`+clone.outerHTML;

  const scale=2; // retina crisp
  const box=svg.viewBox.baseVal||{width:300,height:300};
  const canvas=document.createElement('canvas'); canvas.width=box.width*scale; canvas.height=box.height*scale;
  const ctx=canvas.getContext('2d');
  const url=URL.createObjectURL(new Blob([xml],{type:'image/svg+xml'}));
  const img=new Image(); img.onload=()=>{ ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0); URL.revokeObjectURL(url);
    canvas.toBlob(b=>{ if(!b){toast('PNG failed',true);return;}
      const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='medallion_preview.png';
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
      toast('PNG downloaded');
    },'image/png');
  };
  img.crossOrigin='anonymous'; img.src=url;
});

/* View controls */
function applyView(){ $('svgPreview').style.transform=`scale(${zoom}) rotate(${rotation}deg)`; $('zoomLevel').textContent=`${Math.round(zoom*100)}%`; $('toggleSpin').setAttribute('aria-pressed', String(spinning)); }
on($('zoomIn'),'click',()=>{zoom=clamp(Math.round((zoom+0.1)*10)/10,0.6,1.8); applyView();});
on($('zoomOut'),'click',()=>{zoom=clamp(Math.round((zoom-0.1)*10)/10,0.6,1.8); applyView();});
on($('rotateBtn'),'click',()=>{rotation=(rotation+45)%360; applyView();});
on($('toggleSpin'),'click',e=>{spinning=!spinning; $('svgPreview').classList.toggle('spinning',spinning); e.currentTarget.querySelector('.material-icons').textContent=spinning?'pause':'rotate_right'; applyView();});
on($('resetView'),'click',()=>{zoom=1; rotation=0; spinning=false; $('svgPreview').classList.remove('spinning'); applyView();});

/* Shortcuts */
addEventListener('keydown',e=>{ 
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); generate(); }
  if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='c' && document.activeElement.id==='out'){ e.preventDefault(); navigator.clipboard?.writeText($('out').value||'').then(()=>toast('Copied')); }
},{passive:true});

/* Boot helpers */
function ensureFirstGenerate(){
  // ensure something is drawn even if restoreAuto found nothing
  if(!$('out').value.trim()){ fillForm(presets.fl_army,true); }
}

/* Boot */
(function boot(){ 
  // wire form listeners for autosave
  FIELDS.forEach(id=>{ const el=$(id); if(el){ el.addEventListener('input', autosave, {passive:true}); el.addEventListener('change', autosave, {passive:true}); } });
  ensureFirstGenerate();
  applyView();
})();
</script>
</body>
</html>
