<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="dark light" />
<title>Medallion Forge — Integrated Ultimate+</title>

<!-- Fonts -->
<link href="https://fonts.cdnfonts.com/css/aurebesh" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet" />

<style>
  /* ===== Theme & tokens ===== */
  :root{
    --bg:#0b0d13; --panel:#151923; --ink:#e8ecf1; --muted:#9aa3af;
    --accent:#6ee7ff; --accent2:#6476ff; --glow:rgba(110,231,255,.35);
    --line:#252b39; --ok:#4ade80; --warn:#fbbf24; --bad:#f87171;
    --mono:"JetBrains Mono","Fira Code",ui-monospace,Menlo,Consolas,monospace;
    --sans:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    --aure:'Aurebesh', var(--sans); --r:16px; --shadow:0 12px 32px rgba(0,0,0,.28);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f5f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent2:#22d3ee; --glow:rgba(37,99,235,.25); --line:#e5e7eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    }
  }
  .light-theme{
    --bg:#f5f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b;
    --accent:#2563eb; --accent2:#22d3ee; --glow:rgba(37,99,235,.25); --line:#e5e7eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 var(--sans);-webkit-text-size-adjust:100%;overflow-x:hidden}

  /* ===== Header ===== */
  header{
    position:sticky;top:0;z-index:10;padding:14px 18px;border-bottom:1px solid var(--line);
    background:color-mix(in oklab, var(--bg) 92%, black 8%);backdrop-filter:blur(6px);
    display:flex;align-items:center;justify-content:space-between
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;
    background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);box-shadow:0 0 18px var(--glow)}
  .pill{padding:3px 8px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;font-size:11px;font-weight:700}
  .theme-toggle{border:1px solid var(--line);color:var(--muted);background:var(--panel);border-radius:10px;padding:6px 10px;display:flex;gap:6px;align-items:center;cursor:pointer}
  .theme-toggle:hover{border-color:var(--accent);color:var(--accent)}

  /* ===== Layout: Profiles | Builder | Live Preview ===== */
  .app{
    max-width:1400px;margin:22px auto;padding:0 16px;display:grid;gap:18px;
    grid-template-columns:320px 1fr 1fr;align-items:start
  }
  @media (max-width:1200px){ .app{grid-template-columns:1fr 1fr} .aside{grid-column:1/-1;order:-1} }
  @media (max-width:800px){ .app{grid-template-columns:1fr} .aside{order:-1} }

  .card{background:color-mix(in oklab, var(--panel) 98%, black 2%);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
  .card h2{font-size:14px;margin:0 0 10px 0;letter-spacing:.2px;display:flex;align-items:center;gap:6px;color:color-mix(in oklab,var(--ink) 85%, var(--muted) 15%)}
  .subtle{color:var(--muted);font-size:12px}

  /* Profiles */
  .profiles{display:grid;gap:10px}
  .profile{
    display:grid;grid-template-columns:56px 1fr;gap:10px;align-items:center;
    border:1px solid var(--line);border-radius:12px;padding:10px;background:var(--panel);cursor:pointer;transition:.2s;
  }
  .profile:hover{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
  .thumb{width:56px;height:56px;border-radius:10px;background:radial-gradient(100% 100% at 25% 20%, var(--accent) 0%, var(--accent2) 100%);display:grid;place-items:center;color:#fff;font-weight:800}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:color-mix(in oklab,var(--accent) 25%, transparent);color:var(--accent);font-size:10px;font-weight:700}
  .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip,.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--ink);cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:.15s;font-weight:600;min-height:40px}
  .chip:hover,.btn:hover{border-color:var(--accent);color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:none}

  /* Tabs + form */
  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);padding-bottom:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer}
  .tab[aria-selected="true"]{background:var(--glow);border-color:var(--accent);color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:600px){ .grid{grid-template-columns:1fr} }
  .row{display:grid;gap:6px}
  label{font-size:12px;font-weight:700;color:color-mix(in oklab, var(--ink) 85%, var(--muted) 15%)}
  input,select,textarea{
    width:100%;padding:11px 12px;border-radius:10px;border:1px solid var(--line);
    background:color-mix(in oklab,var(--bg) 92%, black 8%);color:var(--ink);outline:none
  }
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
  textarea{min-height:200px;font:12.5px/1.55 var(--mono);resize:vertical}

  /* Live Preview (pan/zoom/rotate) */
  .preview{display:grid;gap:12px}
  .stage{position:relative;height:64vh;min-height:420px;border:1px solid var(--line);border-radius:14px;background:color-mix(in oklab,var(--panel) 96%, black 4%);overflow:hidden}
  #inner{position:absolute;top:50%;left:50%;transform-origin:0 0;will-change:transform}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:8px}
  .hud{position:absolute;right:10px;bottom:10px;display:flex;gap:8px;flex-wrap:wrap;pointer-events:none}
  .chip.min{font-size:12px;padding:6px 8px}

  /* Small preview badge (optional) */
  .badgePreview{display:grid;gap:8px;justify-items:center;border:1px dashed var(--line);border-radius:12px;padding:12px}
  #svgBadge{width:300px;height:300px}

  /* Toast + modal */
  .toast{position:fixed;bottom:20px;right:20px;z-index:50;transform:translateY(80px);opacity:0;background:var(--panel);
    border:1px solid var(--line);border-left:4px solid var(--ok);border-radius:10px;padding:12px 14px;box-shadow:var(--shadow);
    display:flex;gap:8px;align-items:center;transition:.35s cubic-bezier(.2,.8,.2,1)}
  .toast.show{transform:translateY(0);opacity:1}
  .toast.error{border-left-color:var(--bad)}
  dialog::backdrop{ background:rgba(0,0,0,.35) }
  .modal-head{display:flex;gap:8px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding:10px}
  .modal-body{padding:10px}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:10px;border-top:1px solid var(--line)}

  /* Phone niceties */
  @media (max-width: 480px) {
    header { padding: 12px 12px; }
    .card { padding: 12px; border-radius: 14px; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">⚔️</div>
    <div>
      <div style="display:flex;align-items:center;gap:8px">
        <strong>Medallion Forge</strong> <span class="pill">Integrated Ultimate+</span>
      </div>
      <div class="subtle">Profiles • Prompt Builder • Dynamic SVG • Export</div>
    </div>
  </div>
  <button id="themeToggle" class="theme-toggle" type="button" aria-pressed="false">
    <span class="material-icons" aria-hidden="true">dark_mode</span><span id="themeLabel">Dark</span>
  </button>
</header>

<main class="app">
  <!-- LEFT: Profiles + IO -->
  <aside class="aside card">
    <h2><span class="material-icons" style="font-size:18px" aria-hidden="true">view_carousel</span> Profiles</h2>
    <div class="profiles" role="list" id="profiles"></div>
    <div class="btns">
      <button id="saveBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">bookmark_add</span>Save Current</button>
      <button id="loadBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">folder_open</span>Load Saved</button>
      <button id="randBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">casino</span>Randomize</button>
      <button id="exportJsonBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">ios_share</span>Export JSON</button>
      <button id="importJsonBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">download</span>Import JSON</button>
    </div>

    <div style="margin-top:14px" class="badgePreview">
      <svg id="svgBadge" viewBox="0 0 300 300" role="img" aria-label="Mini medallion preview"></svg>
      <div class="subtle">Mini preview mirrors the main canvas</div>
    </div>
  </aside>

  <!-- MIDDLE: Prompt Builder (your Ultimate+ fields) -->
  <section class="card" aria-label="Builder">
    <h2><span class="material-icons" style="font-size:18px" aria-hidden="true">tune</span> Builder</h2>
    <div class="tabs" role="tablist" aria-label="Sections">
      <button class="tab" id="tab-basic" role="tab" aria-controls="panel-basic" aria-selected="true" data-tab="basic">Basic</button>
      <button class="tab" id="tab-symbols" role="tab" aria-controls="panel-symbols" aria-selected="false" data-tab="symbols" tabindex="-1">Symbols</button>
      <button class="tab" id="tab-advanced" role="tab" aria-controls="panel-advanced" aria-selected="false" data-tab="advanced" tabindex="-1">Advanced</button>
    </div>

    <div id="panel-basic" class="tab-panel" role="tabpanel" aria-labelledby="tab-basic">
      <div class="grid">
        <div class="row"><label for="text_top">Top Text</label><input id="text_top" placeholder="SAINT CLOUD JEDI" autocomplete="off"></div>
        <div class="row"><label for="rim_finish">Rim Finish</label><input id="rim_finish" placeholder="metallic silver" autocomplete="off"></div>
        <div class="row"><label for="plate_color">Plate Color</label><input id="plate_color" placeholder="black" autocomplete="off"></div>
        <div class="row"><label for="text_colors">Text Fill / Outline</label><input id="text_colors" placeholder="white with black outline" autocomplete="off"></div>
        <div class="row"><label for="state_shape">Main Outline</label><input id="state_shape" placeholder="state of Florida" autocomplete="off"></div>
        <div class="row"><label for="outline_color">Outline Color</label><input id="outline_color" placeholder="white" autocomplete="off"></div>
      </div>
    </div>

    <div id="panel-symbols" class="tab-panel" role="tabpanel" aria-labelledby="tab-symbols" hidden>
      <div class="grid">
        <div class="row"><label for="main_symbol">Main Symbol</label><input id="main_symbol" placeholder="Death Star" autocomplete="off"></div>
        <div class="row"><label for="symbol_color">Symbol Color</label><input id="symbol_color" placeholder="red with etched lines" autocomplete="off"></div>
        <div class="row"><label for="badge_elements">Badge Elements</label><input id="badge_elements" placeholder="concentric rings" autocomplete="off"></div>
        <div class="row"><label for="secondary_symbol">Secondary Symbol</label><input id="secondary_symbol" placeholder="Army star (optional)" autocomplete="off"></div>
        <div class="row"><label for="aurebesh_style">Aurebesh Style</label><input id="aurebesh_style" placeholder="glowing Aurebesh along rim" autocomplete="off"></div>
        <div class="row"><label for="sabers_desc">Lightsabers</label><input id="sabers_desc" placeholder="two crossed sabers glow" autocomplete="off"></div>
      </div>
    </div>

    <div id="panel-advanced" class="tab-panel" role="tabpanel" aria-labelledby="tab-advanced" hidden>
      <div class="row"><label for="style_keywords">Style Keywords</label><input id="style_keywords" placeholder="cinematic, heraldic, symmetrical" autocomplete="off"></div>
      <div class="btns" role="group" aria-label="Actions">
        <button id="gen" class="btn primary" type="button"><span class="material-icons" aria-hidden="true">bolt</span>Generate</button>
        <button id="copyBtn" class="btn" type="button"><span class="material-icons" aria-hidden="true">content_copy</span>Copy Text</button>
        <button id="downloadBtn" class="btn" type="button"><span class="material-icons" aria-hidden="true">save</span>Download TXT</button>
        <button id="downloadSvgBtn" class="btn" type="button"><span class="material-icons" aria-hidden="true">image</span>Export SVG</button>
        <button id="downloadPngBtn" class="btn" type="button"><span class="material-icons" aria-hidden="true">photo</span>Export PNG</button>
      </div>
      <div class="subtle" style="margin-top:8px">Shortcuts: ⌘/Ctrl+Enter generate • ⌘/Ctrl+C copy</div>
      <div class="row" style="margin-top:10px"><label for="out">Generated Prompt</label><textarea id="out" spellcheck="false"></textarea></div>
    </div>
  </section>

  <!-- RIGHT: Live SVG Preview + View tools -->
  <section class="card" aria-label="Preview">
    <h2><span class="material-icons" style="font-size:18px" aria-hidden="true">visibility</span> Live SVG Preview</h2>
    <div class="toolbar">
      <div class="btns">
        <button class="chip" id="fit" type="button"><span class="material-icons" aria-hidden="true">fit_screen</span>Fit</button>
        <button class="chip" id="fillView" type="button"><span class="material-icons" aria-hidden="true">crop_free</span>Fill</button>
        <button class="chip" id="resetView" type="button"><span class="material-icons" aria-hidden="true">restart_alt</span>Reset</button>
        <button class="chip" id="rotateView" type="button"><span class="material-icons" aria-hidden="true">rotate_90_degrees_ccw</span>Rotate</button>
      </div>
      <div class="btns">
        <span class="chip min" id="hudZoom">Zoom 100%</span>
        <span class="chip min" id="hudSize">—</span>
        <span class="chip min" id="meta">—</span>
      </div>
    </div>
    <div class="stage" id="stage"><div id="inner"></div><div class="hud"></div></div>
  </section>
</main>

<!-- Import/Export JSON Modal -->
<dialog id="jsonModal" aria-labelledby="jsonTitle" aria-modal="true">
  <div class="modal-head">
    <strong id="jsonTitle">Import / Export JSON</strong>
    <button id="closeJson" class="chip" type="button"><span class="material-icons" aria-hidden="true">close</span>Close</button>
  </div>
  <div class="modal-body">
    <textarea id="jsonArea" class="card" style="min-height:180px;font:12.5px/1.55 var(--mono)" placeholder='Paste JSON here or edit and click "Apply"'></textarea>
  </div>
  <div class="modal-actions">
    <button id="applyJson" class="btn primary" type="button"><span class="material-icons" aria-hidden="true">check</span>Apply</button>
    <button id="copyJson" class="btn" type="button"><span class="material-icons" aria-hidden="true">content_copy</span>Copy</button>
  </div>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite"><span class="material-icons" aria-hidden="true">check_circle</span><span id="toastMsg">Done</span></div>

<script>
/* ============== Utilities & Theme ============== */
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
const byId=(id)=>document.getElementById(id);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const LS_FORM='medallion:form:v3', LS_THEME='medallion:theme:light';
function toast(msg, err=false){const el=byId('toast'); el.classList.toggle('error',!!err); byId('toastMsg').textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2200);}

(function initTheme(){
  const stored=localStorage.getItem(LS_THEME);
  if(stored==='1') document.body.classList.add('light-theme');
  const light=document.body.classList.contains('light-theme');
  byId('themeToggle').setAttribute('aria-pressed', String(light));
  byId('themeToggle').querySelector('.material-icons').textContent=light?'light_mode':'dark_mode';
  byId('themeLabel').textContent=light?'Light':'Dark';
})();
byId('themeToggle').addEventListener('click',()=>{
  const light=document.body.classList.toggle('light-theme');
  localStorage.setItem(LS_THEME, light?'1':'0');
  byId('themeToggle').setAttribute('aria-pressed', String(light));
  byId('themeToggle').querySelector('.material-icons').textContent=light?'light_mode':'dark_mode';
  byId('themeLabel').textContent=light?'Light':'Dark';
});

/* ============== Tabs (Ultimate+ builder) ============== */
const tabs=$$('.tab');
const panels={basic:byId('panel-basic'), symbols:byId('panel-symbols'), advanced:byId('panel-advanced')};
function setTab(btn){ const id=btn.dataset.tab; tabs.forEach(t=>{const a=t===btn; t.setAttribute('aria-selected',String(a)); t.tabIndex=a?0:-1;}); Object.entries(panels).forEach(([k,p])=>p.hidden=(k!==id)); btn.focus(); }
tabs.forEach(t=>{ t.addEventListener('click',()=>setTab(t)); t.addEventListener('keydown',(e)=>{ const i=tabs.indexOf(t); if(e.key==='ArrowRight') setTab(tabs[(i+1)%tabs.length]); if(e.key==='ArrowLeft') setTab(tabs[(i-1+tabs.length)%tabs.length]); if(e.key==='Home') setTab(tabs[0]); if(e.key==='End') setTab(tabs[tabs.length-1]); }); });
setTab(tabs[0]);

/* ============== Presets / Profiles ============== */
const PRESETS = [
  { id:'fl_army', name:'Florida + Army', note:'Aurebesh rim • Crossed sabers', thumb:'FL',
    form:{ text_top:"SAINT CLOUD JEDI", rim_finish:"metallic silver", plate_color:"black", text_colors:"white with black outline", state_shape:"state of Florida", outline_color:"white", main_symbol:"Death Star", symbol_color:"red with etched lines", badge_elements:"concentric rings", secondary_symbol:"Army star emblem", aurebesh_style:"glowing Aurebesh along rim", sabers_desc:"two crossed sabers glow", style_keywords:"cinematic, heraldic, symmetrical" } },
  { id:'det_wings', name:'Detroit + Wings', note:'Sports fusion • 3 beams', thumb:'DET',
    form:{ text_top:"DETROIT JEDI", rim_finish:"polished steel", plate_color:"black", text_colors:"white", state_shape:"medallion field", outline_color:"red/black", main_symbol:"Death Star", symbol_color:"red etched", badge_elements:"concentric rings", secondary_symbol:"", aurebesh_style:"glowing inscriptions", sabers_desc:"three angled beams glow", style_keywords:"sports fusion, symmetrical" } },
  { id:'jedi_generic', name:'Galactic Jedi', note:'Navy plate • Vertical glow', thumb:'JEDI',
    form:{ text_top:"GALACTIC JEDI ORDER", rim_finish:"brushed silver", plate_color:"navy", text_colors:"silver outline", state_shape:"medallion field", outline_color:"white", main_symbol:"Jedi crest", symbol_color:"silver", badge_elements:"imperial ticks", secondary_symbol:"", aurebesh_style:"cyan glow runes", sabers_desc:"single vertical saber glow", style_keywords:"heraldic, luminous" } },
];
const profilesHost = byId('profiles');
PRESETS.forEach(p=>{
  const btn=document.createElement('button');
  btn.className='profile'; btn.type='button'; btn.setAttribute('role','listitem'); btn.dataset.profile=p.id;
  btn.innerHTML = `<div class="thumb">${p.thumb}</div><div><strong>${p.name}</strong><div class="subtle">${p.note}</div><span class="tag">Preset</span></div>`;
  btn.addEventListener('click',()=>{ fillForm(p.form,true); toast('Profile loaded'); });
  profilesHost.appendChild(btn);
});

/* ============== Form IO + autosave ============== */
const FIELDS=["text_top","rim_finish","plate_color","text_colors","state_shape","outline_color","main_symbol","symbol_color","badge_elements","secondary_symbol","aurebesh_style","sabers_desc","style_keywords"];
function readForm(){
  const v = {};
  FIELDS.forEach(id=>v[id]=(byId(id)?.value||'').trim());
  // sensible defaults
  v.text_top ||= "SAINT CLOUD JEDI";
  v.rim_finish ||= "metallic silver";
  v.plate_color ||= "black";
  v.text_colors ||= "white with black outline";
  v.state_shape ||= "state of Florida";
  v.outline_color ||= "white";
  v.main_symbol ||= "Death Star";
  v.symbol_color ||= "red with etched lines";
  v.badge_elements ||= "concentric rings";
  v.aurebesh_style ||= "glowing Aurebesh along rim";
  v.sabers_desc ||= "two crossed sabers glow";
  v.style_keywords ||= "cinematic, heraldic, symmetrical";
  return v;
}
function fillForm(data, andGenerate=false){ FIELDS.forEach(k=>{ const el=byId(k); if(el && data[k]!==undefined) el.value=data[k]; }); if(andGenerate) generate(); }
let saveT; function autosave(){ clearTimeout(saveT); saveT=setTimeout(()=>{ try{ localStorage.setItem(LS_FORM, JSON.stringify(readForm())); }catch{} }, 250); }
FIELDS.forEach(id=>{ const el=byId(id); if(el){ ['input','change'].forEach(ev=>el.addEventListener(ev,()=>{ generate(); autosave(); }, {passive:true})); }});
(function restore(){ try{ const raw=localStorage.getItem(LS_FORM); if(raw){ fillForm(JSON.parse(raw),true); } }catch{} })();

/* ============== Prompt text builder (stays in sync with SVG) ============== */
function buildPrompt(v){
  return [
    "Cinematic medallion pendant design.",
    "• Shape & Base: Round pendant, "+v.rim_finish+", plate in "+v.plate_color+".",
    "• Text: Raised lettering “"+v.text_top+"” in "+v.text_colors+".",
    "• Central Motif: "+v.state_shape+" in "+v.outline_color+" with "+v.main_symbol+" ("+v.symbol_color+"). Elements: "+v.badge_elements+(v.secondary_symbol?(". Secondary: "+v.secondary_symbol):"")+".",
    "• Aurebesh: "+v.aurebesh_style+".",
    "• Lightsabers: "+v.sabers_desc+".",
    "• Style: "+v.style_keywords+"."
  ].join("\n");
}

/* ============== SVG Generator (dynamic) ============== */
const NS='http://www.w3.org/2000/svg';
const toRad = d=>d*Math.PI/180;
const stage = byId('stage'), inner = byId('inner'), hudZoom = byId('hudZoom'), hudSize = byId('hudSize'), meta = byId('meta');

let view={x:0,y:0,k:1,min:.06,max:8,w:640,h:640,rot:0};
new ResizeObserver(()=>{ const r=stage.getBoundingClientRect(); hudSize.textContent=`${Math.round(r.width)}×${Math.round(r.height)}px`; renderPreview(); }).observe(stage);

function make(name, attrs = {}, parent) { const el=document.createElementNS(NS,name); for(const[k,v] of Object.entries(attrs)) if(v!=null) el.setAttribute(k,String(v)); (parent||currentSvgRoot()).appendChild(el); return el; }
function currentSvgRoot(){ return inner; }

function buildMedallionSvg(v){
  const D=640, R=D/2;
  const svg=document.createElementNS(NS,'svg');
  svg.setAttribute('xmlns',NS); svg.setAttribute('viewBox',`0 0 ${D} ${D}`); svg.setAttribute('width',D); svg.setAttribute('height',D);
  svg.setAttribute('shape-rendering','geometricPrecision');

  // defs
  const defs=make('defs',{},svg);
  const style=make('style',{},defs);
  style.textContent=`.ns{vector-effect:non-scaling-stroke;shape-rendering:crispEdges}.round{stroke-linecap:round;stroke-linejoin:round}`;
  make('path',{id:'topArc', d:`M ${R-180} ${R-200} A 180 180 0 0 1 ${R+180} ${R-200}`}, defs);

  // palette from builder words
  const colorPick=(key, table, fallback)=>{ key=(key||'').toLowerCase(); for(const [k,v] of table){ if(k && key.includes(k)) return v; } return fallback; };
  const plateFill=colorPick(v.plate_color,[['black','#121316'],['navy','#0b2346'],['crimson','#5c0b12'],['gray','#2a2f3a'],['white','#f3f6f9']], '#121316');
  const rimColor=colorPick(v.rim_finish,[['gold','#ffd54a'],['silver','#c0c7ce'],['steel','#b0b7c3'],['bronze','#c18b52'],['obsidian','#000']], '#9ad6ff');
  const textFill=colorPick(v.text_colors,[['white','#fff'],['gold','#ffd54a'],['silver','#c0c7ce'],['cyan','#6ee7ff'],['red','#e43b44'],['black','#000']], '#fff');
  const symColor=colorPick(v.symbol_color,[['red','#e43b44'],['silver','#c0c7ce'],['gold','#ffd54a'],['white','#fff'],['blue','#3b6ee4'],['cyan','#6ee7ff']], '#6ee7ff');
  const outlineColor=colorPick(v.outline_color,[['white','#ffffff'],['gold','#ffd54a'],['silver','#c0c7ce'],['red','#e43b44'],['blue','#3b6ee4']], '#ffffff');

  // base rings
  const gBase=make('g',{},svg);
  make('circle',{cx:R,cy:R,r:R*0.93,fill:plateFill,stroke:rimColor,'stroke-width':10,class:'ns'},gBase);
  make('circle',{cx:R,cy:R,r:R*0.98,fill:'none',stroke:rimColor,'stroke-width':3,class:'ns'},gBase);
  make('circle',{cx:R,cy:R,r:R*0.86,fill:'none',stroke:'#ffffff14','stroke-width':2,class:'ns'},gBase);

  // ticks/rings if requested
  if((v.badge_elements||'').toLowerCase().includes('ring')){
    [0.76,0.64,0.54].forEach((p,i)=>make('circle',{cx:R,cy:R,r:R*p,fill:'none',stroke: i===1 ? '#7fbbe0' : rimColor,'stroke-width': i===1?1:1.2,'stroke-dasharray': i===1?'6 6':null,class:'ns'},gBase));
  }

  // arc text
  if((v.text_top||'').trim()){
    const wantsOutline=(v.text_colors||'').toLowerCase().includes('outline') || plateFill==='#121316';
    const t=make('text',{'font-size':30,'font-weight':800,fill:textFill,'letter-spacing':'.8','text-anchor':'middle'},svg);
    if(wantsOutline){ t.setAttribute('stroke','#000'); t.setAttribute('stroke-width','2'); t.setAttribute('paint-order','stroke'); }
    const tp=make('textPath',{href:'#topArc',startOffset:'50%',method:'align',spacing:'auto'},t);
    const raw=v.text_top.length>34? v.text_top.slice(0,33)+'…' : v.text_top;
    tp.textContent=raw.toUpperCase();
  }

  // state/outline (Florida or generic field)
  if((v.state_shape||'').toLowerCase().includes('florida')){
    const path="M 230 210 C 260 180, 300 190, 330 210 C 352 226, 360 250, 380 270 C 350 268, 340 258, 325 256 C 310 254, 305 266, 292 268 C 270 272, 248 262, 220 252 Z";
    make('path',{d:path,fill:'none',stroke:outlineColor,'stroke-width':6,class:'ns'},svg);
  }else{
    make('circle',{cx:R,cy:R,r:110,fill:'none',stroke:outlineColor,'stroke-width':4,class:'ns'},svg);
  }

  // main symbol
  const g=make('g',{},svg);
  const ms=(v.main_symbol||'').toLowerCase();
  if(ms.includes('death')){
    make('circle',{cx:R,cy:R,r:95,fill:symColor,stroke:'#222','stroke-width':2,class:'ns'},g);
    make('line',{x1:R-95,y1:R,x2:R+95,y2:R,stroke: plateFill==='#121316' ? '#0a0a0a' : '#111','stroke-width':10,class:'ns'},g);
    make('circle',{cx:R+36,cy:R-30,r:20,fill: plateFill==='#121316' ? '#0a0a0a' : '#111',stroke:'#3b3f48','stroke-width':2,class:'ns'},g);
    for(let i=0;i<12;i++){ const a=i*15*Math.PI/180, r1=50, r2=95;
      const x1=R+r1*Math.cos(a), y1=R+r1*Math.sin(a);
      const x2=R+r2*Math.cos(a), y2=R+r2*Math.sin(a);
      make('line',{x1,y1,x2,y2,stroke:'#27303d','stroke-width':1.6,class:'ns'},g);
    }
    make('path',{d:`M ${R-60} ${R+70} A 60 60 0 0 0 ${R+60} ${R+70}`,stroke:'#27303d','stroke-width':1.6,fill:'none',class:'ns'},g);
  } else if (ms.includes('jedi')) {
    make('path',{d:`M${R} ${R-70} L${R+24} ${R-84} L${R+24} ${R} L${R+42} ${R+18} L${R+24} ${R+36} L${R+24} ${R+94} L${R} ${R+74} L${R-24} ${R+94} L${R-24} ${R+36} L${R-42} ${R+18} L${R-24} ${R} L${R-24} ${R-84} Z`,fill:symColor},g);
  } else {
    make('path',{d:`M${R},${R-85} L${R+20},${R-45} L${R+72},${R-40} L${R+30},${R-8} L${R+42},${R+44} L${R},${R+18} L${R-42},${R+44} L${R-30},${R-8} L${R-72},${R-40} L${R-20},${R-45} Z`,fill:symColor},g);
  }

  // secondary symbol marker (Army star placeholder)
  if((v.secondary_symbol||'').trim()){
    make('polygon',{points:starPoints(R+130,R-80,24,12,5),fill:'none',stroke:'#d4af37','stroke-width':4,class:'ns'},svg);
  }

  // sabers (layered strokes for glow without filters)
  const saber=(x1,y1,x2,y2)=>{
    make('line',{x1,y1,x2,y2,stroke:'#9feaff','stroke-opacity':.22,'stroke-width':18,class:'ns round'},svg);
    make('line',{x1,y1,x2,y2,stroke:'#79e4ff','stroke-opacity':.38,'stroke-width':10,class:'ns round'},svg);
    make('line',{x1,y1,x2,y2,stroke:'#fff','stroke-width':4,class:'ns round'},svg);
  };
  const s=(v.sabers_desc||'').toLowerCase();
  if(s.includes('cross')||/\bx\b/.test(s)){ saber(R-90,R-90,R+90,R+90); saber(R+90,R-90,R-90,R+90); }
  else if(s.includes('three')||/\b3\b/.test(s)){ saber(R-100,R+120,R+100,R+120); saber(R-70,R+130,R+40,R+40); saber(R+70,R+130,R-40,R+40); }
  else { saber(R,R-40,R,R+130); }

  // aurebesh cue
  const aure=(v.aurebesh_style||'').toLowerCase();
  if(aure.includes('glow')||aure.includes('aurebesh')||aure.includes('rune')||aure.includes('inscription')){
    make('circle',{cx:R,cy:R,r:R*0.68,fill:'none',stroke:'#6ee7ff','stroke-width':2,'stroke-dasharray':'6 6','stroke-opacity':.75,class:'ns'},svg);
  }

  return svg;

  function starPoints(cx,cy,outerR,innerR,points){
    let str=''; const step=Math.PI/points;
    for(let i=0;i<points*2;i++){ const r=(i%2===0)?outerR:innerR; const a=i*step-Math.PI/2; const x=cx+r*Math.cos(a), y=cy+r*Math.sin(a); str+=`${x},${y} `; }
    return str.trim();
  }
}

/* ============== Preview engine: pan / zoom / rotate ============== */
function mount(svg){
  // vector-effect for crisp zoom
  svg.querySelectorAll('path,rect,circle,ellipse,line,polyline,polygon').forEach(el=>{ if(!el.hasAttribute('vector-effect')) el.setAttribute('vector-effect','non-scaling-stroke'); });
  inner.innerHTML=''; inner.appendChild(svg);
}
function renderPreview(){
  const W=stage.clientWidth, H=stage.clientHeight;
  inner.style.transform =
    `translate(${(W/2)+view.x}px, ${(H/2)+view.y}px) rotate(${view.rot}deg) scale(${view.k}) translate(${-view.w/2}px, ${-view.h/2}px)`;
  hudZoom.textContent=`Zoom ${Math.round(view.k*100)}%`;
}
function fit(){ const r=stage.getBoundingClientRect(); const k=Math.min(r.width/view.w, r.height/view.h); view={...view,x:0,y:0,k}; renderPreview(); }
function fillView(){ const r=stage.getBoundingClientRect(); const k=Math.max(r.width/view.w, r.height/view.h); view={...view,x:0,y:0,k}; renderPreview(); }
function resetView(){ view={...view,x:0,y:0,k:1,rot:0}; renderPreview(); }
function rotateView(){ view.rot=(view.rot+45)%360; renderPreview(); }
byId('fit').addEventListener('click',fit);
byId('fillView').addEventListener('click',fillView);
byId('resetView').addEventListener('click',resetView);
byId('rotateView').addEventListener('click',rotateView);

let dragging=false, lx=0, ly=0;
stage.addEventListener('pointerdown',e=>{dragging=true;stage.setPointerCapture(e.pointerId);lx=e.clientX;ly=e.clientY;});
stage.addEventListener('pointermove',e=>{ if(!dragging) return; view.x+=e.clientX-lx; view.y+=e.clientY-ly; lx=e.clientX; ly=e.clientY; renderPreview(); });
addEventListener('pointerup',()=>dragging=false);
stage.addEventListener('wheel',e=>{
  e.preventDefault();
  const factor = (e.ctrlKey||e.metaKey)?0.0025:0.0015;
  const delta = -e.deltaY*factor;
  const k = clamp(view.k*(1+delta), view.min, view.max);
  const rect=stage.getBoundingClientRect(), cx=e.clientX-rect.left - stage.clientWidth/2 - view.x, cy=e.clientY-rect.top - stage.clientHeight/2 - view.y;
  const ratio = k/view.k; view.x -= cx*(ratio-1); view.y -= cy*(ratio-1); view.k = k; renderPreview();
},{passive:false});

/* ============== Mini badge mirrors main SVG ============== */
function renderBadge(svg){
  const badge=byId('svgBadge'); if(!badge) return;
  badge.innerHTML='';
  const clone=svg.cloneNode(true);
  clone.setAttribute('viewBox','0 0 300 300');
  clone.setAttribute('width','300'); clone.setAttribute('height','300');
  badge.appendChild(clone);
}

/* ============== Export (SVG/PNG/TXT/JSON) ============== */
function toXml(svg){ const clone=svg.cloneNode(true); clone.setAttribute('xmlns',NS); return `<?xml version="1.0" encoding="UTF-8"?>\n`+clone.outerHTML; }
byId('downloadSvgBtn').addEventListener('click',()=>{
  const svg=inner.querySelector('svg'); if(!svg) return toast('Nothing to export',true);
  const g=document.createElementNS(NS,'g'); while(svg.firstChild){ g.appendChild(svg.firstChild) } g.setAttribute('transform',`rotate(${view.rot} ${view.w/2} ${view.h/2})`); svg.appendChild(g);
  const xml=toXml(svg); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([xml],{type:'image/svg+xml'})); a.download='medallion.svg'; a.click(); toast('SVG downloaded');
});
byId('downloadPngBtn').addEventListener('click',()=>{
  const svg=inner.querySelector('svg'); if(!svg) return toast('Nothing to export',true);
  const clone=svg.cloneNode(true); const g=document.createElementNS(NS,'g'); while(clone.firstChild){ g.appendChild(clone.firstChild) }
  g.setAttribute('transform',`rotate(${view.rot} ${view.w/2} ${view.h/2})`); clone.appendChild(g);
  const xml=toXml(clone); const url=URL.createObjectURL(new Blob([xml],{type:'image/svg+xml'}));
  const img=new Image(); const scale=2; img.onload=()=>{
    const box=clone.viewBox.baseVal||{width:view.w,height:view.h}; const c=document.createElement('canvas'); c.width=box.width*scale; c.height=box.height*scale;
    const ctx=c.getContext('2d'); ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0); URL.revokeObjectURL(url);
    c.toBlob(b=>{ if(!b) return toast('PNG failed',true); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='medallion.png'; a.click(); toast('PNG downloaded'); },'image/png');
  }; img.crossOrigin='anonymous'; img.src=url;
});
byId('copyBtn').addEventListener('click',()=>{ navigator.clipboard?.writeText(byId('out').value||'').then(()=>toast('Copied')); });
byId('downloadBtn').addEventListener('click',()=>{
  const blob=new Blob([byId('out').value||''],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='medallion_prompt.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),600); toast('TXT downloaded');
});
const jsonModal=byId('jsonModal');
byId('exportJsonBtn').addEventListener('click',()=>{ byId('jsonArea').value=JSON.stringify(readForm(),null,2); jsonModal.showModal(); });
byId('importJsonBtn').addEventListener('click',()=>{ byId('jsonArea').value=''; jsonModal.showModal(); });
byId('closeJson').addEventListener('click',()=>jsonModal.close());
byId('copyJson').addEventListener('click',()=>navigator.clipboard?.writeText(byId('jsonArea').value||'').then(()=>toast('JSON copied')));
byId('applyJson').addEventListener('click',()=>{ try{ const obj=JSON.parse(byId('jsonArea').value||'{}'); fillForm(obj,true); jsonModal.close(); toast('JSON applied'); }catch{ toast('Invalid JSON',true); }});

/* ============== Save / Load / Randomize presets (localStorage) ============== */
byId('saveBtn').addEventListener('click',()=>{ localStorage.setItem('medallionPreset', JSON.stringify(readForm())); toast('Preset saved'); });
byId('loadBtn').addEventListener('click',()=>{ const data=localStorage.getItem('medallionPreset'); if(!data) return toast('No saved preset',true); try{ fillForm(JSON.parse(data),true); toast('Preset loaded'); }catch{ toast('Load failed',true) }});
byId('randBtn').addEventListener('click',()=>{
  const pick=a=>a[Math.floor(Math.random()*a.length)];
  fillForm({
    text_top:pick(["STELLAR JEDI","IMPERIAL ORDER","REBEL ALLIANCE","SITH EMPIRE","CORELLIAN KNIGHTS"]),
    rim_finish:pick(["metallic silver","polished gold","brushed steel","obsidian black","antique bronze"]),
    plate_color:pick(["black","navy","crimson","deep gray","white"]),
    text_colors:pick(["white with black outline","gold fill","glowing cyan","silver embossed","red on black"]),
    state_shape:pick(["medallion field","state of Florida","planet outline","Imperial cog","Rebel crest"]),
    outline_color:pick(["white","silver","gold trim","red glow","blue neon"]),
    main_symbol:pick(["Death Star","Jedi crest","Imperial cog","Lightsaber"]),
    symbol_color:pick(["red with etched lines","etched silver","glowing white","gold leaf","blue crystal"]),
    badge_elements:pick(["concentric rings","spokes","binary stars","orbital lines","insignia ticks"]),
    secondary_symbol:pick(["Army star emblem",""]),
    aurebesh_style:pick(["glowing Aurebesh along rim","cyan inscriptions","luminous white runes","golden lettering","etched symbols"]),
    sabers_desc:pick(["two crossed sabers glow","three angled beams glow","single vertical saber glow","circle of sabers glow"]),
    style_keywords:pick(["cinematic","formal","balanced symmetry","ancient relic","futuristic tech"])
  }, true);
  toast('Randomized');
});

/* ============== Generate (sync text + SVG) ============== */
function updateOutputs(v){
  // big SVG
  const svg=buildMedallionSvg(v);
  view.w=640; view.h=640; mount(svg); renderPreview();
  meta.textContent=`${view.w}×${view.h} • live`;

  // mini badge
  renderBadge(svg);
}
function generate(){
  const v=readForm();
  byId('out').value = buildPrompt(v);
  updateOutputs(v);
}
byId('gen').addEventListener('click',generate);
addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); generate(); } if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='c' && document.activeElement.id==='out'){ e.preventDefault(); navigator.clipboard?.writeText(byId('out').value||'').then(()=>toast('Copied')); } }, {passive:true});

/* ============== Boot ============== */
(function boot(){
  if(!byId('out').value.trim()){ fillForm(PRESETS[0].form,true); }
  setTimeout(()=>fit(), 60);
})();
</script>
</body>
</html>