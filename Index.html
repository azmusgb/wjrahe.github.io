<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="dark light" />
<meta name="theme-color" content="#0b0d13" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#f6f8fc" media="(prefers-color-scheme: light)">
<title>Medallion Forge — Overhaul (mobile-safe, single-init)</title>

<link href="https://fonts.cdnfonts.com/css/aurebesh" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet" />

<style>
  :root{
    --bg:#0b0d13; --panel:#121521; --ink:#e7ecf3; --muted:#9aa3af;
    --accent:#6ee7ff; --accent2:#6476ff; --glow:rgba(110,231,255,.35);
    --line:#252b39; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --mono:"JetBrains Mono","Fira Code",ui-monospace,Menlo,Consolas,monospace;
    --sans:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    --r:16px; --shadow:0 16px 40px rgba(0,0,0,.28); --header:64px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f8fc; --panel:#fff; --ink:#0f172a; --muted:#5b6b7f;
      --accent:#2563eb; --accent2:#22d3ee; --glow:rgba(37,99,235,.22);
      --line:#e7eaf0; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    }
  }
  .theme-light{
    --bg:#f6f8fc; --panel:#fff; --ink:#0f172a; --muted:#5b6b7f;
    --accent:#2563eb; --accent2:#22d3ee; --glow:rgba(37,99,235,.22);
    --line:#e7eaf0; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 10% -10%, #1a1f2e 0%, #0000 60%),
      radial-gradient(1200px 800px at 110% 10%, #132032 0%, #0000 55%),
      var(--bg);
    font:14px/1.5 var(--sans);
    -webkit-text-size-adjust:100%;
    padding-bottom:max(16px,env(safe-area-inset-bottom));
  }

  header{
    position:sticky; top:0; z-index:50; height:calc(var(--header) + env(safe-area-inset-top));
    padding: max(0px, env(safe-area-inset-top)) 16px 0 16px;
    border-bottom:1px solid var(--line); backdrop-filter: blur(6px);
    background:linear-gradient(90deg, color-mix(in oklab,var(--panel) 92%, black 8%), color-mix(in oklab,var(--panel) 96%, black 4%));
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }

  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow:0 0 18px var(--glow); color:#fff; font-weight:900}
  .pill{padding:4px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;font-size:11px;font-weight:700;letter-spacing:.4px}

  .chip,.btn{
    border:1px solid var(--line); background:var(--panel); color:var(--ink);
    border-radius:10px; padding:10px 14px; display:inline-flex; align-items:center; gap:6px;
    font-weight:600; cursor:pointer; transition:.2s; min-height:40px
  }
  .chip:hover,.btn:hover{border-color:var(--accent); color:var(--accent); box-shadow:0 0 0 3px var(--glow)}
  .primary{border:none; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  .app{max-width:1400px; margin:20px auto; padding:0 16px; display:grid; grid-template-columns:340px 1fr 1fr; gap:20px; align-items:start}
  @media (max-width:1200px){ .app{grid-template-columns:1fr 1fr} .aside{grid-column:1/-1;order:-1} }
  @media (max-width:800px){ .app{grid-template-columns:1fr} .aside{order:-1} }

  .card{background:color-mix(in oklab,var(--panel) 98%, black 2%); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:18px}
  .card h2{margin:0 0 12px; font-size:15px; display:flex; align-items:center; gap:8px; color:color-mix(in oklab,var(--ink) 85%, var(--muted) 15%)}
  .subtle{font-size:12px; color:var(--muted)}

  .profiles{display:grid; gap:10px}
  .profile{
    display:grid; grid-template-columns:48px 1fr auto; gap:12px; align-items:center;
    border:1px solid var(--line); border-radius:12px; padding:10px; background:var(--panel); cursor:pointer;
  }
  .profile:hover{border-color:var(--accent); box-shadow:0 0 0 3px var(--glow)}
  .thumb{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;background:radial-gradient(120% 100% at 25% 20%,var(--accent) 0%,var(--accent2) 100%); color:#fff; font-weight:800}
  .tag{font-size:10px; padding:3px 8px; border-radius:999px; background:color-mix(in oklab, var(--accent) 20%, transparent); color:var(--accent)}

  .grid{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .row{display:grid; gap:6px}
  label{font-size:12px; font-weight:700; color:color-mix(in oklab,var(--ink) 85%, var(--muted) 15%); display:flex; gap:4px; align-items:center}
  input,select,textarea{
    width:100%; padding:11px 12px; border-radius:10px; border:1px solid var(--line);
    background:color-mix(in oklab, var(--bg) 92%, black 8%); color:var(--ink); outline:none; transition:.2s; font:14px var(--sans);
  }
  input:focus,select:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px var(--glow); background:var(--panel)}

  .tabs{display:flex; gap:8px; border-bottom:1px solid var(--line); padding-bottom:8px; margin-bottom:12px}
  .tab{padding:10px 14px; background:transparent; border:1px solid transparent; border-radius:10px; color:var(--muted); font-weight:600; cursor:pointer}
  .tab:hover{background:color-mix(in oklab, var(--accent) 10%, transparent); color:var(--accent)}
  .tab[aria-selected="true"]{background:var(--glow); border-color:var(--accent); color:var(--accent)}
  .tabpanel[hidden]{display:none}

  .stage{
    position:relative;
    height:64svh; min-height:420px; border:1px solid var(--line); border-radius:14px; overflow:hidden;
    background:
      linear-gradient( to bottom right, #ffffff08, #0000 ),
      conic-gradient(from 0deg at 50% 50%, #0000 0 90deg, #0002 0 180deg, #0000 0) 0 0/28px 28px,
      color-mix(in oklab,var(--panel) 96%, black 4%);
    touch-action:none; user-select:none;
  }
  #inner{position:absolute; top:50%; left:50%; transform-origin:0 0; will-change:transform}

  /* Optional mini preview (off by default; toggled via checkbox) */
  .badgePreview{display:none; gap:8px; justify-items:center; border:1px dashed var(--line); border-radius:12px; padding:12px}
  .badgePreview.on{display:grid}
  #svgBadge{width:280px; height:280px}

  dialog{border:1px solid var(--line); background:var(--panel); color:var(--ink); border-radius:16px; padding:0; max-width:92vw; width:560px; box-shadow:var(--shadow)}
  dialog::backdrop{background:rgba(0,0,0,.5); backdrop-filter: blur(4px)}
  .modal-head{display:flex; justify-content:space-between; align-items:center; padding:16px 18px; border-bottom:1px solid var(--line)}
  .modal-body{padding:16px 18px}
  .modal-actions{padding:14px 18px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:flex-end}

  .toast{position:fixed; right:20px; bottom:20px; border:1px solid var(--line); border-left:4px solid var(--ok); background:var(--panel);
    border-radius:12px; padding:12px 14px; display:flex; gap:8px; align-items:center; transform:translateY(100px); opacity:0; transition:.35s; box-shadow:var(--shadow)}
  .toast.show{transform:translateY(0); opacity:1}
  .toast.error{border-left-color:var(--bad)}

  @media (max-width:480px){ header{height:calc(56px + env(safe-area-inset-top))} .logo{width:32px;height:32px} .card{padding:16px} .chip,.btn{padding:8px 10px;min-height:36px} }
  @media (prefers-reduced-motion: reduce){ *{transition:none!important; animation:none!important} }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">⚔️</div>
    <div>
      <div style="display:flex;gap:8px;align-items:center">
        <strong style="font-size:18px">Medallion Forge</strong>
        <span class="pill">Overhaul</span>
      </div>
      <div class="subtle">Profiles • Builder • Live SVG • Export</div>
    </div>
  </div>
  <div class="toolbar" role="group" aria-label="Global">
    <label class="chip" style="gap:6px">
      <span class="material-icons" aria-hidden="true">photo_size_select_large</span>
      <select id="sizeSelect" aria-label="Canvas size">
        <option>320</option><option>512</option><option selected>640</option><option>768</option><option>1024</option>
      </select>
    </label>
    <label class="chip" title="Show mini preview (avoids double-svg by default)">
      <input id="miniToggle" type="checkbox" style="accent-color:var(--accent)"> Mini Preview
    </label>
    <button id="themeToggle" class="chip" type="button" aria-pressed="false" title="Toggle theme">
      <span class="material-icons" aria-hidden="true">dark_mode</span><span id="themeLabel">Dark</span>
    </button>
  </div>
</header>

<main class="app">
  <aside class="aside card">
    <h2><span class="material-icons" aria-hidden="true" style="font-size:18px">view_carousel</span> Profiles</h2>

    <div class="toolbar" style="margin-bottom:10px">
      <input id="profileSearch" placeholder="Search presets…" aria-label="Search presets" style="flex:1;min-width:0">
      <button id="addPresetBtn" class="chip" type="button" title="Save as preset"><span class="material-icons" aria-hidden="true">bookmark_add</span>Save</button>
    </div>

    <div class="profiles" id="profiles" role="list"></div>

    <div class="toolbar" style="margin-top:8px">
      <button id="exportJsonBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">ios_share</span>Export</button>
      <button id="importJsonBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">download</span>Import</button>
      <button id="randBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">casino</span>Random</button>
      <button id="clearBtn" class="chip" type="button"><span class="material-icons" aria-hidden="true">backspace</span>Clear</button>
    </div>

    <!-- Optional mini-preview mount -->
    <div id="miniHost" class="badgePreview" aria-hidden="true">
      <strong class="subtle">Mini Preview</strong>
      <div id="svgBadge" aria-label="Mini preview" role="img"></div>
    </div>
  </aside>

  <section class="card" aria-label="Builder">
    <h2><span class="material-icons" aria-hidden="true" style="font-size:18px">tune</span> Builder</h2>

    <div class="tabs" role="tablist">
      <button class="tab" data-tab="basic" aria-controls="panel-basic" aria-selected="true">Basic</button>
      <button class="tab" data-tab="symbols" aria-controls="panel-symbols" aria-selected="false" tabindex="-1">Symbols</button>
      <button class="tab" data-tab="style" aria-controls="panel-style" aria-selected="false" tabindex="-1">Style & Export</button>
    </div>

    <div id="panel-basic" class="tabpanel" role="tabpanel">
      <div class="grid">
        <div class="row">
          <label for="text_top"><span class="material-icons">text_fields</span>Top Text</label>
          <input id="text_top" placeholder="SAINT CLOUD JEDI" autocomplete="off">
          <div class="subtle">Curved text along the top arc.</div>
        </div>

        <div class="row">
          <label for="rim_finish"><span class="material-icons">settings</span>Rim Finish</label>
          <input id="rim_finish" placeholder="metallic silver">
        </div>

        <div class="row">
          <label for="plate_color"><span class="material-icons">palette</span>Plate Color</label>
          <input id="plate_color" placeholder="black">
        </div>

        <div class="row">
          <label for="text_colors"><span class="material-icons">format_color_text</span>Text Fill / Outline</label>
          <input id="text_colors" placeholder="white with black outline">
        </div>

        <div class="row">
          <label for="state_shape"><span class="material-icons">polyline</span>Main Outline</label>
          <input id="state_shape" placeholder="state of Florida">
        </div>

        <div class="row">
          <label for="outline_color"><span class="material-icons">border_color</span>Outline Color</label>
          <input id="outline_color" placeholder="white">
        </div>

        <div class="row">
          <label for="flip_arc"><span class="material-icons">flip</span>Flip top text</label>
          <select id="flip_arc">
            <option value="auto" selected>Auto</option>
            <option value="normal">Normal</option>
            <option value="flipped">Flipped</option>
          </select>
        </div>
      </div>
    </div>

    <div id="panel-symbols" class="tabpanel" role="tabpanel" hidden>
      <div class="grid">
        <div class="row">
          <label for="main_symbol"><span class="material-icons">star</span>Main Symbol</label>
          <input id="main_symbol" placeholder="Death Star">
        </div>

        <div class="row">
          <label for="symbol_color"><span class="material-icons">color_lens</span>Symbol Color</label>
          <input id="symbol_color" placeholder="red with etched lines">
        </div>

        <div class="row">
          <label for="badge_elements"><span class="material-icons">category</span>Badge Elements</label>
          <input id="badge_elements" placeholder="concentric rings">
        </div>

        <div class="row">
          <label for="secondary_symbol"><span class="material-icons">workspace_premium</span>Secondary Symbol</label>
          <input id="secondary_symbol" placeholder="Army star emblem (optional)">
        </div>

        <div class="row">
          <label for="aurebesh_style"><span class="material-icons">translate</span>Aurebesh Style</label>
          <input id="aurebesh_style" placeholder="glowing Aurebesh along rim">
        </div>

        <div class="row">
          <label for="sabers_desc"><span class="material-icons">flash_on</span>Lightsabers</label>
          <input id="sabers_desc" placeholder="two crossed sabers glow">
        </div>
      </div>
    </div>

    <div id="panel-style" class="tabpanel" role="tabpanel" hidden>
      <div class="grid">
        <div class="row">
          <label for="style_keywords"><span class="material-icons">style</span>Style Keywords</label>
          <input id="style_keywords" placeholder="cinematic, heraldic, symmetrical">
        </div>
        <div class="row">
          <label for="out"><span class="material-icons">notes</span>Generated Prompt</label>
          <textarea id="out" spellcheck="false" placeholder="Generated prompt appears here…" style="min-height:160px; font:13px/1.55 var(--mono)"></textarea>
        </div>
      </div>
      <div class="toolbar" style="margin-top:8px" role="group" aria-label="Export">
        <button id="gen" class="btn primary" type="button"><span class="material-icons" aria-hidden="true">bolt</span>Generate</button>
        <button id="copyBtn" class="btn" type="button"><span class="material-icons">content_copy</span>Copy Text</button>
        <button id="downloadBtn" class="btn" type="button"><span class="material-icons">save</span>Download TXT</button>
        <button id="copySvgBtn" class="btn" type="button"><span class="material-icons">content_paste</span>Copy SVG</button>
        <button id="downloadSvgBtn" class="btn" type="button"><span class="material-icons">image</span>Download SVG</button>
        <button id="downloadPngBtn" class="btn" type="button"><span class="material-icons">photo</span>Download PNG</button>
      </div>
      <div class="subtle">Shortcuts: ⌘/Ctrl+Enter = Generate • ⌘/Ctrl+C inside prompt = Copy</div>
    </div>
  </section>

  <section class="card" aria-label="Preview">
    <h2><span class="material-icons" aria-hidden="true" style="font-size:18px">visibility</span> Live SVG Preview</h2>
    <div class="toolbar" style="margin-bottom:10px">
      <button class="chip" id="fit" type="button"><span class="material-icons">fit_screen</span>Fit</button>
      <button class="chip" id="fillView" type="button"><span class="material-icons">crop_free</span>Fill</button>
      <button class="chip" id="resetView" type="button"><span class="material-icons">restart_alt</span>Reset</button>
      <button class="chip" id="rotateView" type="button"><span class="material-icons">rotate_90_degrees_ccw</span>Rotate</button>
      <span class="chip" id="hudZoom">Zoom 100%</span>
      <span class="chip" id="hudSize">—</span>
      <span class="chip" id="meta">—</span>
    </div>
    <div class="stage" id="stage" aria-label="Pan/zoom stage"><div id="inner"></div></div>
  </section>
</main>

<dialog id="jsonModal" aria-labelledby="jsonTitle" aria-modal="true">
  <div class="modal-head">
    <strong id="jsonTitle">Import / Export JSON</strong>
    <button id="closeJson" class="chip" type="button"><span class="material-icons">close</span>Close</button>
  </div>
  <div class="modal-body">
    <textarea id="jsonArea" class="card" style="min-height:180px; font:13px/1.55 var(--mono)" placeholder='Paste JSON here or edit and click "Apply"'></textarea>
    <div class="subtle" style="margin-top:8px">Schema: {"form": {...current builder values...}, "presets": [...]}</div>
  </div>
  <div class="modal-actions">
    <button id="applyJson" class="btn primary" type="button"><span class="material-icons">check</span>Apply</button>
    <button id="copyJson" class="btn" type="button"><span class="material-icons">content_copy</span>Copy</button>
  </div>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite"><span class="material-icons" aria-hidden="true">check_circle</span><span id="toastMsg">Done</span></div>

<script>
/* ===========================================================
   Idempotent boot guard (prevents double script execution)
   =========================================================== */
if (window.__MEDALLION_BOOTED__) {
  console.debug('Medallion Forge: already booted; skipping duplicate init.');
} else {
  window.__MEDALLION_BOOTED__ = true;

/* ===== Utilities ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const byId=id=>document.getElementById(id);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const NS='http://www.w3.org/2000/svg';
const LS_FORM='medallion:form:overhaul';
const LS_THEME='medallion:theme:light';
const LS_PRESETS='medallion:presets:v2';
const LS_MINI='medallion:mini:on';
const safeLS={ get:k=>{try{return localStorage.getItem(k)}catch{return null}}, set:(k,v)=>{try{localStorage.setItem(k,v)}catch{}} };
function toast(msg,err=false){ const el=byId('toast'); if(!el) return; el.classList.toggle('error',!!err); byId('toastMsg').textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2200); }

/* ===== Theme ===== */
(function initTheme(){ const stored=safeLS.get(LS_THEME); if(stored==='1') document.body.classList.add('theme-light'); paintTheme(); })();
function paintTheme(){ const light=document.body.classList.contains('theme-light'); const t=byId('themeToggle'); if(!t) return; t.setAttribute('aria-pressed',String(light)); t.querySelector('.material-icons').textContent=light?'light_mode':'dark_mode'; byId('themeLabel').textContent=light?'Light':'Dark'; }
byId('themeToggle').addEventListener('click',()=>{ const l=document.body.classList.toggle('theme-light'); safeLS.set(LS_THEME,l?'1':'0'); paintTheme(); });

/* ===== Tabs ===== */
const tabs=$$('.tab');
const panels={basic:byId('panel-basic'),symbols:byId('panel-symbols'),style:byId('panel-style')};
function setTab(t){ const id=t.dataset.tab; tabs.forEach(btn=>{const a=btn===t; btn.setAttribute('aria-selected',String(a)); btn.tabIndex=a?0:-1;}); Object.entries(panels).forEach(([k,p])=>p.hidden=(k!==id)); t.focus(); }
tabs.forEach((t,i)=>{ t.addEventListener('click',()=>setTab(t)); t.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') setTab(tabs[(i+1)%tabs.length]); if(e.key==='ArrowLeft') setTab(tabs[(i-1+tabs.length)%tabs.length]); if(e.key==='Home') setTab(tabs[0]); if(e.key==='End') setTab(tabs.at(-1)); }, {passive:true}); });
setTab(tabs[0]);

/* ===== Presets ===== */
const DEFAULT_PRESETS=[
  {id:'fl_army',name:'Florida + Army',note:'Aurebesh rim • Crossed sabers',thumb:'FL',form:{text_top:"SAINT CLOUD JEDI",rim_finish:"metallic silver",plate_color:"black",text_colors:"white with black outline",state_shape:"state of Florida",outline_color:"white",main_symbol:"Death Star",symbol_color:"red with etched lines",badge_elements:"concentric rings",secondary_symbol:"Army star emblem",aurebesh_style:"glowing Aurebesh along rim",sabers_desc:"two crossed sabers glow",style_keywords:"cinematic, heraldic, symmetrical",flip_arc:"auto"}},
  {id:'det_wings',name:'Detroit + Wings',note:'Sports fusion • 3 beams',thumb:'DET',form:{text_top:"DETROIT JEDI",rim_finish:"polished steel",plate_color:"black",text_colors:"white",state_shape:"medallion field",outline_color:"red/black",main_symbol:"Death Star",symbol_color:"red etched",badge_elements:"concentric rings",secondary_symbol:"",aurebesh_style:"glowing inscriptions",sabers_desc:"three angled beams glow",style_keywords:"sports fusion, symmetrical",flip_arc:"auto"}},
  {id:'jedi_generic',name:'Galactic Jedi',note:'Navy plate • Vertical glow',thumb:'JEDI',form:{text_top:"GALACTIC JEDI ORDER",rim_finish:"brushed silver",plate_color:"navy",text_colors:"silver outline",state_shape:"medallion field",outline_color:"white",main_symbol:"Jedi crest",symbol_color:"silver",badge_elements:"imperial ticks",secondary_symbol:"",aurebesh_style:"cyan glow runes",sabers_desc:"single vertical saber glow",style_keywords:"heraldic, luminous",flip_arc:"auto"}},
];
function getPresets(){ const raw=safeLS.get(LS_PRESETS); if(!raw) return DEFAULT_PRESETS; try{const arr=JSON.parse(raw); return Array.isArray(arr)&&arr.length?arr:DEFAULT_PRESETS}catch{return DEFAULT_PRESETS} }
function setPresets(arr){ safeLS.set(LS_PRESETS, JSON.stringify(arr)); renderProfiles(); }

const profilesHost=byId('profiles');
function renderProfiles(){
  profilesHost.innerHTML='';
  const q=(byId('profileSearch').value||'').toLowerCase();
  getPresets().filter(p=>!q || p.name.toLowerCase().includes(q) || p.thumb.toLowerCase().includes(q)).forEach(p=>{
    const li=document.createElement('div'); li.className='profile'; li.setAttribute('role','listitem');
    li.innerHTML=`<div class="thumb">${p.thumb}</div>
      <div><div style="font-weight:700">${p.name}</div><div class="subtle">${p.note}</div><span class="tag">Preset</span></div>
      <div style="display:flex; gap:6px">
        <button class="chip" data-act="apply" type="button" title="Apply"><span class="material-icons">play_arrow</span></button>
        <button class="chip" data-act="delete" type="button" title="Delete"><span class="material-icons">delete</span></button>
      </div>`;
    li.querySelector('[data-act="apply"]').addEventListener('click',()=>{ fillForm(p.form,true); toast('Preset applied'); });
    li.querySelector('[data-act="delete"]').addEventListener('click',()=>{
      if (DEFAULT_PRESETS.find(d=>d.id===p.id)) return toast('Default presets cannot be deleted', true);
      const all=getPresets().filter(x=>x.id!==p.id); setPresets(all); toast('Preset deleted');
    });
    li.addEventListener('click',e=>{ if(e.target.closest('[data-act]')) return; fillForm(p.form,true); toast('Preset loaded'); });
    profilesHost.appendChild(li);
  });
}
byId('profileSearch').addEventListener('input', renderProfiles);
byId('addPresetBtn').addEventListener('click', ()=>{
  const v=readForm();
  const name=(v.text_top||'Custom Preset').trim().slice(0,40);
  const id='user_'+Date.now().toString(36);
  const arr=getPresets().concat({id,name,thumb:(name.split(' ')[0]||'CUST').toUpperCase().slice(0,4),note:'Saved from form',form:v});
  setPresets(arr); toast('Preset saved');
});

/* ===== Import / Export JSON (wired) ===== */
const jsonModal=byId('jsonModal'), jsonArea=byId('jsonArea');
byId('exportJsonBtn').addEventListener('click', ()=>{
  const payload={ form: readForm(), presets: getPresets() };
  jsonArea.value = JSON.stringify(payload,null,2);
  jsonModal.showModal();
});
byId('importJsonBtn').addEventListener('click', ()=>{ jsonArea.value=''; jsonModal.showModal(); });
byId('applyJson').addEventListener('click', ()=>{
  try{
    const obj=JSON.parse(jsonArea.value||'{}');
    if(obj.form) fillForm(obj.form,true);
    if(Array.isArray(obj.presets)) setPresets(obj.presets);
    jsonModal.close(); toast('JSON applied');
  }catch{ toast('Invalid JSON',true); }
});
byId('copyJson').addEventListener('click', ()=>{ navigator.clipboard?.writeText(jsonArea.value||'').then(()=>toast('Copied')); });
byId('closeJson').addEventListener('click', ()=>jsonModal.close());

/* ===== Mini preview toggle (prevents accidental double-SVG) ===== */
const miniToggle=byId('miniToggle'), miniHost=byId('miniHost');
(function initMini(){ const on = safeLS.get(LS_MINI)==='1'; miniToggle.checked=on; miniHost.classList.toggle('on',on); miniHost.setAttribute('aria-hidden', String(!on)); })();
miniToggle.addEventListener('change', ()=>{
  const on=miniToggle.checked; miniHost.classList.toggle('on',on); miniHost.setAttribute('aria-hidden', String(!on)); safeLS.set(LS_MINI, on?'1':'0');
  // re-render mirror if turning on
  if(on){ const svg=byId('inner')?.querySelector('svg'); if(svg) renderBadge(svg); }
});

/* ===== Randomizer ===== */
byId('randBtn').addEventListener('click', ()=>{
  const base = structuredClone(DEFAULT_PRESETS[Math.floor(Math.random()*DEFAULT_PRESETS.length)].form);
  const picks = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  base.rim_finish = picks(['metallic silver','brushed silver','polished steel','gold','bronze']);
  base.plate_color = picks(['black','navy','crimson','gray','white']);
  base.text_colors = picks(['white with black outline','gold','silver','cyan','red']);
  base.main_symbol = picks(['Death Star','Jedi crest']);
  base.sabers_desc = picks(['two crossed sabers glow','three angled beams glow','single vertical saber glow']);
  base.flip_arc = picks(['auto','normal','flipped']);
  fillForm(base,true);
  toast('Randomized');
});

/* ===== Form IO (autosave) ===== */
let MUTE=false;
const FIELDS=["text_top","rim_finish","plate_color","text_colors","state_shape","outline_color","main_symbol","symbol_color","badge_elements","secondary_symbol","aurebesh_style","sabers_desc","style_keywords","flip_arc"];
function readForm(){
  const v={}; FIELDS.forEach(id=>v[id]=(byId(id)?.value||'').trim());
  v.text_top||="SAINT CLOUD JEDI";
  v.rim_finish||="metallic silver";
  v.plate_color||="black";
  v.text_colors||="white with black outline";
  v.state_shape||="state of Florida";
  v.outline_color||="white";
  v.main_symbol||="Death Star";
  v.symbol_color||="red with etched lines";
  v.badge_elements||="concentric rings";
  v.aurebesh_style||="glowing Aurebesh along rim";
  v.sabers_desc||="two crossed sabers glow";
  v.style_keywords||="cinematic, heraldic, symmetrical";
  v.flip_arc||="auto";
  return v;
}
function fillForm(data, andGenerate=false){
  MUTE=true;
  FIELDS.forEach(k=>{ const el=byId(k); if(el && data[k]!=null){ el.value=data[k]; }});
  MUTE=false;
  if(andGenerate) generate();
}
let saveT;
function autosave(){ clearTimeout(saveT); saveT=setTimeout(()=>safeLS.set(LS_FORM, JSON.stringify(readForm())),200); }
FIELDS.forEach(id=>{
  const el=byId(id); if(!el) return;
  ['input','change'].forEach(ev=>el.addEventListener(ev,()=>{ if(MUTE) return; generate(); autosave(); }, {passive:true}));
});
byId('clearBtn').addEventListener('click', ()=>{ localStorage.removeItem(LS_FORM); fillForm({}, true); toast('Cleared'); });

/* ===== Prompt ===== */
function buildPrompt(v){
  return [
    "Cinematic medallion pendant design.",
    `• Shape & Base: Round pendant, ${v.rim_finish}, plate in ${v.plate_color}.`,
    `• Text: Raised lettering “${v.text_top}” in ${v.text_colors}.`,
    `• Central Motif: ${v.state_shape} (${v.outline_color}) with ${v.main_symbol} (${v.symbol_color}). Elements: ${v.badge_elements}${v.secondary_symbol?`. Secondary: ${v.secondary_symbol}`:''}.`,
    `• Aurebesh: ${v.aurebesh_style}.`,
    `• Lightsabers: ${v.sabers_desc}.`,
    `• Style: ${v.style_keywords}.`
  ].join("\n");
}

/* ===== Stage & SVG ===== */
const stage=byId('stage'), inner=byId('inner'), hudZoom=byId('hudZoom'), hudSize=byId('hudSize'), meta=byId('meta'), sizeSelect=byId('sizeSelect');
let view={x:0,y:0,k:1,min:.06,max:10,w:640,h:640,rot:0};
new ResizeObserver(()=>{ const r=stage.getBoundingClientRect(); hudSize.textContent=`${Math.round(r.width)}×${Math.round(r.height)}px`; renderPreview(); }).observe(stage);
sizeSelect.addEventListener('change',()=>{ view.w=view.h=Number(sizeSelect.value||640); generate(); setTimeout(fit,0); });

function makeFactory(root){
  return function M(name, attrs={}, parent){
    const el=document.createElementNS(NS,name);
    for(const [k,v] of Object.entries(attrs)){
      if(v==null) continue;
      if(k==='href'){ el.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href',String(v)); el.setAttribute('href',String(v)); }
      else el.setAttribute(k,String(v));
    }
    (parent || root).appendChild(el);
    return el;
  };
}
function colorPick(key, table, fallback){ key=(key||'').toLowerCase(); for(const [k,v] of table){ if(k && key.includes(k)) return v; } return fallback; }

function buildMedallionSvg(v){
  const D=view.w, R=D/2;
  const svg=document.createElementNS(NS,'svg');
  svg.setAttribute('xmlns',NS); svg.setAttribute('viewBox',`0 0 ${D} ${D}`); svg.setAttribute('width',D); svg.setAttribute('height',D);
  svg.setAttribute('shape-rendering','geometricPrecision');

  const M = makeFactory(svg);

  const plateFill = colorPick(v.plate_color,[['black','#121316'],['navy','#0b2346'],['crimson','#5c0b12'],['gray','#2a2f3a'],['white','#f3f6f9']], '#121316');
  const rimColor   = colorPick(v.rim_finish,[['gold','#ffd54a'],['silver','#c0c7ce'],['steel','#b0b7c3'],['bronze','#c18b52'],['obsidian','#000']], '#a9bdd1');
  const textFill   = colorPick(v.text_colors,[['white','#fff'],['gold','#ffd54a'],['silver','#c0c7ce'],['cyan','#6ee7ff'],['red','#e43b44'],['black','#000']], '#fff');
  const symColor   = colorPick(v.symbol_color,[['red','#e43b44'],['silver','#c0c7ce'],['gold','#ffd54a'],['white','#fff'],['blue','#3b6ee4'],['cyan','#6ee7ff']], '#6ee7ff');
  const outlineCol = colorPick(v.outline_color,[['white','#ffffff'],['gold','#ffd54a'],['silver','#c0c7ce'],['red','#e43b44'],['blue','#3b6ee4']], '#ffffff');

  const defs=M('defs');
  M('style',{},defs).textContent=`.ns{vector-effect:non-scaling-stroke;shape-rendering:crispEdges}.round{stroke-linecap:round;stroke-linejoin:round}`;
  const sweepA=R*0.78, y=R-sweepA;
  M('path',{id:'topArc',d:`M ${R- sweepA} ${y} A ${sweepA} ${sweepA} 0 0 1 ${R+ sweepA} ${y}`},defs);
  M('path',{id:'topArcRev',d:`M ${R+ sweepA} ${y} A ${sweepA} ${sweepA} 0 0 0 ${R- sweepA} ${y}`},defs);

  const gBase=M('g');
  M('circle',{cx:R,cy:R,r:R*0.94,fill:plateFill,stroke:rimColor,'stroke-width':Math.max(8,D*0.015),class:'ns'},gBase);
  M('circle',{cx:R,cy:R,r:R*0.985,fill:'none',stroke:rimColor,'stroke-width':Math.max(2,D*0.004),class:'ns'},gBase);
  M('circle',{cx:R,cy:R,r:R*0.86,fill:'none',stroke:'#ffffff20','stroke-width':Math.max(1.5,D*0.003),class:'ns'},gBase);

  if((v.badge_elements||'').toLowerCase().includes('ring')){
    [0.76,0.64,0.54].forEach((p,i)=>M('circle',{cx:R,cy:R,r:R*p,fill:'none',stroke: i===1 ? '#7fbbe0' : rimColor,'stroke-width':Math.max(1,D*0.0026),'stroke-dasharray': i===1?'6 6':null,class:'ns'},gBase));
  }

  if((v.text_top||'').trim()){
    const wantsOutline=(v.text_colors||'').toLowerCase().includes('outline') || plateFill==='#121316';
    const t=M('text',{'font-size':Math.max(26,D*0.047),'font-weight':900,fill:textFill,'text-anchor':'middle','letter-spacing':'.8'});
    if(wantsOutline){ t.setAttribute('stroke','#000'); t.setAttribute('stroke-width',Math.max(1.6,D*0.003)); t.setAttribute('paint-order','stroke'); }
    const useRev = (v.flip_arc==='flipped') || (v.flip_arc==='auto' && (view.rot%360+360)%360>=180);
    const tp=M('textPath',{href:useRev?'#topArcRev':'#topArc',startOffset:'50%',method:'align',spacing:'auto'},t);
    tp.textContent=(v.text_top.length>42 ? v.text_top.slice(0,41)+'…' : v.text_top).toUpperCase();
    svg.appendChild(t);
  }

  if((v.state_shape||'').toLowerCase().includes('florida')){
    const path=`M ${R-90} ${R+30} C ${R-40} ${R-10}, ${R+10} ${R-6}, ${R+64} ${R+18}
                C ${R+90} ${R+32}, ${R+96} ${R+56}, ${R+122} ${R+80}
                C ${R+82} ${R+78}, ${R+70} ${R+64}, ${R+50} ${R+62}
                C ${R+28} ${R+60}, ${R+22} ${R+76}, ${R-4} ${R+78}
                C ${R-40} ${R+82}, ${R-72} ${R+68}, ${R-90} ${R+58} Z`;
    M('path',{d:path,fill:'none',stroke:outlineCol,'stroke-width':Math.max(4.5,D*0.007),'stroke-linejoin':'round','class':'ns'});
  } else {
    M('circle',{cx:R,cy:R,r:R*0.34,fill:'none',stroke:outlineCol,'stroke-width':Math.max(3,D*0.005),'class':'ns'});
  }

  const g=M('g');
  const ms=(v.main_symbol||'').toLowerCase();
  if(ms.includes('death')){
    M('circle',{cx:R,cy:R,r:R*0.31,fill:symColor,stroke:'#222','stroke-width':Math.max(2,D*0.0032),class:'ns'},g);
    M('line',{x1:R-R*0.31,y1:R,x2:R+R*0.31,y2:R,stroke: plateFill==='#121316' ? '#0a0a0a' : '#111','stroke-width':Math.max(8,D*0.0125),class:'ns'},g);
    M('circle',{cx:R+R*0.11,cy:R-R*0.09,r:R*0.065,fill: plateFill==='#121316' ? '#0a0a0a' : '#111',stroke:'#3b3f48','stroke-width':Math.max(1.5,D*0.0023),class:'ns'},g);
    for(let i=0;i<12;i++){ const a=i*15*Math.PI/180, r1=R*0.16, r2=R*0.31;
      M('line',{x1:R+r1*Math.cos(a),y1:R+r1*Math.sin(a),x2:R+r2*Math.cos(a),y2:R+r2*Math.sin(a),stroke:'#27303d','stroke-width':Math.max(1.3,D*0.002),'stroke-linecap':'round',class:'ns'},g);
    }
    M('path',{d:`M ${R-R*0.2} ${R+R*0.22} A ${R*0.2} ${R*0.2} 0 0 0 ${R+R*0.2} ${R+R*0.22}`,stroke:'#27303d','stroke-width':Math.max(1.3,D*0.002),fill:'none','class':'ns'},g);
  } else if(ms.includes('jedi')){
    M('path',{d:`M${R} ${R-0.22*D} L${R+0.035*D} ${R-0.26*D} L${R+0.035*D} ${R}
      L${R+0.07*D} ${R+0.028*D} L${R+0.035*D} ${R+0.056*D} L${R+0.035*D} ${R+0.29*D}
      L${R} ${R+0.23*D} L${R-0.035*D} ${R+0.29*D} L${R-0.035*D} ${R+0.056*D}
      L${R-0.07*D} ${R+0.028*D} L${R-0.035*D} ${R} L${R-0.035*D} ${R-0.26*D} Z`,fill:symColor},g);
  } else {
    M('polygon',{points:
      `${R},${R-0.26*D} ${R+0.06*D},${R-0.15*D} ${R+0.11*D},${R-0.14*D} ${R+0.05*D},${R-0.01*D}
       ${R+0.07*D},${R+0.07*D} ${R},${R+0.03*D} ${R-0.07*D},${R+0.07*D} ${R-0.05*D},${R-0.01*D}
       ${R-0.11*D},${R-0.14*D} ${R-0.06*D},${R-0.15*D}`, fill:symColor},g);
  }

  if((v.secondary_symbol||'').trim()){
    const starPts=(cx,cy,or,ir,n=5)=>{let s=''; const step=Math.PI/n; for(let i=0;i<n*2;i++){ const r=(i%2===0)?or:ir, a=i*step-Math.PI/2; s+=`${cx+r*Math.cos(a)},${cy+r*Math.sin(a)} `;} return s.trim();};
    M('polygon',{points:starPts(R+0.4*D,R-0.25*D,0.075*D,0.04*D,5),fill:'none',stroke:'#d4af37','stroke-width':Math.max(3,D*0.0046),class:'ns'});
  }

  const saber=(x1,y1,x2,y2)=>{
    M('line',{x1,y1,x2,y2,stroke:'#9feaff','stroke-opacity':.22,'stroke-width':Math.max(12,D*0.02),class:'ns round'});
    M('line',{x1,y1,x2,y2,stroke:'#79e4ff','stroke-opacity':.38,'stroke-width':Math.max(7,D*0.011),class:'ns round'});
    M('line',{x1,y1,x2,y2,stroke:'#fff','stroke-width':Math.max(3.2,D*0.005),class:'ns round'});
  };
  const s=(v.sabers_desc||'').toLowerCase();
  if(s.includes('cross')||/\bx\b/.test(s)){ saber(R-0.28*D,R-0.28*D,R+0.28*D,R+0.28*D); saber(R+0.28*D,R-0.28*D,R-0.28*D,R+0.28*D); }
  else if(s.includes('three')||/\b3\b/.test(s)){ saber(R-0.31*D,R+0.37*D,R+0.31*D,R+0.37*D); saber(R-0.22*D,R+0.40*D,R+0.12*D,R+0.12*D); saber(R+0.22*D,R+0.40*D,R-0.12*D,R+0.12*D); }
  else{ saber(R,R-0.12*D,R,R+0.40*D); }

  const aure=(v.aurebesh_style||'').toLowerCase();
  if(aure.includes('glow')||aure.includes('aurebesh')||aure.includes('rune')||aure.includes('inscription')){
    M('circle',{cx:R,cy:R,r:R*0.68,fill:'none',stroke:'#6ee7ff','stroke-width':Math.max(2,D*0.003),'stroke-dasharray':'6 6','stroke-opacity':.75,class:'ns'});
  }
  return svg;
}

/* ===== Mount & preview ===== */
function mount(svg){
  svg.querySelectorAll('path,rect,circle,ellipse,line,polyline,polygon').forEach(el=>{ if(!el.hasAttribute('vector-effect')) el.setAttribute('vector-effect','non-scaling-stroke'); });
  inner.innerHTML=''; inner.appendChild(svg);
}
function renderPreview(){
  const W=stage.clientWidth, H=stage.clientHeight;
  inner.style.transform = `translate(${(W/2)+view.x}px, ${(H/2)+view.y}px) rotate(${view.rot}deg) scale(${view.k}) translate(${-view.w/2}px, ${-view.h/2}px)`;
  hudZoom.textContent=`Zoom ${Math.round(view.k*100)}%`;
  meta.textContent=`${view.w}×${view.h} • live`;
}
function fit(){ const r=stage.getBoundingClientRect(); const k=Math.min(r.width/view.w, r.height/view.h); view={...view,x:0,y:0,k}; renderPreview(); }
function fillView(){ const r=stage.getBoundingClientRect(); const k=Math.max(r.width/view.w, r.height/view.h); view={...view,x:0,y:0,k}; renderPreview(); }
function resetView(){ view={...view,x:0,y:0,k:1,rot:0}; renderPreview(); }
function rotateView(){ view.rot=(view.rot+45)%360; renderPreview(); }
byId('fit').addEventListener('click',fit);
byId('fillView').addEventListener('click',fillView);
byId('resetView').addEventListener('click',resetView);
byId('rotateView').addEventListener('click',rotateView);

/* ===== Gestures (improved centric zoom) ===== */
let pointers=new Map(), lastCenter=null, lastDist=null;
stage.addEventListener('pointerdown',e=>{ stage.setPointerCapture?.(e.pointerId); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); }, {passive:true});
stage.addEventListener('pointerup',e=>{ try{stage.releasePointerCapture?.(e.pointerId)}catch{} pointers.delete(e.pointerId); if(pointers.size<2){ lastCenter=lastDist=null } }, {passive:true});
stage.addEventListener('pointercancel',e=>{ pointers.delete(e.pointerId); if(pointers.size<2){ lastCenter=lastDist=null } }, {passive:true});
stage.addEventListener('pointermove',e=>{
  if(!pointers.has(e.pointerId)) return;
  pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
  const pts=[...pointers.values()];
  if(pts.length===1){
    const p=pts[0]; const prev=lastCenter||p; view.x += p.x-prev.x; view.y += p.y-prev.y; lastCenter={...p}; renderPreview();
  }else if(pts.length===2){
    const c={x:(pts[0].x+pts[1].x)/2,y:(pts[0].y+pts[1].y)/2};
    const d=Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
    if(lastCenter && lastDist){
      view.x += c.x-lastCenter.x; view.y += c.y-lastCenter.y;
      const k=clamp(view.k*(d/lastDist), view.min, view.max);
      const rect=stage.getBoundingClientRect(), cx=c.x-rect.left - stage.clientWidth/2 - view.x, cy=c.y-rect.top - stage.clientHeight/2 - view.y;
      const adj=k/view.k; view.x -= cx*(adj-1); view.y -= cy*(adj-1); view.k=k;
      renderPreview();
    }
    lastCenter=c; lastDist=d;
  }
},{passive:true});
stage.addEventListener('wheel',e=>{
  e.preventDefault();
  const factor=(e.ctrlKey||e.metaKey)?0.0025:0.0016;
  const delta=-e.deltaY*factor;
  const k=clamp(view.k*(1+delta), view.min, view.max);
  const rect=stage.getBoundingClientRect(), cx=e.clientX-rect.left - stage.clientWidth/2 - view.x, cy=e.clientY-rect.top - stage.clientHeight/2 - view.y;
  const ratio=k/view.k; view.x -= cx*(ratio-1); view.y -= cy*(ratio-1); view.k=k; renderPreview();
},{passive:false});
stage.addEventListener('dblclick',()=>fit(),{passive:true});

/* ===== Badge mirror (opt-in) ===== */
function renderBadge(svg){
  const host=byId('svgBadge'); if(!host || !miniToggle.checked) return;
  host.innerHTML='';
  const clone=svg.cloneNode(true);
  clone.setAttribute('viewBox','0 0 300 300'); clone.setAttribute('width','300'); clone.setAttribute('height','300');
  host.appendChild(clone);
}

/* ===== Export ===== */
function toXml(svg){ const clone=svg.cloneNode(true); clone.setAttribute('xmlns',NS); return `<?xml version="1.0" encoding="UTF-8"?>\n`+clone.outerHTML; }
function revokeLater(url){ setTimeout(()=>URL.revokeObjectURL(url),1200); }
byId('copySvgBtn').addEventListener('click',()=>{ const svg=inner.querySelector('svg'); if(!svg) return toast('Nothing to copy',true); navigator.clipboard?.writeText(toXml(svg)).then(()=>toast('SVG copied')).catch(()=>toast('Clipboard blocked',true)); });
byId('downloadSvgBtn').addEventListener('click',()=>{
  const svg=inner.querySelector('svg'); if(!svg) return toast('Nothing to export',true);
  const clone=svg.cloneNode(true); const g=document.createElementNS(NS,'g'); while(clone.firstChild) g.appendChild(clone.firstChild);
  g.setAttribute('transform',`rotate(${view.rot} ${view.w/2} ${view.h/2})`); clone.appendChild(g);
  const blob=new Blob([toXml(clone)],{type:'image/svg+xml'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='medallion.svg'; a.click(); revokeLater(url); toast('SVG downloaded');
});
byId('downloadPngBtn').addEventListener('click',()=>{
  const svg=inner.querySelector('svg'); if(!svg) return toast('Nothing to export',true);
  const clone=svg.cloneNode(true); const g=document.createElementNS(NS,'g'); while(clone.firstChild) g.appendChild(clone.firstChild);
  g.setAttribute('transform',`rotate(${view.rot} ${view.w/2} ${view.h/2})`); clone.appendChild(g);
  const xml=toXml(clone); const url=URL.createObjectURL(new Blob([xml],{type:'image/svg+xml'}));
  const img=new Image(); const scale=Math.max(2, Math.ceil((window.devicePixelRatio||1)));
  img.onload=()=>{
    const box=clone.viewBox.baseVal||{width:view.w,height:view.h};
    const c=document.createElement('canvas'); c.width=box.width*scale; c.height=box.height*scale;
    const ctx=c.getContext('2d'); ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0);
    revokeLater(url);
    c.toBlob(b=>{ if(!b) return toast('PNG failed',true);
      const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`medallion_${box.width}x${box.height}.png`; a.click(); revokeLater(u); toast('PNG downloaded');
    },'image/png');
  };
  img.crossOrigin='anonymous'; img.src=url;
});
byId('copyBtn').addEventListener('click',()=>{ navigator.clipboard?.writeText(byId('out').value||'').then(()=>toast('Copied')); });
byId('downloadBtn').addEventListener('click',()=>{
  const blob=new Blob([byId('out').value||''],{type:'text/plain'}); const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download='medallion_prompt.txt'; a.click(); revokeLater(u); toast('TXT downloaded');
});

/* ===== Generate ===== */
function updateOutputs(v){
  const svg=buildMedallionSvg(v);
  mount(svg); renderPreview(); renderBadge(svg);
}
function generate(){
  const v=readForm();
  byId('out').value=buildPrompt(v);
  updateOutputs(v);
}
byId('gen').addEventListener('click',generate);
addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); generate(); }
  if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='c' && document.activeElement.id==='out'){ e.preventDefault(); navigator.clipboard?.writeText(byId('out').value||'').then(()=>toast('Copied')); }
},{passive:false});

/* ===== Boot (single generate) ===== */
(function boot(){
  renderProfiles();
  const saved=safeLS.get(LS_FORM);
  if(saved){ try{ fillForm(JSON.parse(saved), false); }catch{ fillForm(DEFAULT_PRESETS[0].form, false); } }
  else { fillForm(DEFAULT_PRESETS[0].form, false); }
  generate();
  setTimeout(()=>fit(), 80);
})();
} // end idempotent guard
</script>
</body>
</html>