<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="dark light" />
<meta name="theme-color" content="#0d1117" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<title>Medallion Forge — Clean Minimal</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet" />

<style>
  /* ========== Tokens (balanced, subdued) ========== */
  :root{
    --bg: #0d1117; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af;
    --line:#1f2937; --accent:#60a5fa; --accent-2:#22d3ee;
    --ok:#22c55e; --bad:#ef4444;
    --r:12px; --tap:44px; --shadow:0 10px 24px rgba(0,0,0,.22);
    --sans:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    --fs-0:12.5px; --fs-1:14px; --fs-2:16px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#ffffff; --panel:#f8fafc; --ink:#0b1220; --muted:#6b7280;
      --line:#e5e7eb; --accent:#2563eb; --accent-2:#06b6d4;
    }
  }
  .theme-light{
    --bg:#ffffff; --panel:#f8fafc; --ink:#0b1220; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb; --accent-2:#06b6d4;
  }

  /* ========== Base ========== */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font:14px/1.5 var(--sans); color:var(--ink); background:var(--bg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
  .app{max-width:1200px; margin:0 auto; padding:16px}
  .row{display:flex; gap:16px; align-items:stretch}
  .col{flex:1 1 0; min-width:0}
  @media (max-width:900px){ .row{flex-direction:column} .app{padding:12px} }

  .card{
    background: color-mix(in oklab, var(--panel) 96%, black 4%);
    border:1px solid color-mix(in oklab, var(--line) 90%, transparent 10%);
    border-radius:var(--r); box-shadow:var(--shadow); padding:16px; min-height:0;
  }
  h1{font-size:var(--fs-2); margin:0 0 10px; font-weight:800; letter-spacing:.1px}
  h2{font-size:var(--fs-1); margin:0 0 8px; font-weight:800; color:var(--muted)}
  .section{margin-top:8px; padding-top:10px; border-top:1px dashed color-mix(in oklab, var(--line) 65%, transparent 35%)}

  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .chip,.btn{
    min-height:40px; padding:8px 10px; border-radius:10px;
    border:1px solid color-mix(in oklab, var(--line) 90%, transparent 10%);
    background: color-mix(in oklab, var(--panel) 98%, black 2%); color:var(--ink);
    display:inline-flex; align-items:center; gap:6px; cursor:pointer;
  }
  .btn.primary{
    background:linear-gradient(90deg,var(--accent),var(--accent-2)); border:none; color:#fff;
    box-shadow:0 6px 18px color-mix(in oklab, var(--accent) 25%, transparent);
  }
  .chip:hover,.btn:hover{border-color:var(--accent)}
  .material-icons{font-size:18px}

  /* Header */
  header{position:sticky; top:0; z-index:50; background:var(--bg); border-bottom:1px solid var(--line)}
  .header-inner{max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between}
  .brand{display:flex; gap:10px; align-items:center}
  .logo{width:26px; height:26px; border-radius:6px; background:linear-gradient(135deg,var(--accent),var(--accent-2))}
  .brand strong{font-size:15.5px}

  /* Forms */
  .grid{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  label{font-size:var(--fs-0); font-weight:700; color:color-mix(in oklab, var(--muted) 88%, var(--ink) 12%)}
  input,select,textarea{
    width:100%; min-height:40px; padding:10px 12px; border-radius:10px;
    border:1px solid color-mix(in oklab, var(--line) 92%, transparent 8%);
    background:color-mix(in oklab, var(--panel) 92%, black 8%); color:var(--ink); outline:none;
  }
  input:focus,select:focus,textarea:focus{
    border-color: color-mix(in oklab, var(--accent) 65%, var(--line) 35%);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 22%, transparent);
  }
  textarea{resize:vertical}

  /* Quick swatches */
  .swatch-row{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
  .swatch{padding:6px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px; cursor:pointer; background:transparent}
  .swatch[aria-pressed="true"]{border-color:var(--accent); background:color-mix(in oklab, var(--accent) 16%, transparent)}

  /* Tabs */
  .tabs{display:flex; gap:8px; border-bottom:1px solid color-mix(in oklab, var(--line) 85%, transparent 15%); margin-bottom:10px}
  .tab{padding:8px 10px; border-radius:10px; color:var(--muted); border:1px solid transparent; background:transparent; cursor:pointer}
  .tab[aria-selected="true"]{color:color-mix(in oklab, var(--ink) 92%, black 8%); border-color:color-mix(in oklab, var(--accent) 60%, var(--line) 40%); background:color-mix(in oklab, var(--accent) 12%, transparent)}
  .tabpanel[hidden]{display:none}

  /* Preview */
  .stage{position:relative; height:60svh; min-height:380px; border:1px solid var(--line); border-radius:10px; overflow:hidden; background:color-mix(in oklab, var(--panel) 98%, black 2%); -webkit-tap-highlight-color:transparent}
  .stage.light{background:#ffffff}
  #inner{position:absolute; top:50%; left:50%; transform-origin:0 0}
  .hud{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
  .hud .chip{background:color-mix(in oklab, var(--panel) 98%, black 2%)}

  /* Profiles */
  .profiles{display:grid; gap:8px}
  .profile{display:grid; grid-template-columns:40px 1fr auto; gap:10px; align-items:center; padding:10px; border:1px solid color-mix(in oklab, var(--line) 92%, transparent 8%); border-radius:12px; background:color-mix(in oklab, var(--panel) 98%, black 2%); cursor:pointer}
  .profile:hover{border-color:var(--accent)}
  .thumb{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#fff;font-weight:800;font-size:12px}

  /* Dialog + Toast */
  dialog{border:1px solid var(--line); border-radius:12px; padding:0; background:var(--panel); color:var(--ink); width:min(640px,92vw)}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .modal-head,.modal-actions{padding:12px 14px; border-bottom:1px solid var(--line)}
  .modal-actions{border-top:1px solid var(--line); border-bottom:none; display:flex; gap:8px; justify-content:flex-end}
  .modal-body{padding:12px 14px}
  .toast{position:fixed; right:16px; bottom:16px; background:var(--panel); border:1px solid var(--line); border-left:4px solid var(--ok); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(14px); transition:.18s}
  .toast.show{opacity:1; transform:none}
  .toast.error{border-left-color:var(--bad)}
  .sr{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <strong>Medallion Forge</strong>
        <div style="font-size:12px;color:var(--muted)">Profiles • Builder • Preview</div>
      </div>
    </div>
    <div class="toolbar" role="group" aria-label="Global">
      <label class="chip">
        <span class="material-icons" aria-hidden="true">photo_size_select_large</span>
        <select id="sizeSelect" aria-label="Canvas size">
          <option>320</option><option>512</option><option selected>640</option><option>768</option><option>1024</option>
        </select>
      </label>
      <button id="themeToggle" class="chip" type="button" aria-pressed="false" title="Toggle theme">
        <span class="material-icons" aria-hidden="true">dark_mode</span><span id="themeLabel">Dark</span>
      </button>
    </div>
  </div>
</header>

<div class="app">
  <div class="row">
    <!-- Presets -->
    <div class="col">
      <div class="card">
        <h1>Profiles</h1>
        <div class="toolbar" style="margin-bottom:8px">
          <input id="profileSearch" placeholder="Search presets…" aria-label="Search presets" style="flex:1;min-width:0">
          <button id="addPresetBtn" class="chip" type="button" title="Save current"><span class="material-icons">bookmark_add</span>Save</button>
        </div>
        <div id="profiles" class="profiles"></div>
        <div class="toolbar section">
          <button id="exportJsonBtn" class="chip" type="button"><span class="material-icons">ios_share</span>Export</button>
          <button id="importJsonBtn" class="chip" type="button"><span class="material-icons">download</span>Import</button>
          <button id="randBtn" class="chip" type="button"><span class="material-icons">casino</span>Random</button>
          <button id="clearBtn" class="chip" type="button"><span class="material-icons">backspace</span>Clear</button>
        </div>
      </div>
    </div>

    <!-- Builder -->
    <div class="col">
      <div class="card">
        <h1>Builder</h1>
        <div class="tabs" role="tablist">
          <button class="tab" data-tab="basic" aria-controls="panel-basic" aria-selected="true">Basic</button>
          <button class="tab" data-tab="symbols" aria-controls="panel-symbols" aria-selected="false" tabindex="-1">Symbols</button>
          <button class="tab" data-tab="style" aria-controls="panel-style" aria-selected="false" tabindex="-1">Style & Export</button>
        </div>

        <div id="panel-basic" class="tabpanel" role="tabpanel">
          <h2>Top Text & Rim</h2>
          <div class="grid">
            <div>
              <label for="text_top">Top Text</label>
              <input id="text_top" placeholder="SAINT CLOUD JEDI" autocomplete="off">
            </div>
            <div>
              <label for="flip_arc">Flip top text</label>
              <select id="flip_arc">
                <option value="auto" selected>Auto</option>
                <option value="normal">Normal</option>
                <option value="flipped">Flipped</option>
              </select>
            </div>
            <div style="grid-column:1/-1">
              <label for="rim_finish">Rim Finish</label>
              <input id="rim_finish" placeholder="polished steel">
              <div class="swatch-row" id="rim_swatches" role="group" aria-label="Rim presets">
                <button class="swatch" data-val="polished steel">Steel</button>
                <button class="swatch" data-val="brushed silver">Silver</button>
                <button class="swatch" data-val="gold">Gold</button>
                <button class="swatch" data-val="bronze">Bronze</button>
              </div>
            </div>
            <div style="grid-column:1/-1">
              <label for="plate_color">Plate Color</label>
              <input id="plate_color" placeholder="black">
              <div class="swatch-row" id="plate_swatches" role="group" aria-label="Plate presets">
                <button class="swatch" data-val="black">Black</button>
                <button class="swatch" data-val="white">White</button>
                <button class="swatch" data-val="navy">Navy</button>
                <button class="swatch" data-val="crimson">Crimson</button>
              </div>
            </div>
            <div>
              <label for="text_colors">Text Fill / Outline</label>
              <input id="text_colors" placeholder="white with black outline">
            </div>
            <div>
              <label for="outline_color">Outline Color</label>
              <input id="outline_color" placeholder="white">
            </div>
          </div>

          <h2 class="section">Main Outline</h2>
          <div class="grid">
            <div style="grid-column:1/-1">
              <label for="state_shape">Main Outline</label>
              <input id="state_shape" placeholder="state of Florida">
            </div>
          </div>
        </div>

        <div id="panel-symbols" class="tabpanel" role="tabpanel" hidden>
          <h2>Symbols</h2>
          <div class="grid">
            <div>
              <label for="main_symbol">Main Symbol</label>
              <input id="main_symbol" placeholder="Death Star">
            </div>
            <div>
              <label for="symbol_color">Symbol Color</label>
              <input id="symbol_color" placeholder="red with etched lines">
            </div>
            <div>
              <label for="badge_elements">Badge Elements</label>
              <input id="badge_elements" placeholder="concentric rings">
            </div>
            <div>
              <label for="secondary_symbol">Secondary Symbol</label>
              <input id="secondary_symbol" placeholder="Army star emblem (optional)">
            </div>
            <div>
              <label for="aurebesh_style">Aurebesh Style</label>
              <input id="aurebesh_style" placeholder="glowing Aurebesh along rim">
            </div>
            <div>
              <label for="sabers_desc">Lightsabers</label>
              <input id="sabers_desc" placeholder="two crossed sabers glow">
            </div>
          </div>
        </div>

        <div id="panel-style" class="tabpanel" role="tabpanel" hidden>
          <h2>Style & Export</h2>
          <div class="grid">
            <div>
              <label for="style_keywords">Style Keywords</label>
              <input id="style_keywords" placeholder="cinematic, heraldic, symmetrical">
            </div>
            <div style="grid-column:1/-1">
              <label for="out">Generated Prompt</label>
              <textarea id="out" spellcheck="false" placeholder="Generated prompt appears here…" style="min-height:160px"></textarea>
            </div>
          </div>
          <div class="toolbar section">
            <button id="gen" class="btn primary" type="button"><span class="material-icons">bolt</span>Generate</button>
            <button id="copyBtn" class="btn" type="button"><span class="material-icons">content_copy</span>Copy Text</button>
            <button id="downloadBtn" class="btn" type="button"><span class="material-icons">save</span>Download TXT</button>
            <button id="copySvgBtn" class="btn" type="button"><span class="material-icons">content_paste</span>Copy SVG</button>
            <button id="downloadSvgBtn" class="btn" type="button"><span class="material-icons">image</span>Download SVG</button>
            <button id="downloadPngBtn" class="btn" type="button"><span class="material-icons">photo</span>Save PNG</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="col">
      <div class="card">
        <h1>Animated SVG Preview</h1>
        <div class="hud">
          <button class="chip" id="fit" type="button"><span class="material-icons">fit_screen</span>Fit</button>
          <button class="chip" id="fillView" type="button"><span class="material-icons">crop_free</span>Fill</button>
          <button class="chip" id="resetView" type="button"><span class="material-icons">restart_alt</span>Reset</button>
          <button class="chip" id="rotateView" type="button"><span class="material-icons">rotate_90_degrees_ccw</span>Rotate</button>
          <span class="chip" id="hudZoom">Zoom 100%</span>
          <span class="chip" id="hudSize">—</span>
          <span class="chip" id="meta">—</span>
        </div>
        <div class="stage" id="stage" aria-label="Pan/zoom stage"><div id="inner"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- JSON modal -->
<dialog id="jsonModal" aria-labelledby="jsonTitle" aria-modal="true">
  <div class="modal-head"><strong id="jsonTitle">Import / Export JSON</strong></div>
  <div class="modal-body">
    <textarea id="jsonArea" style="width:100%;min-height:220px"></textarea>
  </div>
  <div class="modal-actions">
    <button id="applyJson" class="btn primary" type="button">Apply</button>
    <button id="copyJson" class="btn" type="button">Copy</button>
    <button id="closeJson" class="btn" type="button">Close</button>
  </div>
</dialog>

<div id="toast" class="toast" role="status" aria-live="polite">Done</div>
<div id="live" class="sr" aria-live="polite">Ready.</div>

<script>
/* ===== Single-file, drop-in script (clean & reliable) ===== */
(() => {
  const $=s=>document.querySelector(s);
  const $$=s=>Array.from(document.querySelectorAll(s));
  const byId=id=>document.getElementById(id);
  const NS='http://www.w3.org/2000/svg';
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const LS_FORM='medallion:clean:form', LS_PRESETS='medallion:clean:presets', LS_THEME='medallion:clean:theme';
  const safeLS={get:k=>{try{return localStorage.getItem(k)}catch{return null}}, set:(k,v)=>{try{localStorage.setItem(k,v)}catch{}}, del:k=>{try{localStorage.removeItem(k)}catch{}}};
  const toast=(msg,err=false)=>{ const t=byId('toast'); t.textContent=msg; t.className='toast'+(err?' error':'')+' show'; byId('live').textContent=msg; setTimeout(()=>t.classList.remove('show'),1600); };

  /* Theme */
  (function initTheme(){
    const stored=safeLS.get(LS_THEME);
    if(stored==='1') document.body.classList.add('theme-light');
    const paint=()=>{ const light=document.body.classList.contains('theme-light'); byId('themeToggle').setAttribute('aria-pressed',String(light)); byId('themeToggle').querySelector('.material-icons').textContent=light?'light_mode':'dark_mode'; byId('themeLabel').textContent=light?'Light':'Dark'; byId('stage').classList.toggle('light',light); };
    paint();
    byId('themeToggle').addEventListener('click',()=>{ const l=document.body.classList.toggle('theme-light'); safeLS.set(LS_THEME, l?'1':'0'); paint(); });
  })();

  /* Tabs */
  const tabs=$$('.tab'), panels={basic:byId('panel-basic'), symbols:byId('panel-symbols'), style:byId('panel-style')};
  const setTab=(t)=>{ const id=t.dataset.tab; tabs.forEach(btn=>{const a=btn===t; btn.setAttribute('aria-selected',String(a)); btn.tabIndex=a?0:-1;}); Object.entries(panels).forEach(([k,p])=>p.hidden=(k!==id)); t.focus(); };
  tabs.forEach((t,i)=>{ t.addEventListener('click',()=>setTab(t)); t.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') setTab(tabs[(i+1)%tabs.length]); if(e.key==='ArrowLeft') setTab(tabs[(i-1+tabs.length)%tabs.length]); if(e.key==='Home') setTab(tabs[0]); if(e.key==='End') setTab(tabs.at(-1)); }); });
  setTab(tabs[0]);

  /* Form state */
  const FIELDS=["text_top","rim_finish","plate_color","text_colors","state_shape","outline_color","main_symbol","symbol_color","badge_elements","secondary_symbol","aurebesh_style","sabers_desc","style_keywords","flip_arc"];
  const defaultForm=()=>({
    text_top:"SAINT CLOUD JEDI", rim_finish:"polished steel", plate_color:"black",
    text_colors:"white with black outline", state_shape:"state of Florida", outline_color:"white",
    main_symbol:"Death Star", symbol_color:"red with etched lines", badge_elements:"concentric rings",
    secondary_symbol:"Army star emblem", aurebesh_style:"glowing Aurebesh along rim",
    sabers_desc:"two crossed sabers glow", style_keywords:"cinematic, heraldic, symmetrical", flip_arc:"auto"
  });
  let form = (()=>{ const s=safeLS.get(LS_FORM); if(!s) return defaultForm(); try{const v=JSON.parse(s); return {...defaultForm(),...v}}catch{return defaultForm()} })();
  const readForm=()=>{ const v={}; FIELDS.forEach(id=>v[id]=(byId(id)?.value||'').trim()); return v; };
  const writeForm=(v)=>{ FIELDS.forEach(id=>{ const el=byId(id); if(el && v[id]!=null) el.value=v[id]; }); form=v; safeLS.set(LS_FORM, JSON.stringify(form)); };

  /* Presets */
  const DEFAULT_PRESETS=[
    {id:'fl_army',name:'Florida + Army',note:'Aurebesh rim • Crossed sabers',thumb:'FL',form:defaultForm()},
    {id:'jedi',name:'Galactic Jedi',note:'Navy plate • Vertical glow',thumb:'JEDI',form:{...defaultForm(), text_top:"GALACTIC JEDI ORDER", plate_color:"navy", main_symbol:"Jedi crest", sabers_desc:"single vertical saber glow"}}
  ];
  const getPresets=()=>{ const s=safeLS.get(LS_PRESETS); if(!s) return DEFAULT_PRESETS; try{const arr=JSON.parse(s); return Array.isArray(arr)&&arr.length?arr:DEFAULT_PRESETS}catch{return DEFAULT_PRESETS} };
  const setPresets=(arr)=>{ safeLS.set(LS_PRESETS, JSON.stringify(arr)); renderPresets(); };

  function renderPresets(){
    const host=byId('profiles'); host.innerHTML='';
    const q=(byId('profileSearch').value||'').toLowerCase();
    getPresets().filter(p=>!q || p.name.toLowerCase().includes(q) || p.thumb.toLowerCase().includes(q)).forEach(p=>{
      const div=document.createElement('div'); div.className='profile';
      div.innerHTML=`<div class="thumb">${p.thumb}</div>
        <div><div style="font-weight:800">${p.name}</div><div style="color:var(--muted);font-size:12px">${p.note}</div></div>
        <div class="toolbar"><button class="chip" data-act="apply">Apply</button><button class="chip" data-act="del">Delete</button></div>`;
      div.querySelector('[data-act="apply"]').addEventListener('click',e=>{ e.stopPropagation(); writeForm(p.form); generate(); toast('Preset applied'); });
      div.querySelector('[data-act="del"]').addEventListener('click',e=>{ e.stopPropagation(); if(DEFAULT_PRESETS.find(d=>d.id===p.id)) return toast('Default preset locked',true); setPresets(getPresets().filter(x=>x.id!==p.id)); });
      div.addEventListener('click',()=>{ writeForm(p.form); generate(); });
      host.appendChild(div);
    });
  }
  byId('profileSearch').addEventListener('input', renderPresets);
  byId('addPresetBtn').addEventListener('click', ()=>{
    const v=readForm(); const name=(v.text_top||'Custom Preset').trim().slice(0,40);
    const id='user_'+Date.now().toString(36);
    const arr=getPresets().concat({id,name,thumb:(name.split(' ')[0]||'CUST').toUpperCase().slice(0,4),note:'Saved',form:v});
    setPresets(arr); toast('Preset saved');
  });

  /* Stage / View */
  const stage=byId('stage'), inner=byId('inner'), hudZoom=byId('hudZoom'), hudSize=byId('hudSize'), meta=byId('meta'), sizeSelect=byId('sizeSelect');
  let view={x:0,y:0,k:1,min:.08,max:10,w:640,h:640,rot:0};
  sizeSelect.addEventListener('change',()=>{ const n=Number(sizeSelect.value||640); view.w=view.h=n; generate(); setTimeout(fit,30); });

  new ResizeObserver(()=>{ const r=stage.getBoundingClientRect(); hudSize.textContent=`${Math.round(r.width)}×${Math.round(r.height)}px`; renderPreview(); }).observe(stage);

  const clampZoom=(k)=>clamp(k,view.min,view.max);
  function renderPreview(){
    const W=stage.clientWidth, H=stage.clientHeight;
    inner.style.transform=`translate(${(W/2)+view.x}px, ${(H/2)+view.y}px) rotate(${view.rot}deg) scale(${view.k}) translate(${-view.w/2}px, ${-view.h/2}px)`;
    hudZoom.textContent=`Zoom ${Math.round(view.k*100)}%`; meta.textContent=`${view.w}×${view.h} • live`;
  }
  function fit(){ const r=stage.getBoundingClientRect(); view={...view,x:0,y:0,k:Math.min(r.width/view.w, r.height/view.h)}; renderPreview(); }
  function fill(){ const r=stage.getBoundingClientRect(); view={...view,x:0,y:0,k:Math.max(r.width/view.w, r.height/view.h)}; renderPreview(); }
  function reset(){ view={...view,x:0,y:0,k:1,rot:0}; renderPreview(); }
  function rotate(){ view.rot=(view.rot+45)%360; renderPreview(); }
  byId('fit').addEventListener('click',fit);
  byId('fillView').addEventListener('click',fill);
  byId('resetView').addEventListener('click',reset);
  byId('rotateView').addEventListener('click',rotate);

  /* Gestures */
  let pointers=new Map(), lastCenter=null, lastDist=null;
  stage.addEventListener('pointerdown',e=>{ stage.setPointerCapture?.(e.pointerId); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); });
  ['pointerup','pointercancel'].forEach(ev=>stage.addEventListener(ev,e=>{ try{stage.releasePointerCapture?.(e.pointerId)}catch{} pointers.delete(e.pointerId); if(pointers.size<2){ lastCenter=lastDist=null } }));
  stage.addEventListener('pointermove',e=>{
    if(!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
    const pts=[...pointers.values()];
    if(pts.length===1){
      const p=pts[0]; const prev=lastCenter||p; view.x += p.x-prev.x; view.y += p.y-prev.y; lastCenter={...p}; renderPreview();
    }else if(pts.length===2){
      const c={x:(pts[0].x+pts[1].x)/2,y:(pts[0].y+pts[1].y)/2}, d=Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
      if(lastCenter && lastDist){
        view.x += c.x-lastCenter.x; view.y += c.y-lastCenter.y;
        const k=clampZoom(view.k*(d/lastDist));
        const rect=stage.getBoundingClientRect(), cx=c.x-rect.left - stage.clientWidth/2 - view.x, cy=c.y-rect.top - stage.clientHeight/2 - view.y;
        const adj=k/view.k; view.x -= cx*(adj-1); view.y -= cy*(adj-1); view.k=k;
        renderPreview();
      }
      lastCenter=c; lastDist=d;
    }
  });
  stage.addEventListener('wheel',e=>{
    e.preventDefault();
    const delta=-e.deltaY*((e.ctrlKey||e.metaKey)?0.0022:0.0014);
    const k=clampZoom(view.k*(1+delta));
    const rect=stage.getBoundingClientRect(), cx=e.clientX-rect.left - stage.clientWidth/2 - view.x, cy=e.clientY-rect.top - stage.clientHeight/2 - view.y;
    const ratio=k/view.k; view.x -= cx*(ratio-1); view.y -= cy*(ratio-1); view.k=k; renderPreview();
  },{passive:false});
  stage.addEventListener('dblclick',fit);

  /* Quick swatches */
  function bindSwatches(containerId, inputId){
    const host = byId(containerId); const input = byId(inputId);
    if(!host || !input) return;
    host.addEventListener('click', (e)=>{
      const b=e.target.closest('.swatch'); if(!b) return;
      host.querySelectorAll('.swatch').forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      input.value = b.dataset.val || '';
      generate();
    });
  }
  bindSwatches('rim_swatches','rim_finish');
  bindSwatches('plate_swatches','plate_color');

  /* SVG builder */
  function colorPick(key, table, fallback){ key=(key||'').toLowerCase(); for(const [k,v] of table){ if(k && key.includes(k)) return v; } return fallback; }
  function MFactory(root){ return (name, attrs={}, parent)=>{ const el=document.createElementNS(NS,name); for(const [k,v] of Object.entries(attrs)){ if(v==null) continue; if(k==='href'){ el.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href',String(v)); el.setAttribute('href',String(v)); } else el.setAttribute(k,String(v)); } (parent||root).appendChild(el); return el; }; }

  function buildSvg(v){
  const D = Math.round(view.w);         // integral box for crispness
  const R = D/2;

  const svg = document.createElementNS(NS,'svg');
  svg.setAttribute('viewBox',`0 0 ${D} ${D}`);
  svg.setAttribute('width', D);
  svg.setAttribute('height', D);
  svg.setAttribute('shape-rendering','geometricPrecision');
  svg.setAttribute('text-rendering','optimizeLegibility');

  const M = MFactory(svg);

  // ---- Color picks (stable) ----
  const plate = colorPick(v.plate_color,[['black','#0b1220'],['navy','#0a1e3a'],['crimson','#5b1116'],['gray','#2b2f36'],['white','#f7fafc']], '#0b1220');
  const rim   = colorPick(v.rim_finish,[['gold','#e9c152'],['silver','#c3cad3'],['steel','#b6bec9'],['bronze','#b6874a'],['polished','#c3cad3']], '#a9b7c7');
  const tfill = colorPick(v.text_colors,[['white','#fff'],['gold','#e9c152'],['silver','#c3cad3'],['cyan','#7dd3fc'],['red','#ef4444'],['black','#000']], '#fff');
  const sym   = colorPick(v.symbol_color,[['red','#ef4444'],['silver','#c3cad3'],['gold','#e9c152'],['white','#fff'],['blue','#3b82f6'],['cyan','#7dd3fc']], '#7dd3fc');
  const oline = colorPick(v.outline_color,[['white','#ffffff'],['gold','#e9c152'],['silver','#c3cad3'],['red','#ef4444'],['blue','#3b82f6']], '#ffffff');

  // ---- Defs: gradients, filters, paths ----
  const defs = M('defs');

  // rim gradient (bevel)
  const rg = M('radialGradient',{id:'rimRG',cx:'50%',cy:'50%',r:'60%'}, defs);
  M('stop',{offset:'0%','stop-color':'#fff','stop-opacity':.18}, rg);
  M('stop',{offset:'55%','stop-color':rim,'stop-opacity':1}, rg);
  M('stop',{offset:'100%','stop-color':'#000','stop-opacity':.28}, rg);

  // plate vignette (very subtle)
  const pg = M('radialGradient',{id:'plateRG',cx:'50%',cy:'45%',r:'80%'}, defs);
  M('stop',{offset:'0%','stop-color':plate}, pg);
  M('stop',{offset:'100%','stop-color':'#000','stop-opacity': plate==='#f7fafc' ? .04 : .12}, pg);

  // soft glow for sabers/aurebesh (Safari-friendly shadow)
  const glow = M('filter',{id:'softGlow',x:'-30%',y:'-30%',width:'160%',height:'160%'}, defs);
  M('feGaussianBlur',{stdDeviation:2,result:'b'}, glow);
  M('feMerge',{}, glow); M('feMergeNode',{'in':'b'}, glow.lastChild); M('feMergeNode',{'in':'SourceGraphic'}, glow.lastChild);

  // text arcs (give pathLength to stabilize letter spacing across engines)
  const sweepA = Math.floor(R*0.78);
  const y      = Math.floor(R-sweepA);
  const arc1   = `M ${Math.floor(R- sweepA)} ${y} A ${sweepA} ${sweepA} 0 0 1 ${Math.ceil(R+ sweepA)} ${y}`;
  const arc2   = `M ${Math.ceil(R+ sweepA)} ${y} A ${sweepA} ${sweepA} 0 0 0 ${Math.floor(R- sweepA)} ${y}`;
  M('path',{id:'topArc',d:arc1,pathLength:1000}, defs);
  M('path',{id:'topArcRev',d:arc2,pathLength:1000}, defs);

  // ---- Base discs ----
  const kRim = Math.max(8, D*0.015);
  const gBase = M('g');

  // plate with vignette
  M('circle',{cx:R,cy:R,r:R*0.94,fill:'url(#plateRG)',stroke:'none'}, gBase);
  // rim stroke over plate (bevel)
  M('circle',{cx:R,cy:R,r:R*0.94,fill:'none',stroke:'url(#rimRG)','stroke-width':kRim}, gBase);
  // outer fine ring
  M('circle',{cx:R,cy:R,r:R*0.985,fill:'none',stroke:rim,'stroke-width':Math.max(2,D*0.004)}, gBase);
  // decorative inner ring
  M('circle',{cx:R,cy:R,r:R*0.86,fill:'none',stroke:'#ffffff22','stroke-width':Math.max(1.2,D*0.003)}, gBase);

  // optional concentric rings
  if((v.badge_elements||'').toLowerCase().includes('ring')){
    [0.76,0.64,0.54].forEach((p,i)=>M('circle',{cx:R,cy:R,r:R*p,fill:'none',stroke:i===1?'#7dd3fc':rim,'stroke-width':Math.max(1,D*0.0026),'stroke-dasharray': i===1?'6 6':null}, gBase));
  }

  // ---- Arc text (Safari-safe) ----
  if((v.text_top||'').trim()){
    const wantsOutline = (v.text_colors||'').toLowerCase().includes('outline') || plate==='#0b1220';
    const text = M('text',{
      'font-size':Math.max(24,D*0.046),'font-weight':800,fill:tfill,
      'text-anchor':'middle','letter-spacing':'.6px','lengthAdjust':'spacingAndGlyphs'
    });
    if(wantsOutline){ text.setAttribute('stroke','#000'); text.setAttribute('stroke-width',Math.max(1.5,D*0.003)); text.setAttribute('paint-order','stroke'); }
    const rot = ((view.rot%360)+360)%360;
    const useRev = (v.flip_arc==='flipped') || (v.flip_arc==='auto' && rot>=180);
    const tp = M('textPath',{href:useRev?'#topArcRev':'#topArc',startOffset:'50%'}, text);
    tp.textContent=(v.text_top.length>42 ? v.text_top.slice(0,41)+'…' : v.text_top).toUpperCase();
    svg.appendChild(text);
  }

  // ---- Center outline ----
  if((v.state_shape||'').toLowerCase().includes('florida')){
    const path=`M ${R-90} ${R+30} C ${R-40} ${R-10}, ${R+10} ${R-6}, ${R+64} ${R+18}
                C ${R+90} ${R+32}, ${R+96} ${R+56}, ${R+122} ${R+80}
                C ${R+82} ${R+78}, ${R+70} ${R+64}, ${R+50} ${R+62}
                C ${R+28} ${R+60}, ${R+22} ${R+76}, ${R-4} ${R+78}
                C ${R-40} ${R+82}, ${R-72} ${R+68}, ${R-90} ${R+58} Z`;
    M('path',{d:path,fill:'none',stroke:oline,'stroke-width':Math.max(4.5,D*0.007),'stroke-linejoin':'round'});
  } else {
    M('circle',{cx:R,cy:R,r:R*0.34,fill:'none',stroke:oline,'stroke-width':Math.max(3,D*0.005)});
  }

  // ---- Symbol block (cleaner “Death Star” with shading) ----
  const g = M('g');
  const ms=(v.main_symbol||'').toLowerCase();
  if(ms.includes('death')){
    // planet body gradient
    const id = 'dsrg_'+Math.random().toString(36).slice(2);
    const ds = M('radialGradient',{id, cx:'40%', cy:'35%', r:'70%'}, defs);
    M('stop',{offset:'0%','stop-color':sym,'stop-opacity':.95}, ds);
    M('stop',{offset:'100%','stop-color':'#0a0a0a','stop-opacity':.65}, ds);
    M('circle',{cx:R,cy:R,r:R*0.31,fill:`url(#${id})`,stroke:'#1f2937','stroke-width':Math.max(1.8,D*0.003)},g);
    M('line',{x1:R-R*0.31,y1:R,x2:R+R*0.31,y2:R,stroke:'#111','stroke-width':Math.max(7.5,D*0.012)},g);
    M('circle',{cx:R+R*0.11,cy:R-R*0.09,r:R*0.065,fill:'#101214',stroke:'#3b3f48','stroke-width':Math.max(1.4,D*0.0022)},g);
    for(let i=0;i<12;i++){ const a=i*15*Math.PI/180, r1=R*0.16, r2=R*0.31;
      M('line',{x1:R+r1*Math.cos(a),y1:R+r1*Math.sin(a),x2:R+r2*Math.cos(a),y2:R+r2*Math.sin(a),stroke:'#27303d','stroke-width':Math.max(1.1,D*0.0019),'stroke-linecap':'round'},g);
    }
    M('path',{d:`M ${R-R*0.2} ${R+R*0.22} A ${R*0.2} ${R*0.2} 0 0 0 ${R+R*0.2} ${R+R*0.22}`,stroke:'#27303d','stroke-width':Math.max(1.1,D*0.0019),fill:'none'},g);
  } else if(ms.includes('jedi')){
    M('path',{d:`M${R} ${R-0.22*D} L${R+0.035*D} ${R-0.26*D} L${R+0.035*D} ${R}
      L${R+0.07*D} ${R+0.028*D} L${R+0.035*D} ${R+0.056*D} L${R+0.035*D} ${R+0.29*D}
      L${R} ${R+0.23*D} L${R-0.035*D} ${R+0.29*D} L${R-0.035*D} ${R+0.056*D}
      L${R-0.07*D} ${R+0.028*D} L${R-0.035*D} ${R} L${R-0.035*D} ${R-0.26*D} Z`,fill:sym,filter:'url(#softGlow)'},g);
  } else {
    M('polygon',{points:
      `${R},${R-0.26*D} ${R+0.06*D},${R-0.15*D} ${R+0.11*D},${R-0.14*D} ${R+0.05*D},${R-0.01*D}
       ${R+0.07*D},${R+0.07*D} ${R},${R+0.03*D} ${R-0.07*D},${R+0.07*D} ${R-0.05*D},${R-0.01*D}
       ${R-0.11*D},${R-0.14*D} ${R-0.06*D},${R-0.15*D}`, fill:sym,filter:'url(#softGlow)'},g);
  }

  // ---- Sabers (with soft glow filter) ----
  const glowLine = (x1,y1,x2,y2)=>{
    const path = M('g',{filter:'url(#softGlow)'});
    M('line',{x1,y1,x2,y2,stroke:'#7dd3fc','stroke-opacity':.24,'stroke-width':Math.max(10,D*0.018)},path);
    M('line',{x1,y1,x2,y2,stroke:'#ffffff','stroke-width':Math.max(3,D*0.005)},path);
  };
  const s=(v.sabers_desc||'').toLowerCase();
  if(s.includes('cross')||/\bx\b/.test(s)){ glowLine(R-0.28*D,R-0.28*D,R+0.28*D,R+0.28*D); glowLine(R+0.28*D,R-0.28*D,R-0.28*D,R+0.28*D); }
  else if(s.includes('three')||/\b3\b/.test(s)){ glowLine(R-0.31*D,R+0.37*D,R+0.31*D,R+0.37*D); glowLine(R-0.22*D,R+0.40*D,R+0.12*D,R+0.12*D); glowLine(R+0.22*D,R+0.40*D,R-0.12*D,R+0.12*D); }
  else{ glowLine(R,R-0.12*D,R,R+0.40*D); }

  // ---- Aurebesh ring (lighter) ----
  const aure=(v.aurebesh_style||'').toLowerCase();
  if(aure.includes('glow')||aure.includes('aurebesh')||aure.includes('rune')||aure.includes('inscription')){
    M('circle',{cx:R,cy:R,r:R*0.68,fill:'none',stroke:'#7dd3fc','stroke-width':Math.max(1.8,D*0.003),'stroke-dasharray':'6 6','stroke-opacity':.66,filter:'url(#softGlow)'});
  }

  return svg;
}
  function mount(svg){
    svg.querySelectorAll('path,rect,circle,ellipse,line,polyline,polygon').forEach(el=>{
      if(!el.hasAttribute('vector-effect')) el.setAttribute('vector-effect','non-scaling-stroke');
    });
    inner.innerHTML=''; inner.appendChild(svg);
  }

  function buildPrompt(v){
    return [
      "Cinematic medallion pendant design.",
      `• Shape & Base: Round pendant, ${v.rim_finish}, plate in ${v.plate_color}.`,
      `• Text: Raised lettering “${v.text_top}” in ${v.text_colors}.`,
      `• Central Motif: ${v.state_shape} (${v.outline_color}) with ${v.main_symbol} (${v.symbol_color}). Elements: ${v.badge_elements}${v.secondary_symbol?`. Secondary: ${v.secondary_symbol}`:''}.`,
      `• Aurebesh: ${v.aurebesh_style}.`,
      `• Lightsabers: ${v.sabers_desc}.`,
      `• Style: ${v.style_keywords}.`
    ].join("\n");
  }

  function generate(){
    form = readForm(); safeLS.set(LS_FORM, JSON.stringify(form));
    byId('out').value = buildPrompt(form);
    const svg=buildSvg(form); mount(svg); renderPreview();
    byId('live').textContent='Preview updated';
  }

  /* Export helpers */
  const svgXml=()=>{
    const svg=inner.querySelector('svg'); if(!svg) return null;
    const clone=svg.cloneNode(true);
    const g=document.createElementNS(NS,'g'); while(clone.firstChild) g.appendChild(clone.firstChild);
    g.setAttribute('transform',`rotate(${view.rot} ${view.w/2} ${view.h/2})`); clone.appendChild(g);
    clone.setAttribute('xmlns',NS);
    return `<?xml version="1.0" encoding="UTF-8"?>\n`+clone.outerHTML;
  };
  byId('copySvgBtn').addEventListener('click',()=>{ const xml=svgXml(); if(!xml) return toast('Nothing to copy',true); navigator.clipboard?.writeText(xml).then(()=>toast('SVG copied')); });
  byId('downloadSvgBtn').addEventListener('click',()=>{
    const xml=svgXml(); if(!xml) return toast('Nothing to export',true);
    const u=URL.createObjectURL(new Blob([xml],{type:'image/svg+xml'})); const a=document.createElement('a'); a.href=u; a.download='medallion.svg'; a.click(); setTimeout(()=>URL.revokeObjectURL(u),1000); toast('SVG downloaded');
  });
  byId('downloadPngBtn').addEventListener('click',()=>{
    const xml=svgXml(); if(!xml) return toast('Nothing to export',true);
    const url=URL.createObjectURL(new Blob([xml],{type:'image/svg+xml'}));
    const img=new Image(); img.onload=()=>{
      const c=document.createElement('canvas'); c.width=view.w*2; c.height=view.h*2;
      const ctx=c.getContext('2d'); ctx.setTransform(2,0,0,2,0,0); ctx.drawImage(img,0,0); URL.revokeObjectURL(url);
      c.toBlob(b=>{ if(!b) return toast('PNG failed',true); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`medallion_${view.w}x${view.h}.png`; a.click(); setTimeout(()=>URL.revokeObjectURL(u),1000); toast('PNG downloaded'); },'image/png');
    }; img.crossOrigin='anonymous'; img.src=url;
  });
  byId('copyBtn').addEventListener('click',()=>navigator.clipboard?.writeText(byId('out').value||'').then(()=>toast('Copied')));
  byId('downloadBtn').addEventListener('click',()=>{ const u=URL.createObjectURL(new Blob([byId('out').value||''],{type:'text/plain'})); const a=document.createElement('a'); a.href=u; a.download='medallion_prompt.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(u),1000); toast('TXT downloaded'); });

  /* JSON modal */
  const modal=byId('jsonModal');
  byId('exportJsonBtn').addEventListener('click',()=>{ byId('jsonArea').value=JSON.stringify({form, presets:getPresets()}, null, 2); modal.showModal(); });
  byId('importJsonBtn').addEventListener('click',()=>{ byId('jsonArea').value=''; modal.showModal(); });
  byId('applyJson').addEventListener('click',()=>{
    try{
      const obj=JSON.parse(byId('jsonArea').value||'{}');
      if(obj.form){ writeForm({...defaultForm(), ...obj.form}); }
      if(Array.isArray(obj.presets)){ safeLS.set(LS_PRESETS, JSON.stringify(obj.presets)); }
      renderPresets(); generate(); modal.close(); toast('JSON applied');
    }catch{ toast('Invalid JSON',true); }
  });
  byId('copyJson').addEventListener('click',()=>navigator.clipboard?.writeText(byId('jsonArea').value||'').then(()=>toast('Copied')));
  byId('closeJson').addEventListener('click',()=>modal.close());

  /* Random & Clear */
  byId('randBtn').addEventListener('click',()=>{
    const pick=a=>a[Math.floor(Math.random()*a.length)];
    const v={...form};
    v.rim_finish=pick(['polished steel','brushed silver','gold','bronze']);
    v.plate_color=pick(['black','navy','crimson','gray','white']);
    v.text_colors=pick(['white with black outline','gold','silver','cyan','red']);
    v.main_symbol=pick(['Death Star','Jedi crest']);
    v.sabers_desc=pick(['two crossed sabers glow','three angled beams glow','single vertical saber glow']);
    v.flip_arc=pick(['auto','normal','flipped']);
    writeForm(v); generate(); toast('Randomized');
  });
  byId('clearBtn').addEventListener('click',()=>{ writeForm(defaultForm()); generate(); toast('Cleared'); });

  /* Inputs -> live generate (debounced) */
  const debounced=(fn,ms=120)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
  FIELDS.forEach(id=>{ const el=byId(id); if(!el) return; ['input','change'].forEach(ev=>el.addEventListener(ev,debounced(()=>generate(),80))); });

  /* Shortcuts */
  addEventListener('keydown',e=>{
    if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); generate(); }
    if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='c' && document.activeElement.id==='out'){ e.preventDefault(); navigator.clipboard?.writeText(byId('out').value||'').then(()=>toast('Copied')); }
  },{passive:false});
  byId('gen').addEventListener('click',generate);

  /* Boot */
  renderPresets(); writeForm(form); byId('sizeSelect').dispatchEvent(new Event('change')); generate(); setTimeout(()=>fit(),60);
})();
</script>
</body>
</html>