
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Medallion Forge — Badge Builder</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151923; --ink:#e8ecf1; --muted:#a0a8b8; --line:#252b39;
    --accent:#6ee7ff; --accent-2:#7c8cff; --danger:#ff5c5c; --ok:#4ade80;
    --mono: ui-monospace,Menlo,Consolas,monospace;
    --sans: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f7fb; --panel:#ffffff; --ink:#0e1218; --muted:#5b6472; --line:#e6e8ef; --accent:#0ea5e9; --accent-2:#6366f1; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg, var(--bg) 0%, #0b0d13 100%);color:var(--ink);font:14px/1.5 var(--sans)}
  a{color:var(--accent)}
  .wrap{
    display:grid; gap:16px; padding:16px; max-width:1200px; margin:0 auto;
    grid-template-columns: 380px 1fr;
  }
  @media (max-width: 960px){
    .wrap{grid-template-columns:1fr}
  }
  header{grid-column:1/-1; display:flex; gap:12px; align-items:center; justify-content:space-between}
  .brand{display:flex; gap:10px; align-items:center}
  .badge{width:28px; height:28px; border-radius:50%; background:radial-gradient(circle at 30% 30%, var(--accent), var(--accent-2)); box-shadow:0 0 0 2px #0004, inset 0 0 16px #0006}
  h1{margin:0;font-size:18px;letter-spacing:.3px}
  .panel{
    background:linear-gradient(180deg, var(--panel), color-mix(in srgb, var(--panel) 92%, black));
    border:1px solid var(--line); border-radius:12px; padding:14px;
    box-shadow: 0 2px 12px #0004;
  }
  .controls{display:grid; gap:12px; align-content:start; position:relative}
  .section{border:1px dashed var(--line); border-radius:10px; padding:12px}
  .section h3{margin:0 0 8px 0; font-size:13px; letter-spacing:.2px; color:var(--muted)}
  .row{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
  .row-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px}
  .field{display:flex; flex-direction:column; gap:6px}
  label{font-size:12px; color:var(--muted)}
  input[type="text"], input[type="number"], select, textarea{
    background:#0b0e14; color:var(--ink); border:1px solid var(--line); border-radius:8px; padding:10px 10px; outline:none;
  }
  input[type="color"]{height:36px; padding:0; border-radius:8px; border:1px solid var(--line); background:#0b0e14}
  input[type="checkbox"]{transform:translateY(2px)}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 12px; border-radius:10px; border:1px solid var(--line);
    background:#0b0e14; color:var(--ink); cursor:pointer; user-select:none;
  }
  .btn.primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:white; border-color:transparent}
  .btn.ghost{background:transparent}
  .btn:active{transform:translateY(1px)}
  .stack{display:flex; gap:8px; flex-wrap:wrap}
  .profiles{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  @media (max-width:960px){ .profiles{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:520px){ .profiles{grid-template-columns:1fr} }
  .card{
    padding:10px; border:1px solid var(--line); border-radius:10px; cursor:pointer; position:relative; overflow:hidden;
    background:linear-gradient(180deg,#0b0e14,#0c111a);
  }
  .card:hover{outline:1px solid color-mix(in srgb, var(--accent) 60%, transparent)}
  .card h4{margin:0 0 4px 0; font-size:13px}
  .card p{margin:0; font-size:12px; color:var(--muted)}
  .previewWrap{position:relative}
  .previewBar{display:flex; gap:8px; justify-content:space-between; align-items:center; margin-bottom:10px}
  #svgStage{
    width:100%; aspect-ratio:1/1; display:block; border-radius:12px; background:#0b0e14;
    border:1px solid var(--line); box-shadow: inset 0 0 40px #0007;
  }
  .hint{font-size:12px; color:var(--muted)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .kvs{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%); padding:10px 14px;
    background:#0b0e14; color:var(--ink); border:1px solid var(--line); border-radius:999px; box-shadow:0 6px 30px #0008;
    opacity:0; pointer-events:none; transition:.25s ease; font-size:13px;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}
  /* Tight mobile spacing */
  @media (max-width:420px){
    .row, .row-3{grid-template-columns:1fr}
    .previewBar{flex-direction:column; align-items:stretch}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="badge" aria-hidden="true"></div>
        <h1>Medallion Forge — Imperial Badge Builder</h1>
      </div>
      <div class="stack">
        <button class="btn" id="toggleTheme" title="Toggle theme">Theme</button>
        <button class="btn ghost" id="resetAll">Reset</button>
      </div>
    </header>

    <!-- LEFT: Controls -->
    <aside class="panel controls" aria-label="Controls">
      <div class="section">
        <h3>Profile presets</h3>
        <div class="profiles" id="profiles"></div>
      </div>

      <div class="section">
        <h3>Text & Rings</h3>
        <div class="row">
          <div class="field">
            <label for="titleText">Top text</label>
            <input id="titleText" type="text" placeholder="SAINT CLOUD JEDI" value="SAINT CLOUD JEDI">
          </div>
          <div class="field">
            <label for="titleFontSize">Font size (px)</label>
            <input id="titleFontSize" type="number" min="10" max="120" value="26">
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="subtitleText">Aurebesh rim (optional)</label>
            <input id="subtitleText" type="text" placeholder="AUREBESH · IMPERIAL · INSIGNIA">
          </div>
          <div class="field">
            <label for="subtitleSize">Aurebesh size (px)</label>
            <input id="subtitleSize" type="number" min="8" max="40" value="12">
          </div>
        </div>
        <div class="row-3">
          <div class="field"><label>Rim color</label><input id="rimColor" type="color" value="#ffffff"></div>
          <div class="field"><label>Plate color</label><input id="plateColor" type="color" value="#0b0e14"></div>
          <div class="field"><label>Ink color</label><input id="inkColor" type="color" value="#ffffff"></div>
        </div>
        <div class="row">
          <div class="field kvs">
            <label for="diameter">Diameter (px)</label>
            <input id="diameter" type="number" min="200" max="1400" value="640">
          </div>
          <div class="field kvs">
            <label><input id="showBail" type="checkbox" checked> Bail loop</label>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Center motif</h3>
        <div class="row">
          <div class="field">
            <label for="motif">Preset</label>
            <select id="motif">
              <option value="deathstar">Death Star + Florida (simplified)</option>
              <option value="deathstar_basic">Death Star only</option>
              <option value="custom">Custom SVG upload</option>
            </select>
          </div>
          <div class="field">
            <label for="motifScale">Motif scale (%)</label>
            <input id="motifScale" type="number" min="20" max="120" value="72">
          </div>
        </div>
        <div class="row-3">
          <div class="field"><label>Death Star color</label><input id="dsColor" type="color" value="#ff2a2a"></div>
          <div class="field"><label>Dish/lines</label><input id="dsStroke" type="color" value="#111111"></div>
          <div class="field"><label>Florida outline</label><input id="flColor" type="color" value="#ffffff"></div>
        </div>
        <div class="row">
          <div class="field kvs">
            <label><input id="showArmyStar" type="checkbox" checked> US Army star overlay (gold)</label>
          </div>
          <div class="field">
            <label for="customSvg">Custom center SVG (if chosen)</label>
            <input id="customSvg" type="file" accept=".svg">
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Lightsabers</h3>
        <div class="row">
          <div class="field">
            <label for="saberCount">Count</label>
            <select id="saberCount">
              <option>0</option><option>1</option><option>2</option><option selected>3</option>
            </select>
          </div>
          <div class="field">
            <label for="saberGlow">Glow strength</label>
            <input id="saberGlow" type="number" min="0" max="16" value="6">
          </div>
        </div>
        <div class="row-3">
          <div class="field"><label>Primary core</label><input id="sCore" type="color" value="#ffffff"></div>
          <div class="field"><label>Primary aura</label><input id="sAura" type="color" value="#ff2a2a"></div>
          <div class="field"><label>Secondary aura</label><input id="sAura2" type="color" value="#ffebeb"></div>
        </div>
      </div>

      <div class="section">
        <h3>Export</h3>
        <div class="toolbar">
          <button class="btn" id="copySvg">Copy SVG</button>
          <button class="btn" id="downloadSvg">Download SVG</button>
          <button class="btn" id="downloadPng">Download PNG</button>
        </div>
        <p class="hint">PNG export rasterizes the current preview at device pixel ratio for crisp output.</p>
      </div>
    </aside>

    <!-- RIGHT: Preview -->
    <main class="panel previewWrap" aria-label="Preview">
      <div class="previewBar">
        <div class="stack">
          <button class="btn" id="centerFit">Center / Fit</button>
          <button class="btn" id="resetZoom">Reset Zoom</button>
        </div>
        <div class="hint" id="meta">640×640 • live</div>
      </div>
      <div id="svgStage"></div>
    </main>
  </div>

  <div class="toast" id="toast">Copied!</div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const toRad = (deg) => deg * Math.PI / 180;

  const state = {
    customCenterSvgText: null,
    profiles: [
      {
        id:'imperial_badge',
        name:'Imperial Badge',
        note:'Cinematic badge, Aurebesh rim, 3 sabers',
        values:{
          titleText:'SAINT CLOUD JEDI',
          titleFontSize:26,
          subtitleText:'AUREBESH · IMPERIAL · INSIGNIA',
          subtitleSize:12,
          rimColor:'#ffffff', plateColor:'#0b0e14', inkColor:'#ffffff',
          diameter:640, showBail:true,
          motif:'deathstar', motifScale:72,
          dsColor:'#ff2a2a', dsStroke:'#111111', flColor:'#ffffff', showArmyStar:true,
          saberCount:'3', saberGlow:6, sCore:'#ffffff', sAura:'#ff2a2a', sAura2:'#ffebeb',
        }
      },
      {
        id:'detroit_jedi',
        name:'Detroit Jedi',
        note:'Red theme, bold sabers',
        values:{
          titleText:'DETROIT JEDI',
          titleFontSize:28,
          subtitleText:'',
          subtitleSize:12,
          rimColor:'#ffffff', plateColor:'#0b0e14', inkColor:'#ffffff',
          diameter:720, showBail:true,
          motif:'deathstar_basic', motifScale:70,
          dsColor:'#ff2a2a', dsStroke:'#0e1117', flColor:'#ffffff', showArmyStar:false,
          saberCount:'3', saberGlow:10, sCore:'#ffffff', sAura:'#ff2a2a', sAura2:'#ffd2d2',
        }
      },
      {
        id:'army_florida',
        name:'Army · Florida',
        note:'Gold star overlay',
        values:{
          titleText:'SAINT CLOUD JEDI',
          titleFontSize:24,
          subtitleText:'SERVICE · HONOR · DUTY',
          subtitleSize:12,
          rimColor:'#ffffff', plateColor:'#0b0e14', inkColor:'#ffffff',
          diameter:640, showBail:true,
          motif:'deathstar', motifScale:68,
          dsColor:'#e52424', dsStroke:'#111111', flColor:'#ffffff', showArmyStar:true,
          saberCount:'2', saberGlow:6, sCore:'#ffffff', sAura:'#ffcc00', sAura2:'#ffe9a6',
        }
      }
    ]
  };

  // Build profile cards
  const profileHost = $('#profiles');
  state.profiles.forEach(p => {
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `<h4>${p.name}</h4><p>${p.note}</p>`;
    el.addEventListener('click', () => applyProfile(p.values));
    profileHost.appendChild(el);
  });

  // Map form controls
  const C = {
    titleText: $('#titleText'),
    titleFontSize: $('#titleFontSize'),
    subtitleText: $('#subtitleText'),
    subtitleSize: $('#subtitleSize'),
    rimColor: $('#rimColor'),
    plateColor: $('#plateColor'),
    inkColor: $('#inkColor'),
    diameter: $('#diameter'),
    showBail: $('#showBail'),
    motif: $('#motif'),
    motifScale: $('#motifScale'),
    dsColor: $('#dsColor'),
    dsStroke: $('#dsStroke'),
    flColor: $('#flColor'),
    showArmyStar: $('#showArmyStar'),
    customSvg: $('#customSvg'),
    saberCount: $('#saberCount'),
    saberGlow: $('#saberGlow'),
    sCore: $('#sCore'),
    sAura: $('#sAura'),
    sAura2: $('#sAura2'),
  };

  Object.values(C).forEach(inp => inp.addEventListener('input', scheduleRender));
  C.customSvg.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    if (f.type !== 'image/svg+xml') { toast('Please upload an .svg file'); return; }
    const txt = await f.text();
    state.customCenterSvgText = sanitizeSvg(txt);
    render();
  });

  // Theme + reset
  $('#toggleTheme').addEventListener('click', () => {
    const dark = document.documentElement.dataset.theme !== 'light';
    if (dark) document.documentElement.dataset.theme = 'light';
    else document.documentElement.dataset.theme = 'dark';
  });
  $('#resetAll').addEventListener('click', () => { applyProfile(state.profiles[0].values); });

  // ---------- SVG Generator ----------
  function buildSvg(opts){
    const D = +opts.diameter;
    const R = D/2;
    const rim = opts.rimColor, plate = opts.plateColor, ink = opts.inkColor;
    const title = (opts.titleText||'').toUpperCase();
    const tSize = +opts.titleFontSize;
    const sub = (opts.subtitleText||'');
    const subSize = +opts.subtitleSize;
    const showBail = !!opts.showBail;

    // Build root SVG
    const svgns = 'http://www.w3.org/2000/svg';
    const svg = document.createElementNS(svgns,'svg');
    svg.setAttribute('xmlns', svgns);
    svg.setAttribute('viewBox', `0 0 ${D} ${D}`);
    svg.setAttribute('width', D);
    svg.setAttribute('height', D);

    // Defs: filters & paths
    const defs = el('defs');
    // Glow filter for sabers
    const glow = el('filter', {id:'glow', x:'-50%', y:'-50%', width:'200%', height:'200%'});
    glow.append(
      el('feGaussianBlur', {in:'SourceGraphic', stdDeviation: opts.saberGlow||6, result:'blur'}),
      el('feMerge', {}).appendChild(el('feMergeNode', {in:'blur'}))
    );
    defs.appendChild(glow);

    // Text paths for arcs
    const arcTopId = 'arcTop';
    const arcTop = describeArc(R, R, R*0.72, 200, -20); // top arc
    defs.appendChild(el('path', {id:arcTopId, d:arcTop}));
    if (sub){
      const arcSubId = 'arcSub';
      const arcSub = describeArc(R, R, R*0.86, 210, -30);
      defs.appendChild(el('path', {id:arcSubId, d:arcSub}));
    }
    svg.appendChild(defs);

    // Background plate + rim
    // Rim
    svg.appendChild(el('circle', {cx:R, cy:R, r:R*0.98, fill:rim}));
    // Inner plate
    svg.appendChild(el('circle', {cx:R, cy:R, r:R*0.9, fill:plate}));

    // Bail loop (top)
    if (showBail){
      svg.appendChild(el('rect', {x:R-18, y:8, width:36, height:24, rx:6, fill:rim}));
      svg.appendChild(el('circle', {cx:R, cy:20, r:8, fill:plate}));
    }

    // Title along top arc
    if (title){
      const txt = el('text', {fill:ink, 'font-size':tSize, 'font-family':'Arial, Helvetica, sans-serif', 'letter-spacing':1.5, 'text-anchor':'middle'});
      const textPath = el('textPath', {'href':'#'+arcTopId, startOffset:'50%'});
      textPath.textContent = title;
      txt.appendChild(textPath);
      svg.appendChild(txt);
    }
    // Aurebesh rim (render as normal characters unless user pastes Aurebesh glyphs)
    if (sub){
      const st = el('text', {fill:ink, 'font-size':subSize, 'font-family':'Arial, Helvetica, sans-serif', 'letter-spacing':2, 'text-anchor':'middle', opacity:.8});
      const tp = el('textPath', {'href':'#arcSub', startOffset:'50%'});
      tp.textContent = sub;
      st.appendChild(tp); svg.appendChild(st);
    }

    // Center motif group
    const g = el('g', {transform:`translate(${R},${R}) scale(${(+opts.motifScale||70)/100})`});
    // death star (basic)
    if (opts.motif === 'deathstar' || opts.motif === 'deathstar_basic'){
      g.appendChild(deathStar(opts));
      if (opts.motif === 'deathstar'){
        g.appendChild(floridaOutline(opts)); // simplified silhouette
      }
    } else if (opts.motif === 'custom'){
      const svgtxt = state.customCenterSvgText;
      if (svgtxt){
        const frag = stringToFragment(svgtxt);
        // normalize center
        const box = el('rect', {x:-150,y:-150,width:300,height:300,fill:'none',stroke:'none'});
        g.appendChild(box);
        g.appendChild(frag);
      }
    }

    if (opts.showArmyStar) g.appendChild(armyStar());

    // Lightsabers
    const sabers = parseInt(opts.saberCount||0,10);
    if (sabers>0){
      const saberGroup = el('g', {'filter':'url(#glow)'});
      const angles = sabers===1 ? [0] : sabers===2 ? [-22, 22] : [-28, 0, 28];
      angles.forEach((ang,i) => {
        saberGroup.appendChild(lightsaber(ang, i, opts));
      });
      svg.appendChild(saberGroup);
    }

    svg.appendChild(g);
    return svg;

    // ---- element helpers ----
    function el(name, attrs={}){
      const node = document.createElementNS(svgns, name);
      for (const [k,v] of Object.entries(attrs)) node.setAttribute(k, v);
      return node;
    }
    function stringToFragment(s){
      // very simple parser for safe inline
      const tmp = document.createElement('div'); tmp.innerHTML = s;
      const svg = tmp.querySelector('svg'); return svg ? svg : tmp.firstElementChild;
    }
    function deathStar(o){
      const s = el('g', {transform:'translate(0,10)'});
      const base = el('circle', {cx:0, cy:0, r:120, fill:o.dsColor, stroke:o.dsStroke, 'stroke-width':4});
      s.appendChild(base);
      // panel rings
      [80, 40, -10].forEach((y,idx) => {
        s.appendChild(el('ellipse', {cx:0, cy:y*0.7, rx:120 - idx*10, ry:14, fill:'none', stroke:o.dsStroke, 'stroke-width':3, opacity:.9}));
      });
      // trench
      s.appendChild(el('rect', {x:-120, y:-8, width:240, height:16, fill:o.dsStroke, opacity:.9}));
      // dish
      s.appendChild(el('circle', {cx:36, cy:-36, r:28, fill:'#00000020', stroke:o.dsStroke, 'stroke-width':3}));
      s.appendChild(el('circle', {cx:36, cy:-36, r:12, fill:'#00000010', stroke:o.dsStroke, 'stroke-width':2}));
      return s;
    }
    function floridaOutline(o){
      // Simplified path (stylized silhouette)
      const path = "M -110,-90 C -80,-120, -30,-110, 10,-90 C 40,-70, 60,-20, 80,10 C 45,5, 35,-5, 18,-8 C 2,-10, -5,5, -18,8 C -38,12, -64,2, -92,-8 Z";
      const g = el('g', {opacity:.9});
      g.appendChild(el('path', {d:path, fill:'none', stroke:o.flColor, 'stroke-width':5}));
      return g;
    }
    function armyStar(){
      const g = el('g', {transform:'translate(0,-6) scale(0.7)'});
      const poly = starPoints(0,0,80,38,5);
      g.appendChild(el('polygon', {points:poly, fill:'none', stroke:'#d4af37', 'stroke-width':6}));
      return g;
    }
    function starPoints(cx, cy, outerR, innerR, points){
      let str = '';
      const step = Math.PI / points;
      for (let i=0;i<2*points;i++){
        const r = (i%2===0) ? outerR : innerR;
        const a = i * step - Math.PI/2;
        const x = cx + r * Math.cos(a), y = cy + r * Math.sin(a);
        str += `${x},${y} `;
      }
      return str.trim();
    }
    function lightsaber(angleDeg, idx, o){
      const g = el('g', {transform:`translate(${D*0.22}, ${D*0.78}) rotate(${angleDeg})`});
      // hilt
      g.appendChild(el('rect', {x:-16, y:-10, width:32, height:20, rx:3, fill:'#9aa3af'}));
      g.appendChild(el('rect', {x:16, y:-8, width:16, height:16, rx:3, fill:'#606874'}));
      // blade (core + aura stroke)
      const bladeLen = D*0.55;
      const blade = el('rect', {x:32, y:-4, width:bladeLen, height:8, rx:4, fill:o.sCore, stroke:o.sAura, 'stroke-width':6});
      g.appendChild(blade);
      return g;
    }
    // describe circular arc (SVG path)
    function describeArc(cx, cy, r, startAngle, endAngle){
      const start = polarToCartesian(cx,cy,r,endAngle);
      const end   = polarToCartesian(cx,cy,r,startAngle);
      const large = endAngle - startAngle <= 180 ? 0 : 1;
      return ["M", start.x, start.y, "A", r, r, 0, large, 0, end.x, end.y].join(" ");
    }
    function polarToCartesian(cx,cy,r,angle){
      const a = toRad(angle);
      return {x: cx + r*Math.cos(a), y: cy + r*Math.sin(a)};
    }
  }

  // ---------- Render Loop ----------
  const stage = $('#svgStage');
  function read(){
    return {
      titleText: C.titleText.value,
      titleFontSize: +C.titleFontSize.value,
      subtitleText: C.subtitleText.value,
      subtitleSize: +C.subtitleSize.value,
      rimColor: C.rimColor.value,
      plateColor: C.plateColor.value,
      inkColor: C.inkColor.value,
      diameter: +C.diameter.value,
      showBail: C.showBail.checked,
      motif: C.motif.value,
      motifScale: +C.motifScale.value,
      dsColor: C.dsColor.value,
      dsStroke: C.dsStroke.value,
      flColor: C.flColor.value,
      showArmyStar: C.showArmyStar.checked,
      saberCount: C.saberCount.value,
      saberGlow: +C.saberGlow.value,
      sCore: C.sCore.value,
      sAura: C.sAura.value,
      sAura2: C.sAura2.value
    };
  }
  function render(){
    const v = read();
    const svg = buildSvg(v);
    stage.innerHTML = '';
    stage.appendChild(svg);
    $('#meta').textContent = `${v.diameter}×${v.diameter} • live`;
    lastSvg = svg;
  }
  let raf = 0;
  function scheduleRender(){ cancelAnimationFrame(raf); raf = requestAnimationFrame(render); }

  function applyProfile(val){
    Object.entries(val).forEach(([k,v])=>{
      if (typeof C[k] === 'undefined') return;
      if (C[k].type === 'checkbox') C[k].checked = !!v;
      else C[k].value = v;
    });
    render();
    toast('Profile loaded');
  }

  // ---------- Export ----------
  let lastSvg = null;
  $('#copySvg').addEventListener('click', async () => {
    if (!lastSvg) return;
    const xml = toXml(lastSvg);
    try { await navigator.clipboard.writeText(xml); toast('SVG copied'); }
    catch { toast('Copy failed'); }
  });
  $('#downloadSvg').addEventListener('click', () => {
    if (!lastSvg) return;
    const xml = toXml(lastSvg);
    download('medallion.svg', new Blob([xml], {type:'image/svg+xml'}));
  });
  $('#downloadPng').addEventListener('click', async () => {
    if (!lastSvg) return;
    const xml = toXml(lastSvg);
    const url = URL.createObjectURL(new Blob([xml], {type:'image/svg+xml'}));
    const img = new Image();
    const scale = Math.min(Math.max(window.devicePixelRatio||1, 1), 3);
    img.onload = () => {
      const w = lastSvg.viewBox.baseVal.width, h = lastSvg.viewBox.baseVal.height;
      const canvas = document.createElement('canvas'); canvas.width = w*scale; canvas.height = h*scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => download('medallion.png', blob), 'image/png');
      URL.revokeObjectURL(url);
    };
    img.src = url;
  });
  function toXml(svgEl){
    // clone to ensure inline styles/attributes are preserved
    const clone = svgEl.cloneNode(true);
    // ensure xmlns
    clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    return `<?xml version="1.0" encoding="UTF-8"?>\n` + clone.outerHTML;
  }
  function download(name, blob){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = name; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  // ---------- Zoom / Fit ----------
  $('#centerFit').addEventListener('click', () => {
    stage.scrollIntoView({behavior:'smooth', block:'center'});
  });
  $('#resetZoom').addEventListener('click', () => {
    stage.style.transform = 'none';
  });

  // ---------- Sanitize ----------
  function sanitizeSvg(txt){
    // strip scripts and event handlers
    return txt
      .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'')
      .replace(/\son[a-z]+\s*=\s*(['"]).*?\1/gi,'');
  }

  // ---------- Toast ----------
  const toastEl = $('#toast');
  function toast(msg){
    toastEl.textContent = msg; toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 1400);
  }

  // Init
  applyProfile(state.profiles[0].values);
})();
</script>
</body>
</html>
