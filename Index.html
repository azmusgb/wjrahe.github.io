<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="dark light" />
<title>Medallion Prompt Builder — Ultimate</title>

<!-- Fonts (swap to avoid FOIT on mobile) -->
<link href="https://fonts.cdnfonts.com/css/aurebesh" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet" />

<style>
  :root{
    --bg:#0b0d13; --panel:#151923; --ink:#e8ecf1; --muted:#9aa3af;
    --accent:#6ee7ff; --accent-2:#6476ff; --accent-glow:rgba(110,231,255,.35);
    --line:#252b39; --success:#4ade80; --warning:#fbbf24; --danger:#f87171;
    --mono:"JetBrains Mono","Fira Code",ui-monospace,Menlo,Consolas,monospace;
    --sans:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    --aurebesh:'Aurebesh', var(--sans); --radius:16px; --shadow:0 12px 32px rgba(0,0,0,.28);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f5f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent-2:#22d3ee; --accent-glow:rgba(37,99,235,.25); --line:#e5e7eb; --success:#16a34a; --warning:#d97706; --danger:#dc2626;}
  }
  .light-theme{
    --bg:#f5f7fb; --panel:#fff; --ink:#0f172a; --muted:#64748b;
    --accent:#2563eb; --accent-2:#22d3ee; --accent-glow:rgba(37,99,235,.25); --line:#e5e7eb; --success:#16a34a; --warning:#d97706; --danger:#dc2626;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 var(--sans);
    -webkit-text-size-adjust:100%; /* iOS zoom quirks */
    overflow-x:hidden;
  }

  header{
    position:sticky;top:0;z-index:9;padding:14px 18px;border-bottom:1px solid var(--line);
    background:color-mix(in oklab, var(--bg) 92%, black 8%);backdrop-filter:blur(6px);
    display:flex;align-items:center;justify-content:space-between
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;
    background:linear-gradient(135deg,var(--accent) 0%,var(--accent-2) 100%);box-shadow:0 0 18px var(--accent-glow)}
  .pill{padding:3px 8px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-size:11px;font-weight:700}
  .theme-toggle{border:1px solid var(--line);color:var(--muted);background:var(--panel);border-radius:10px;padding:6px 10px;display:flex;gap:6px;align-items:center;cursor:pointer}
  .theme-toggle:hover{border-color:var(--accent);color:var(--accent)}

  /* App layout: Profiles | Builder | Output */
  .app{
    max-width:1400px;margin:22px auto;padding:0 16px;display:grid;gap:18px;
    grid-template-columns:280px 1fr 1fr;align-items:start
  }
  @media (max-width:1200px){ .app{grid-template-columns:1fr 1fr} .aside{grid-column:1/-1;order:-1} }
  @media (max-width:800px){ .app{grid-template-columns:1fr} .aside{order:-1} }

  .card{background:color-mix(in oklab, var(--panel) 98%, black 2%);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .card h2{font-size:14px;margin:0 0 10px 0;letter-spacing:.2px;display:flex;align-items:center;gap:6px;color:color-mix(in oklab,var(--ink) 85%, var(--muted) 15%)}
  .subtle{color:var(--muted);font-size:12px}

  .profiles{display:grid;gap:10px}
  .profile{
    display:grid;grid-template-columns:56px 1fr;gap:10px;align-items:center;
    border:1px solid var(--line);border-radius:12px;padding:10px;background:var(--panel);cursor:pointer;transition:.2s;
  }
  .profile:hover{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
  .thumb{width:56px;height:56px;border-radius:10px;background:radial-gradient(100% 100% at 25% 20%, var(--accent) 0%, var(--accent-2) 100%);display:grid;place-items:center;color:#fff;font-weight:800}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:color-mix(in oklab,var(--accent) 25%, transparent);color:var(--accent);font-size:10px;font-weight:700}

  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);padding-bottom:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;border:1px solid transparent;background:transparent;color:var(--muted);cursor:pointer}
  .tab[aria-selected="true"]{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:600px){ .grid{grid-template-columns:1fr} }

  .row{display:grid;gap:6px}
  label{font-size:12px;font-weight:700;color:color-mix(in oklab, var(--ink) 85%, var(--muted) 15%)}
  input,select,textarea{
    width:100%;padding:11px 12px;border-radius:10px;border:1px solid var(--line);
    background:color-mix(in oklab,var(--bg) 92%, black 8%);color:var(--ink);outline:none
  }
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
  textarea{min-height:200px;font:12.5px/1.55 var(--mono);resize:vertical}
  .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .btn,.chip{
    padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);
    color:var(--ink);cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:.15s;font-weight:600;min-height:40px
  }
  .btn:hover,.chip:hover{border-color:var(--accent);color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none}
  .kbd{font:11px var(--mono);border:1px solid var(--line);border-radius:6px;padding:2px 6px}

  .out-wrap{display:grid;gap:12px}
  .monobox{
    font:12.5px/1.55 var(--mono);white-space:pre-wrap;background:color-mix(in oklab,var(--bg) 92%, black 8%);
    border:1px dashed color-mix(in oklab,var(--line) 90%, black 10%);border-radius:12px;padding:14px;min-height:120px
  }
  .preview{display:grid;gap:12px;justify-items:center;border:1px solid var(--line);border-radius:14px;padding:14px;background:color-mix(in oklab,var(--panel) 96%, black 4%)}
  #svgPreview{
    width:320px;height:320px;border-radius:50%;background:radial-gradient(ellipse at center, rgba(0,0,0,.0) 55%, rgba(0,0,0,.35) 100%);
    box-shadow:0 0 28px rgba(110,231,255,.18);transition:transform .3s;will-change:transform;touch-action:manipulation; /* iOS wiggle fix */
  }
  .preview-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .zoom-btn{width:40px;height:40px;border-radius:50%;display:grid;place-items:center}

  .toast{position:fixed;bottom:20px;right:20px;z-index:50;transform:translateY(80px);opacity:0;background:var(--panel);
    border:1px solid var(--line);border-left:4px solid var(--success);border-radius:10px;padding:12px 14px;box-shadow:var(--shadow);
    display:flex;gap:8px;align-items:center;transition:.35s cubic-bezier(.2,.8,.2,1)}
  .toast.show{transform:translateY(0);opacity:1}
  .toast.error{border-left-color:var(--danger)}

  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .spinning{animation:spin 18s linear infinite}
  @media (prefers-reduced-motion: reduce){
    .spinning{animation:none !important}
    #svgPreview{transition:none}
  }

  /* Phone-first spacing */
  @media (max-width: 480px) {
    header { padding: 12px 12px; }
    .card { padding: 12px; border-radius: 14px; }
    .preview { padding: 12px; }
    #svgPreview { max-width: 100%; height: auto; }
    .monobox { font-size: 12px; line-height: 1.45; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">⚔️</div>
    <div>
      <div style="display:flex;align-items:center;gap:8px">
        <strong>Medallion Prompt Builder</strong> <span class="pill">Ultimate</span>
      </div>
      <div class="subtle">Profiles • Builder • Live SVG • Exports</div>
    </div>
  </div>
  <button id="themeToggle" class="theme-toggle" type="button" aria-pressed="false">
    <span class="material-icons" aria-hidden="true">dark_mode</span><span id="themeLabel">Dark</span>
  </button>
</header>

<main class="app">
  <!-- LEFT: Profiles -->
  <aside class="aside card">
    <h2><span class="material-icons" style="font-size:18px">view_carousel</span> Profiles</h2>
    <div class="profiles">
      <div class="profile" data-profile="fl_army"><div class="thumb">FL</div><div><strong>Florida + Army</strong><div class="subtle">Aurebesh rim • Crossed sabers</div><span class="tag">Preset</span></div></div>
      <div class="profile" data-profile="det_wings"><div class="thumb">DET</div><div><strong>Detroit + Wings</strong><div class="subtle">Sports fusion • 3 beams</div><span class="tag">Preset</span></div></div>
      <div class="profile" data-profile="jedi_generic"><div class="thumb">JEDI</div><div><strong>Galactic Jedi</strong><div class="subtle">Navy plate • Vertical glow</div><span class="tag">Preset</span></div></div>
    </div>
    <div style="margin-top:12px" class="btns">
      <button id="saveBtn" class="chip"><span class="material-icons">bookmark_add</span>Save Current</button>
      <button id="loadBtn" class="chip"><span class="material-icons">folder_open</span>Load Saved</button>
      <button id="randBtn" class="chip"><span class="material-icons">casino</span>Randomize</button>
    </div>
  </aside>

  <!-- MIDDLE: Builder -->
  <section class="card" aria-label="Builder">
    <h2><span class="material-icons" style="font-size:18px">tune</span> Builder</h2>
    <div class="tabs" role="tablist" aria-label="Sections">
      <button class="tab" id="tab-basic" role="tab" aria-controls="panel-basic" aria-selected="true" data-tab="basic">Basic</button>
      <button class="tab" id="tab-symbols" role="tab" aria-controls="panel-symbols" aria-selected="false" data-tab="symbols" tabindex="-1">Symbols</button>
      <button class="tab" id="tab-advanced" role="tab" aria-controls="panel-advanced" aria-selected="false" data-tab="advanced" tabindex="-1">Advanced</button>
    </div>

    <div id="panel-basic" class="tab-panel" role="tabpanel" aria-labelledby="tab-basic">
      <div class="grid">
        <div class="row"><label for="text_top">Top Text</label><input id="text_top" placeholder="SAINT CLOUD JEDI"></div>
        <div class="row"><label for="rim_finish">Rim Finish</label><input id="rim_finish" placeholder="metallic silver"></div>
        <div class="row"><label for="plate_color">Plate Color</label><input id="plate_color" placeholder="black"></div>
        <div class="row"><label for="text_colors">Text Fill / Outline</label><input id="text_colors" placeholder="white with black outline"></div>
        <div class="row"><label for="state_shape">Main Outline</label><input id="state_shape" placeholder="state of Florida"></div>
        <div class="row"><label for="outline_color">Outline Color</label><input id="outline_color" placeholder="white"></div>
      </div>
    </div>

    <div id="panel-symbols" class="tab-panel" role="tabpanel" aria-labelledby="tab-symbols" hidden>
      <div class="grid">
        <div class="row"><label for="main_symbol">Main Symbol</label><input id="main_symbol" placeholder="Death Star"></div>
        <div class="row"><label for="symbol_color">Symbol Color</label><input id="symbol_color" placeholder="red with etched lines"></div>
        <div class="row"><label for="badge_elements">Badge Elements</label><input id="badge_elements" placeholder="concentric rings"></div>
        <div class="row"><label for="secondary_symbol">Secondary Symbol</label><input id="secondary_symbol" placeholder="Army star (optional)"></div>
        <div class="row"><label for="aurebesh_style">Aurebesh Style</label><input id="aurebesh_style" placeholder="glowing Aurebesh along rim"></div>
        <div class="row"><label for="sabers_desc">Lightsabers</label><input id="sabers_desc" placeholder="two crossed sabers glow"></div>
      </div>
    </div>

    <div id="panel-advanced" class="tab-panel" role="tabpanel" aria-labelledby="tab-advanced" hidden>
      <div class="row"><label for="style_keywords">Style Keywords</label><input id="style_keywords" placeholder="cinematic, heraldic, symmetrical"></div>
      <div class="btns">
        <button id="gen" class="btn primary"><span class="material-icons">bolt</span>Generate</button>
        <button id="copyBtn" class="btn"><span class="material-icons">content_copy</span>Copy Text</button>
        <button id="downloadBtn" class="btn"><span class="material-icons">save</span>Download TXT</button>
        <button id="downloadSvgBtn" class="btn"><span class="material-icons">image</span>Export SVG</button>
        <button id="downloadPngBtn" class="btn"><span class="material-icons">photo</span>Export PNG</button>
      </div>
      <div class="subtle" style="margin-top:8px">Shortcuts: <span class="kbd">Ctrl/⌘ + Enter</span> generate • <span class="kbd">Ctrl/⌘ + C</span> copy</div>
    </div>
  </section>

  <!-- RIGHT: Output -->
  <section class="card">
    <h2><span class="material-icons" style="font-size:18px">visibility</span> Output</h2>
    <div class="out-wrap">
      <div class="row"><label for="out">Generated Prompt</label><textarea id="out" spellcheck="false"></textarea></div>
      <div class="preview">
        <svg id="svgPreview" viewBox="0 0 300 300" role="img" aria-label="Medallion preview"></svg>
        <div class="preview-controls">
          <button id="zoomOut" class="chip zoom-btn" type="button" aria-label="Zoom out"><span class="material-icons">remove</span></button>
          <span id="zoomLevel" class="subtle" aria-live="polite">100%</span>
          <button id="zoomIn" class="chip zoom-btn" type="button" aria-label="Zoom in"><span class="material-icons">add</span></button>
          <button id="rotateBtn" class="chip" type="button"><span class="material-icons">rotate_90_degrees_ccw</span>Rotate</button>
          <button id="toggleSpin" class="chip" type="button"><span class="material-icons">rotate_right</span>Auto-Rotate</button>
          <button id="resetView" class="chip" type="button"><span class="material-icons">restart_alt</span>Reset</button>
        </div>
      </div>
      <div class="row"><label>Text Preview</label><div id="preview" class="monobox"></div></div>
    </div>
  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"><span class="material-icons">check_circle</span><span id="toastMsg">Done</span></div>

<script>
/* ===== Utilities ===== */
const $ = id => document.getElementById(id);
const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
const on = (el, ev, fn, opt) => el.addEventListener(ev, fn, opt||{passive:true});
function toast(msg, isError=false){ const el=$('toast'); el.classList.toggle('error',!!isError); $('toastMsg').textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2200); }

/* ===== Theme ===== */
on($('themeToggle'),'click',()=>{const light=document.body.classList.toggle('light-theme'); $('themeToggle').setAttribute('aria-pressed', String(light)); $('themeToggle').querySelector('.material-icons').textContent=light?'light_mode':'dark_mode'; $('themeLabel').textContent=light?'Light':'Dark';});

/* ===== Tabs (ARIA) ===== */
const tabs=[...document.querySelectorAll('.tab')];
const panels={basic:$('panel-basic'),symbols:$('panel-symbols'),advanced:$('panel-advanced')};
function setTab(btn){const id=btn.dataset.tab; tabs.forEach(t=>{const a=t===btn; t.setAttribute('aria-selected',String(a)); t.tabIndex=a?0:-1;}); Object.entries(panels).forEach(([k,p])=>p.hidden=(k!==id)); btn.focus();}
tabs.forEach(t=>{on(t,'click',()=>setTab(t)); on(t,'keydown',e=>{const i=tabs.indexOf(t); if(e.key==='ArrowRight')setTab(tabs[(i+1)%tabs.length]); if(e.key==='ArrowLeft')setTab(tabs[(i-1+tabs.length)%tabs.length]); if(e.key==='Home')setTab(tabs[0]); if(e.key==='End')setTab(tabs[tabs.length-1]);});});
setTab(tabs[0]);

/* ===== Presets ===== */
const presets={
  fl_army:{text_top:"SAINT CLOUD JEDI",rim_finish:"metallic silver",plate_color:"black",text_colors:"white with black outline",state_shape:"state of Florida",outline_color:"white",main_symbol:"Death Star",symbol_color:"red with etched lines",badge_elements:"concentric rings",secondary_symbol:"Army star emblem",aurebesh_style:"glowing Aurebesh along rim",sabers_desc:"two crossed sabers glow",style_keywords:"cinematic, heraldic, symmetrical"},
  det_wings:{text_top:"DETROIT JEDI",rim_finish:"polished steel",plate_color:"black",text_colors:"white",state_shape:"medallion field",outline_color:"red/black",main_symbol:"Death Star",symbol_color:"red etched",badge_elements:"concentric rings",secondary_symbol:"",aurebesh_style:"glowing inscriptions",sabers_desc:"three angled beams glow",style_keywords:"sports fusion, symmetrical"},
  jedi_generic:{text_top:"GALACTIC JEDI ORDER",rim_finish:"brushed silver",plate_color:"navy",text_colors:"silver outline",state_shape:"medallion field",outline_color:"white",main_symbol:"Jedi crest",symbol_color:"silver",badge_elements:"imperial ticks",secondary_symbol:"",aurebesh_style:"cyan glow runes",sabers_desc:"single vertical saber glow",style_keywords:"heraldic, luminous"}
};
document.querySelectorAll('.profile').forEach(card=>on(card,'click',()=>{const p=presets[card.dataset.profile]; if(p){fillForm(p); toast('Profile loaded');}}));

/* ===== Form IO ===== */
function readForm(){
  const g=id=>(($(id)||{}).value||'').trim();
  return {
    text_top: g('text_top')||"SAINT CLOUD JEDI",
    rim_finish: g('rim_finish')||"metallic silver",
    plate_color: g('plate_color')||"black",
    text_colors: g('text_colors')||"white with black outline",
    state_shape: g('state_shape')||"state of Florida",
    outline_color: g('outline_color')||"white",
    main_symbol: g('main_symbol')||"Death Star",
    symbol_color: g('symbol_color')||"red with etched lines",
    badge_elements: g('badge_elements')||"concentric rings",
    secondary_symbol: g('secondary_symbol')||"",
    aurebesh_style: g('aurebesh_style')||"glowing Aurebesh along rim",
    sabers_desc: g('sabers_desc')||"two crossed sabers glow",
    style_keywords: g('style_keywords')||"cinematic, heraldic, symmetrical"
  };
}
function buildPrompt(v){
  return [
    "Cinematic-style medallion pendant design.",
    "• Shape & Base: Round pendant, "+v.rim_finish+", plate in "+v.plate_color+".",
    "• Text: Raised lettering “"+v.text_top+"” in "+v.text_colors+".",
    "• Central Motif: "+v.state_shape+" in "+v.outline_color+" with "+v.main_symbol+" ("+v.symbol_color+"). Elements: "+v.badge_elements+(v.secondary_symbol?(". Secondary: "+v.secondary_symbol):"")+".",
    "• Aurebesh: "+v.aurebesh_style+".",
    "• Lightsabers: "+v.sabers_desc+".",
    "• Style: "+v.style_keywords+"."
  ].join("\n");
}

/* ===== SVG Preview ===== */
let zoom=1, rotation=0, spinning=false;
function colorPick(key, table, fallback){ key=(key||'').toLowerCase(); for(const [k,v] of table){ if(k && key.includes(k)) return v; } return fallback; }

function updateSvg(v){
  const svg=$('svgPreview'); svg.innerHTML='';
  const NS='http://www.w3.org/2000/svg';

  const plateFill=colorPick(v.plate_color,[['black','#121316'],['navy','#0b2346'],['crimson','#5c0b12'],['gray','#2a2f3a'],['white','#f3f6f9']], '#121316');
  const rimColor =colorPick(v.rim_finish ,[['gold','#FFD54A'],['silver','#C0C7CE'],['steel','#B0B7C3'],['bronze','#C18B52'],['obsidian','#000']], '#66d7ff');
  const textFill=colorPick(v.text_colors,[['white','#fff'],['gold','#FFD54A'],['silver','#C0C7CE'],['cyan','#6ee7ff'],['red','#e43b44'],['black','#000']], '#fff');
  const symColor =colorPick(v.symbol_color,[['red','#e43b44'],['silver','#C0C7CE'],['gold','#FFD54A'],['white','#fff'],['blue','#3b6ee4'],['cyan','#6ee7ff']], '#6ee7ff');

  const defs=document.createElementNS(NS,'defs'); svg.appendChild(defs);

  // Create filters for glow effects
  const glow=document.createElementNS(NS,'filter'); glow.id='glow';
  glow.innerHTML='<feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>'; defs.appendChild(glow);
  
  const strongGlow=document.createElementNS(NS,'filter'); strongGlow.id='strongGlow';
  strongGlow.innerHTML='<feGaussianBlur stdDeviation="5" result="blur"/><feComposite in="SourceGraphic" in2="blur" operator="over"/>'; defs.appendChild(strongGlow);

  // Create gradients
  const saberGrad=document.createElementNS(NS,'linearGradient'); saberGrad.id='saber';
  saberGrad.setAttribute('x1','0%');saberGrad.setAttribute('y1','0%');saberGrad.setAttribute('x2','100%');saberGrad.setAttribute('y2','0%');
  saberGrad.innerHTML='<stop offset="0%" stop-color="#fff"/><stop offset="50%" stop-color="#bff3ff"/><stop offset="100%" stop-color="#6ee7ff"/>'; defs.appendChild(saberGrad);

  const rimGrad=document.createElementNS(NS,'linearGradient'); rimGrad.id='rimGrad';
  rimGrad.setAttribute('x1','0%');rimGrad.setAttribute('y1','0%');rimGrad.setAttribute('x2','100%');rimGrad.setAttribute('y2','100%');
  rimGrad.innerHTML=`<stop offset="0%" stop-color="${rimColor}"/><stop offset="100%" stop-color="${rimColor}" stop-opacity=".8"/>`; defs.appendChild(rimGrad);

  // Arc path for text
  const arc=document.createElementNS(NS,'path'); arc.id='topArc';
  arc.setAttribute('d','M 40 120 A 110 110 0 0 1 260 120'); defs.appendChild(arc);

  // Plate & depth rings
  const plate=document.createElementNS(NS,'circle');
  plate.setAttribute('cx','150'); plate.setAttribute('cy','150'); plate.setAttribute('r','120');
  plate.setAttribute('fill',plateFill); plate.setAttribute('stroke',rimColor); plate.setAttribute('stroke-width','6'); svg.appendChild(plate);

  const rimOuter=document.createElementNS(NS,'circle');
  rimOuter.setAttribute('cx','150'); rimOuter.setAttribute('cy','150'); rimOuter.setAttribute('r','136');
  rimOuter.setAttribute('fill','none'); rimOuter.setAttribute('stroke','url(#rimGrad)'); rimOuter.setAttribute('stroke-width','3'); rimOuter.setAttribute('opacity','.9'); svg.appendChild(rimOuter);

  const rimInner=document.createElementNS(NS,'circle');
  rimInner.setAttribute('cx','150'); rimInner.setAttribute('cy','150'); rimInner.setAttribute('r','132');
  rimInner.setAttribute('fill','none'); rimInner.setAttribute('stroke','#ffffff'); rimInner.setAttribute('stroke-opacity','.08'); rimInner.setAttribute('stroke-width','2'); svg.appendChild(rimInner);

  // Badge rings
  if ((v.badge_elements||'').toLowerCase().includes('ring')){
    [90,70,50].forEach((r,i)=>{const c=document.createElementNS(NS,'circle'); c.setAttribute('cx','150'); c.setAttribute('cy','150'); c.setAttribute('r',r); c.setAttribute('fill','none'); c.setAttribute('stroke',rimColor); c.setAttribute('stroke-width','1'); if(i===1)c.setAttribute('stroke-dasharray','6,6'); svg.appendChild(c);});
  }

  // Main symbol
  const g=document.createElementNS(NS,'g'); svg.appendChild(g);
  const ms=(v.main_symbol||'').toLowerCase();
  if (ms.includes('death')){
    // Death Star
    const body=document.createElementNS(NS,'circle'); body.setAttribute('cx','150'); body.setAttribute('cy','150'); body.setAttribute('r','58'); body.setAttribute('fill',symColor); body.setAttribute('stroke','#222'); body.setAttribute('stroke-width','1.4'); g.appendChild(body);
    const trench=document.createElementNS(NS,'rect'); trench.setAttribute('x','95'); trench.setAttribute('y','147'); trench.setAttribute('width','110'); trench.setAttribute('height','6'); trench.setAttribute('fill','#1c1f29'); trench.setAttribute('opacity','.75'); g.appendChild(trench);
    const dish=document.createElementNS(NS,'circle'); dish.setAttribute('cx','178'); dish.setAttribute('cy','130'); dish.setAttribute('r','12'); dish.setAttribute('fill', plateFill==='#121316' ? '#0a0a0a' : '#111'); dish.setAttribute('stroke','#444'); g.appendChild(dish);
    for(let i=0;i<8;i++){const a=i*22.5*Math.PI/180, r1=35, r2=58; const x1=150+r1*Math.cos(a), y1=150+r1*Math.sin(a); const x2=150+r2*Math.cos(a), y2=150+r2*Math.sin(a); const ln=document.createElementNS(NS,'line'); ln.setAttribute('x1',x1); ln.setAttribute('y1',y1); ln.setAttribute('x2',x2); ln.setAttribute('y2',y2); ln.setAttribute('stroke','#2a2f3a'); ln.setAttribute('stroke-width','1'); g.appendChild(ln);}
  } else if (ms.includes('jedi')){
    // Jedi Crest
    const crest=document.createElementNS(NS,'path'); crest.setAttribute('d','M150 110 L168 96 L168 140 L182 154 L168 168 L168 210 L150 194 L132 210 L132 168 L118 154 L132 140 L132 96 Z'); crest.setAttribute('fill',symColor); g.appendChild(crest);
  } else if (ms.includes('imperial')||ms.includes('cog')){
    // Imperial Cog
    const cog=document.createElementNS(NS,'circle'); cog.setAttribute('cx','150'); cog.setAttribute('cy','150'); cog.setAttribute('r','46'); cog.setAttribute('fill',symColor); cog.setAttribute('stroke','#222'); cog.setAttribute('stroke-width','1.2'); g.appendChild(cog);
    // Add cog teeth
    for(let i=0;i<8;i++){const a=i*45*Math.PI/180, r1=46, r2=58; const x1=150+r1*Math.cos(a), y1=150+r1*Math.sin(a); const x2=150+r2*Math.cos(a), y2=150+r2*Math.sin(a); const ln=document.createElementNS(NS,'line'); ln.setAttribute('x1',x1); ln.setAttribute('y1',y1); ln.setAttribute('x2',x2); ln.setAttribute('y2',y2); ln.setAttribute('stroke',symColor); ln.setAttribute('stroke-width','6'); g.appendChild(ln);}
  } else {
    // Default star
    const star=document.createElementNS(NS,'path'); star.setAttribute('d','M150,102 L164,136 L201,139 L172,162 L180,197 L150,179 L120,197 L128,162 L99,139 L136,136 Z'); star.setAttribute('fill',symColor); g.appendChild(star);
  }

  // Secondary emblem
  if ((v.secondary_symbol||'').trim()){
    const sec=document.createElementNS(NS,'circle'); sec.setAttribute('cx','210'); sec.setAttribute('cy','105'); sec.setAttribute('r','9'); sec.setAttribute('fill',symColor); sec.setAttribute('filter','url(#glow)'); svg.appendChild(sec);
  }

  // Sabers (OLED-friendly bloom)
  const saber=(x1,y1,x2,y2)=>{
    const b=document.createElementNS(NS,'line'); 
    b.setAttribute('x1',x1); b.setAttribute('y1',y1); b.setAttribute('x2',x2); b.setAttribute('y2',y2); 
    b.setAttribute('stroke','#6ee7ff'); b.setAttribute('stroke-width','8'); b.setAttribute('opacity','.35'); 
    b.setAttribute('filter','url(#glow)'); svg.appendChild(b); 
    
    const core=document.createElementNS(NS,'line'); 
    core.setAttribute('x1',x1); core.setAttribute('y1',y1); core.setAttribute('x2',x2); core.setAttribute('y2',y2); 
    core.setAttribute('stroke','url(#saber)'); core.setAttribute('stroke-width','3'); 
    svg.appendChild(core);
  };
  
  const s=(v.sabers_desc||'').toLowerCase();
  if (s.includes('cross')||/\bx\b/.test(s)){
    saber(105,105,195,195); 
    saber(195,105,105,195);
  }
  else if (s.includes('three')||/\b3\b/.test(s)){
    saber(95,210,205,210); 
    saber(115,225,185,165); 
    saber(185,225,115,165);
  }
  else if (s.includes('circle')){
    for(let i=0;i<6;i++){
      const a=i*60*Math.PI/180; 
      saber(150+40*Math.cos(a),150+40*Math.sin(a),150+80*Math.cos(a),150+80*Math.sin(a));
    }
  }
  else {
    saber(150,120,150,225);
  }

  // Aurebesh ring + vector dots
  const aure=(v.aurebesh_style||'').toLowerCase();
  if (aure.includes('glow')||aure.includes('aurebesh')||aure.includes('rune')||aure.includes('inscription')){
    const ring=document.createElementNS(NS,'circle'); 
    ring.setAttribute('cx','150'); ring.setAttribute('cy','150'); ring.setAttribute('r','108'); 
    ring.setAttribute('fill','none'); ring.setAttribute('stroke','#6ee7ff'); ring.setAttribute('stroke-width','1'); 
    ring.setAttribute('stroke-dasharray','6,6'); ring.setAttribute('opacity','.7'); 
    ring.setAttribute('filter','url(#glow)'); svg.appendChild(ring);
    
    for(let i=0;i<16;i++){
      const a=i*22.5*Math.PI/180, x=150+96*Math.cos(a), y=150+96*Math.sin(a), r=2.2; 
      const dot=document.createElementNS(NS,'path'); 
      dot.setAttribute('d',`M ${x-r} ${y} a ${r} ${r} 0 1 0 ${r*2} 0 a ${r} ${r} 0 1 0 ${-r*2} 0`);
      dot.setAttribute('fill','#6ee7ff'); dot.setAttribute('opacity','.9'); 
      dot.setAttribute('filter','url(#glow)'); svg.appendChild(dot);
    }
  }

  // Top arc text
  if ((v.text_top||'').trim()){
    const wantsOutline=(v.text_colors||'').toLowerCase().includes('outline') || plateFill==='#121316';
    const txt=document.createElementNS(NS,'text'); 
    txt.setAttribute('font-size','15'); txt.setAttribute('font-weight','800'); 
    txt.setAttribute('fill',textFill); txt.setAttribute('letter-spacing','.6'); 
    txt.setAttribute('text-anchor','middle'); 
    if(wantsOutline){ 
      txt.setAttribute('stroke','#000'); txt.setAttribute('stroke-width','1.1'); 
      txt.setAttribute('paint-order','stroke'); 
    }
    
    const tp=document.createElementNS(NS,'textPath'); 
    tp.setAttribute('href','#topArc'); tp.setAttribute('startOffset','50%'); 
    const raw=v.text_top.length>26?v.text_top.slice(0,25)+'…':v.text_top; 
    tp.textContent=raw.toUpperCase(); 
    txt.appendChild(tp); 
    svg.appendChild(txt);
  }
}

/* ===== Controls / Generate ===== */
function generate(){ const v=readForm(); $('out').value=buildPrompt(v); $('preview').textContent=$('out').value; updateSvg(v); }
['input','change'].forEach(ev=>{ document.querySelectorAll('input,select,textarea').forEach(el=>el.addEventListener(ev, generate, {passive:true})); });
on($('gen'),'click',generate);

/* Save / Load / Randomize */
on($('saveBtn'),'click',()=>{localStorage.setItem('medallionPreset', JSON.stringify(readForm())); toast('Preset saved');});
on($('loadBtn'),'click',()=>{const data=localStorage.getItem('medallionPreset'); if(!data) return toast('No saved preset',true); try{fillForm(JSON.parse(data)); toast('Preset loaded');}catch{toast('Load failed',true)};});
on($('randBtn'),'click',()=>{const s=a=>a[Math.floor(Math.random()*a.length)]; fillForm({
  text_top:s(["STELLAR JEDI","IMPERIAL ORDER","REBEL ALLIANCE","SITH EMPIRE","CORELLIAN KNIGHTS"]),
  rim_finish:s(["metallic silver","polished gold","brushed steel","obsidian black","antique bronze"]),
  plate_color:s(["black","navy","crimson","deep gray","forest green","white"]),
  text_colors:s(["white with black outline","gold fill","glowing cyan","silver embossed","red on black"]),
  state_shape:s(["medallion field","state of Florida","planet outline","Imperial cog","Rebel crest"]),
  outline_color:s(["white","silver","gold trim","red glow","blue neon"]),
  main_symbol:s(["Death Star","Jedi crest","Imperial cog","Lightsaber","Millennium Falcon"]),
  symbol_color:s(["red with etched lines","etched silver","glowing white","gold leaf","blue crystal"]),
  badge_elements:s(["concentric rings","spokes","binary stars","orbital lines","insignia ticks"]),
  secondary_symbol:s(["Army star emblem","","Jedi logo","droid outline","TIE silhouette"]),
  aurebesh_style:s(["glowing Aurebesh along rim","cyan inscriptions","luminous white runes","golden lettering","etched symbols"]),
  sabers_desc:s(["two crossed sabers glow","three angled beams glow","four sabers in X","single vertical saber glow","circle of sabers glow"]),
  style_keywords:s(["cinematic","formal","balanced symmetry","ancient relic","futuristic tech"])
}); toast('Randomized');});

/* Copy / Export (TXT, SVG, PNG) */
on($('copyBtn'),'click',()=>navigator.clipboard?.writeText($('out').value||'').then(()=>toast('Copied')));
on($('downloadBtn'),'click',()=>{const blob=new Blob([$('out').value||''],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='medallion_prompt.txt'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500); toast('TXT downloaded');});
on($('downloadSvgBtn'),'click',()=>{const svg=$('svgPreview'); if(!svg||!svg.outerHTML) return toast('Nothing to export',true); const xml=`<?xml version="1.0" encoding="UTF-8"?>\n`+svg.outerHTML; const blob=new Blob([xml],{type:'image/svg+xml'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='medallion_preview.svg'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500); toast('SVG downloaded');});
on($('downloadPngBtn'),'click',()=>{const svg=$('svgPreview'); if(!svg) return;
  // clone & bake rotation into export; zoom is a UI thing, export at full res
  const rot = rotation%360;
  const clone = svg.cloneNode(true);
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  while(clone.firstChild){ g.appendChild(clone.firstChild); }
  if(rot){ g.setAttribute('transform',`rotate(${rot} 150 150)`); }
  clone.appendChild(g);
  const xml=`<?xml version="1.0" encoding="UTF-8"?>\n`+clone.outerHTML;

  const scale=2; // retina crisp
  const box=svg.viewBox.baseVal||{width:300,height:300};
  const canvas=document.createElement('canvas'); canvas.width=box.width*scale; canvas.height=box.height*scale;
  const ctx=canvas.getContext('2d');
  const url=URL.createObjectURL(new Blob([xml],{type:'image/svg+xml'}));
  const img=new Image(); img.onload=()=>{ ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0); URL.revokeObjectURL(url);
    canvas.toBlob(b=>{ if(!b){toast('PNG failed',true);return;}
      const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='medallion_preview.png';
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
      toast('PNG downloaded');
    },'image/png');
  };
  img.crossOrigin='anonymous'; img.src=url;
});

/* View controls */
function applyView(){ $('svgPreview').style.transform=`scale(${zoom}) rotate(${rotation}deg)`; $('zoomLevel').textContent=`${Math.round(zoom*100)}%`; }
on($('zoomIn'),'click',()=>{zoom=clamp(Math.round((zoom+0.1)*10)/10,0.6,1.8); applyView();});
on($('zoomOut'),'click',()=>{zoom=clamp(Math.round((zoom-0.1)*10)/10,0.6,1.8); applyView();});
on($('rotateBtn'),'click',()=>{rotation=(rotation+45)%360; applyView();});
on($('toggleSpin'),'click',e=>{spinning=!spinning; $('svgPreview').classList.toggle('spinning',spinning); e.currentTarget.querySelector('.material-icons').textContent=spinning?'pause':'rotate_right';});
on($('resetView'),'click',()=>{zoom=1; rotation=0; spinning=false; $('svgPreview').classList.remove('spinning'); applyView();});

/* Shortcuts */
addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); generate(); }
  if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='c' && document.activeElement.id==='out'){ e.preventDefault(); navigator.clipboard?.writeText($('out').value||'').then(()=>toast('Copied')); }
},{passive:true});

/* Helpers */
function fillForm(data){ for(const [k,v] of Object.entries(data)){ const el=$(k); if(el) el.value=v; } generate(); }

/* Boot */
(function boot(){ fillForm(presets.fl_army); })();
</script>
</body>
</html>
